<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Studio professionnel de cr√©ation et gestion de prompts LLM avec interface avanc√©e" />
  <title>üöÄ LLM Prompt Studio Pro ‚Äî Advanced Edition</title>

  <!-- Google Fonts : Inter + Fira Code -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet"/>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  
  <!-- Icons (Lucide) and CodeMirror -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/markdown/markdown.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/mode/simple.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/diff_match_patch/20121119/diff_match_patch.js"></script>
  
  <style>
    /* ========== Variables & Th√®me ========== */
    :root {
      --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --bg-light: #f8fafc;
      --bg-dark: #0f172a;
      --surface: #ffffff;
      --surface-dark: #1e293b;
      --surface-hover: #f1f5f9;
      --surface-hover-dark: #334155;

      --primary: #6366f1;
      --primary-light: #818cf8;
      --primary-dark: #4f46e5;
      --primary-gradient: linear-gradient(135deg, #667eea, #764ba2);

      --accent: #10b981;
      --accent-light: #34d399;
      --accent-gradient: linear-gradient(135deg, #10b981, #059669);

      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info: #3b82f6;

      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --text-primary-dark: #f1f5f9;
      --text-secondary-dark: #cbd5e1;

      --border: #e2e8f0;
      --border-dark: #334155;
      --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.05);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
      --shadow-2xl: 0 25px 50px -12px rgba(0,0,0,0.25);
      --shadow-glow: 0 0 30px rgba(99,102,241,0.3);

      --radius-sm: 0.375rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;
      --radius-2xl: 1.5rem;

      --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      --font-mono: 'Fira Code', ui-monospace, monospace;

      --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
      --animation-bounce: cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    [data-theme="dark"] {
      --bg-light: var(--bg-dark);
      --surface: var(--surface-dark);
      --surface-hover: var(--surface-hover-dark);
      --text-primary: var(--text-primary-dark);
      --text-secondary: var(--text-secondary-dark);
      --border: var(--border-dark);
      --shadow-glow: 0 0 40px rgba(139,92,246,0.4);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { scroll-behavior: smooth; height: 100%; }
    body {
      font-family: var(--font-sans);
      background: var(--bg-light);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
      position: relative;
      transition: all var(--transition-base);
    }

    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: var(--bg-gradient);
      opacity: 0.04;
      z-index: -1;
      backdrop-filter: blur(2px) saturate(120%);
    }
    /* Suppression de l'animation de fond rotative conform√©ment √† la demande */

    .app-container { display: grid; grid-template-rows: auto 1fr auto; min-height: 100vh; position: relative; }

    .header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(10px);
      position: sticky; top: 0; z-index: 100;
      box-shadow: var(--shadow-sm);
      animation: slideDown 0.5s ease-out;
    }
    @keyframes slideDown {
      from { transform: translateY(-100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .header-content { max-width: 1400px; margin: 0 auto; padding: 1rem 1.5rem; display: flex; align-items: center; justify-content: space-between; gap: 2rem; }
    .logo-section { display: flex; align-items: center; gap: 1rem; }
    .logo {
      width: 48px; height: 48px; background: var(--primary-gradient); border-radius: var(--radius-lg);
      display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; font-size: 1.25rem;
      box-shadow: var(--shadow-lg); animation: logoPulse 2s ease-in-out infinite;
    }
    @keyframes logoPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    .logo-text { display: flex; flex-direction: column; }
    .logo-title { font-size: 1.25rem; font-weight: 800; background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .logo-subtitle { font-size: 0.75rem; color: var(--text-secondary); font-weight: 500; }

    .nav-actions { display: flex; align-items: center; gap: 0.5rem; }
    .status-badge {
      display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem;
      background: linear-gradient(135deg, #10b981, #059669); color: white; border-radius: var(--radius-2xl);
      font-size: 0.875rem; font-weight: 500; box-shadow: var(--shadow-md); animation: fadeIn 1s ease-out;
      margin-left: 0.5rem;
    }
    .status-dot { width: 8px; height: 8px; background: white; border-radius: 50%; animation: blink 2s ease-in-out infinite; }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

    .btn {
      padding: 0.625rem 1.0rem; border: none; border-radius: var(--radius-md);
      font-weight: 600; font-size: 0.875rem; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem;
      transition: all var(--transition-fast); position: relative; overflow: hidden;
    }
    .btn::before {
      content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0; border-radius: 50%;
      background: rgba(255,255,255,0.3); transform: translate(-50%, -50%); transition: width 0.6s, height 0.6s;
    }
    .btn:hover::before { width: 300px; height: 300px; }
    .btn-primary { background: var(--primary-gradient); color: white; box-shadow: var(--shadow-md); }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
    .btn-secondary { background: var(--surface); color: var(--text-primary); border: 2px solid var(--border); }
    .btn-secondary:hover { background: var(--surface-hover); border-color: var(--primary); color: var(--primary); }
    .btn-accent { background: var(--accent-gradient); color: white; box-shadow: var(--shadow-md); }
    .btn-danger { background: var(--danger); color: #fff; }
    .btn-icon { width: 40px; height: 40px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: var(--radius-lg); }

    .main-content {
      max-width: 1400px; margin: 1.25rem auto 2rem; padding: 0 1.5rem; display: grid;
      grid-template-columns: 320px 1fr 380px; gap: 1.25rem; animation: fadeInUp 0.6s ease-out;
    }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @media (max-width: 1200px) { .main-content { grid-template-columns: 280px 1fr; } .sidebar-right { display: none; } }
    @media (max-width: 768px) { .main-content { grid-template-columns: 1fr; } .sidebar-left { display: none; } }

    .panel {
      background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-xl); padding: 1.25rem;
      box-shadow: var(--shadow-md); transition: all var(--transition-base); position: relative; overflow: hidden;
    }
    .panel::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: var(--primary-gradient);
      transform: scaleX(0); transition: transform var(--transition-base);
    }
    .panel:hover::before { transform: scaleX(1); }
    .panel:hover { box-shadow: var(--shadow-xl); transform: translateY(-2px); }
    .panel-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border); }
    .panel-title { display: flex; align-items: center; gap: 0.75rem; font-size: 1.075rem; font-weight: 700; color: var(--text-primary); }
    .panel-title i { color: var(--primary); font-size: 1.15rem; }

    .form-group { margin-bottom: 1rem; }
    .form-label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.875rem; color: var(--text-secondary); }
    .form-label .required { color: var(--danger); margin-left: 0.25rem; }
    .form-input, .form-textarea, .form-select {
      width: 100%; padding: 0.75rem 1rem; border: 2px solid var(--border); border-radius: var(--radius-md);
      background: var(--surface); color: var(--text-primary); font-size: 0.875rem; transition: all var(--transition-fast); font-family: inherit;
    }
    .form-textarea { min-height: 120px; resize: vertical; font-family: var(--font-mono); }
    .form-input:focus, .form-textarea:focus, .form-select:focus {
      outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99,102,241,0.1); transform: translateY(-1px);
    }
    .form-input:hover, .form-textarea:hover, .form-select:hover { border-color: var(--primary-light); }
    .input-group { position: relative; }
    .input-group-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-muted); pointer-events: none; }
    .input-group .form-input { padding-left: 2.75rem; }

    .prompt-library { height: calc(100vh - 120px); overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--primary) var(--border); }
    .prompt-library::-webkit-scrollbar { width: 6px; }
    .prompt-library::-webkit-scrollbar-track { background: var(--border); border-radius: var(--radius-sm); }
    .prompt-library::-webkit-scrollbar-thumb { background: var(--primary); border-radius: var(--radius-sm); }

    .search-box { margin-bottom: 0.75rem; }
    .filter-tags { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.75rem; }
    .tag-chip {
      padding: 0.25rem 0.75rem; background: var(--surface-hover); border: 1px solid var(--border);
      border-radius: var(--radius-2xl); font-size: 0.75rem; cursor: pointer; transition: all var(--transition-fast);
    }
    .tag-chip:hover, .tag-chip.active { background: var(--primary); color: white; border-color: var(--primary); transform: scale(1.05); }

    /* List vs grid toggle for library */
    .library-toolbar { display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; margin-bottom: 0.25rem; }
    .view-toggle { display:flex; gap:0.25rem; }
    .view-toggle .toggle { width: 34px; height: 34px; border:1px solid var(--border); background: var(--surface); border-radius: 8px; display:flex; align-items:center; justify-content:center; cursor:pointer; }
    .view-toggle .toggle.active { border-color: var(--primary); color: var(--primary); background: var(--surface-hover); }

    .prompt-list { list-style: none; }
    .prompt-item {
      padding: 0.875rem; margin-bottom: 0.6rem; background: var(--surface);
      border: 2px solid var(--border); border-radius: var(--radius-lg); cursor: pointer; transition: all var(--transition-fast); position: relative; overflow: hidden;
    }
    .prompt-item::before {
      content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px; background: var(--primary-gradient);
      transform: scaleY(0); transition: transform var(--transition-base);
    }
    .prompt-item:hover::before, .prompt-item.active::before { transform: scaleY(1); }
    .prompt-item:hover { background: var(--surface-hover); border-color: var(--primary); transform: translateX(4px); box-shadow: var(--shadow-md); }
    .prompt-item.active { background: linear-gradient(to right, rgba(99,102,241,0.05), transparent); border-color: var(--primary); }
    .prompt-item-title { font-weight: 600; margin-bottom: 0.25rem; color: var(--text-primary); }
    .prompt-item-preview { font-size: 0.75rem; color: var(--text-muted); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .prompt-item-meta { display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap; }
    .prompt-item-tag { padding: 0.125rem 0.5rem; background: var(--primary); color: white; border-radius: var(--radius-sm); font-size: 0.625rem; font-weight: 500; }
    .prompt-item-tag.tag-code { background-color: #f59e0b; }
    .prompt-item-tag.tag-creative { background-color: #ec4899; }
    .prompt-item-tag.tag-business { background-color: #3b82f6; }
    .prompt-item-tag.tag-marketing { background-color: #10b981; }
    .prompt-item-tag.tag-legal { background-color: #64748b; }
    .prompt-item-tag.tag-hr { background-color: #8b5cf6; }

    .prompt-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(220px,1fr)); gap: 0.75rem; }
    .prompt-card { border:2px solid var(--border); border-radius: 12px; padding: 0.75rem; cursor:pointer; transition: all var(--transition-fast); background: var(--surface); }
    .prompt-card:hover { transform: translateY(-3px); border-color: var(--primary); box-shadow: var(--shadow-md); }

    .editor-panel { display: flex; flex-direction: column; gap: 1rem; }

    /* Editor tabs: Editeur / Chat */
    .editor-modes { display:flex; gap:0.5rem; border-bottom:1px solid var(--border); margin-bottom:0.75rem; }
    .editor-mode { padding:0.5rem 0.75rem; border:none; background:transparent; cursor:pointer; border-bottom:3px solid transparent; color:var(--text-secondary); font-weight:600; }
    .editor-mode.active { color:var(--primary); border-bottom-color:var(--primary); }

    .editor-toolbar {
      display: flex; flex-wrap: wrap; gap: 0.5rem; padding: 0.75rem; background: var(--surface-hover);
      border-radius: var(--radius-lg); margin-bottom: 0.75rem;
    }
    .toolbar-group { display: flex; gap: 0.5rem; align-items: center; padding: 0 0.5rem; border-right: 1px solid var(--border); }
    .toolbar-group:last-child { border-right: none; }
    .toolbar-btn {
      min-width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
      background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-md);
      color: var(--text-secondary); cursor: pointer; transition: all var(--transition-fast); padding: 0 0.5rem;
    }
    .toolbar-btn:hover { background: var(--primary); color: white; border-color: var(--primary); transform: scale(1.08); }
    .toolbar-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

    .variables-section {
      padding: 0.75rem; background: linear-gradient(135deg, rgba(99,102,241,0.05), rgba(139,92,246,0.05));
      border-radius: var(--radius-lg); border: 1px solid var(--primary); margin-bottom: 0.75rem;
    }
    .variable-chip {
      display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.45rem 0.85rem; background: var(--surface);
      border: 2px solid var(--primary); border-radius: var(--radius-2xl); margin: 0.25rem; cursor: pointer; transition: all var(--transition-fast);
      font-size: 0.85rem;
    }
    .variable-chip:hover { background: var(--primary); color: white; transform: scale(1.05); }
    #add-variable-btn { cursor: pointer; }
    .variable-chip i { font-size: 0.875rem; }

    .preview-section {
      background: linear-gradient(135deg, #1e293b, #334155); color: #f1f5f9; padding: 1rem; border-radius: var(--radius-lg);
      min-height: 200px; font-family: var(--font-mono); font-size: 0.875rem; line-height: 1.5; box-shadow: var(--shadow-xl);
      position: relative; overflow: hidden; white-space: pre-wrap;
    }
    .preview-header {
      display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem; padding-bottom: 0.5rem;
      border-bottom: 1px solid rgba(241,245,249,0.1);
    }
    .preview-title { font-weight: 600; color: var(--primary-light); display:flex; gap:0.5rem; align-items:center; }
    .preview-actions { display:flex; gap: 0.5rem; align-items:center; }
    .copy-btn, .streaming-btn, .optimize-btn {
      padding: 0.4rem 0.75rem; background: rgba(99,102,241,0.18); border: 1px solid var(--primary); border-radius: var(--radius-md);
      color: var(--primary-light); cursor: pointer; transition: all var(--transition-fast); font-weight:600;
    }
    .copy-btn:hover, .streaming-btn:hover, .optimize-btn:hover { background: var(--primary); color: white; transform: scale(1.04); }

    .var-miss { color: #fca5a5; background: rgba(239,68,68,0.15); border-radius:6px; padding: 0 4px; cursor: pointer; }
    .var-fill { color: #bbf7d0; background: rgba(16,185,129,0.15); border-radius:6px; padding: 0 4px; }

    .settings-panel { display: flex; flex-direction: column; gap: 1rem; }
    .settings-group { padding: 0.75rem; background: var(--surface-hover); border-radius: var(--radius-lg); }
    .settings-group-title { font-weight: 600; margin-bottom: 0.75rem; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem; }

    .range-slider { margin: 0.75rem 0; }
    .range-slider-header { display: flex; justify-content: space-between; margin-bottom: 0.4rem; }
    .range-slider-label { font-size: 0.875rem; font-weight: 500; color: var(--text-secondary); }
    .range-slider-value { font-weight: 700; color: var(--primary); }
    .range-input {
      width: 100%; height: 6px; background: var(--border); border-radius: 999px; outline: none; -webkit-appearance: none; appearance: none; cursor: pointer;
    }
    .range-input::-webkit-slider-thumb {
      -webkit-appearance: none; appearance: none; width: 18px; height: 18px; background: var(--primary-gradient); border-radius: 50%;
      cursor: pointer; box-shadow: var(--shadow-md); transition: all var(--transition-fast);
    }
    .range-input::-webkit-slider-thumb:hover { transform: scale(1.2); box-shadow: var(--shadow-lg); }
    .range-input::-moz-range-thumb {
      width: 18px; height: 18px; background: var(--primary-gradient); border-radius: 50%; cursor: pointer; box-shadow: var(--shadow-md); transition: all var(--transition-fast);
    }

    .toggle-switch { display: flex; align-items: center; justify-content: space-between; padding: 0.5rem 0; }
    .toggle-label { font-size: 0.875rem; font-weight: 500; color: var(--text-secondary); }
    .toggle-input { position: relative; width: 48px; height: 24px; background: var(--border); border-radius: 999px; cursor: pointer; transition: all var(--transition-fast); }
    .toggle-input input { display: none; }
    .toggle-slider { position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background: white; border-radius: 50%; transition: all var(--transition-fast); box-shadow: var(--shadow-sm); }
    .toggle-input input:checked ~ .toggle-slider { transform: translateX(24px); }

    .modal {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
      display: none; align-items: center; justify-content: center; z-index: 1000; animation: fadeIn var(--transition-base);
    }
    .modal.active { display: flex; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .modal-content {
      background: var(--surface); border-radius: var(--radius-xl); max-width: 800px; width: 94%; max-height: 85vh; overflow-y: auto;
      box-shadow: var(--shadow-2xl); animation: slideUp var(--transition-base);
    }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .modal-header { padding: 1rem 1.25rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .modal-title { font-size: 1.1rem; font-weight: 700; color: var(--text-primary); display:flex; gap:0.5rem; align-items:center; }
    .modal-close {
      width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: var(--surface-hover);
      border: none; border-radius: var(--radius-md); cursor: pointer; transition: all var(--transition-fast);
    }
    .modal-close:hover { background: var(--danger); color: white; transform: rotate(90deg); }
    .modal-body { padding: 1rem 1.25rem; }
    .modal-footer { padding: 0.75rem 1.25rem 1.25rem; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 0.5rem; flex-wrap: wrap; }

    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; }
    .toast {
      min-width: 300px; padding: 0.85rem 1rem; background: var(--surface); border-radius: var(--radius-lg); box-shadow: var(--shadow-xl);
      margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.75rem; animation: slideInRight var(--transition-base); border-left: 4px solid var(--primary);
    }
    @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .toast-success { border-left-color: var(--success); }
    .toast-error { border-left-color: var(--danger); }
    .toast-warning { border-left-color: var(--warning); }
    .toast-icon { font-size: 1.1rem; }
    .toast-message { flex: 1; font-size: 0.875rem; font-weight: 500; }

    .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 0.75rem; margin: 0.75rem 0; }
    .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 1rem; transition: all var(--transition-base); cursor: pointer; }
    .card:hover { transform: translateY(-4px); box-shadow: var(--shadow-xl); border-color: var(--primary); }
    .card-icon { width: 44px; height: 44px; background: var(--primary-gradient); border-radius: var(--radius-lg); display:flex; align-items:center; justify-content:center; color:#fff; margin-bottom: 0.5rem; }

    .sections-bar { display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; margin-bottom: 0.5rem; }
    
    #sectionsContainer {
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 0.5rem;
      min-height: 100px;
    }
    .section-item {
      padding: 0.5rem 0.75rem;
      border-radius: var(--radius-md);
      margin-bottom: 0.25rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      transition: background-color var(--transition-fast), outline var(--transition-fast);
      position: relative;
    }
    .section-item.active {
      background-color: var(--surface-hover);
      font-weight: 600;
      color: var(--primary);
    }
    .section-item:hover {
      background-color: var(--surface-hover);
    }
    .section-item .drag-handle { cursor: grab; color: var(--text-muted); }
    .section-item .section-label { flex-grow: 1; }
    .section-item .close-section {
      width: 22px; height: 22px; display: inline-flex; align-items: center; justify-content: center;
      border-radius: 6px; color: var(--text-muted);
    }
    .section-item .close-section:hover { background: var(--danger); color: white; }
    .section-item.dragging { opacity: 0.5; background: var(--primary-light); }
    
    .section-item.drop-feedback-top::before,
    .section-item.drop-feedback-bottom::after {
      content: '';
      position: absolute;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--accent);
      z-index: 1;
    }
    .section-item.drop-feedback-top::before { top: -2px; }
    .section-item.drop-feedback-bottom::after { bottom: -2px; }
    .section-item.drop-feedback-nest {
      outline: 2px dashed var(--primary);
      outline-offset: -2px;
      background-color: rgba(99, 102, 241, 0.1);
    }

    .dropdown { position: relative; }
    .dropdown-menu {
      position: absolute; top: 100%; right: 0; min-width: 260px; background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius-lg); box-shadow: var(--shadow-xl); display: none; z-index: 100; margin-top: 0.5rem;
      max-height: 360px; overflow-y: auto;
    }
    .dropdown.active .dropdown-menu { display: block; animation: fadeInDown var(--transition-fast); }
    @keyframes fadeInDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .dropdown-item { padding: 0.6rem 0.75rem; color: var(--text-primary); cursor: pointer; transition: all var(--transition-fast); display: flex; align-items: center; gap: 0.6rem; }
    .dropdown-item:hover { background: var(--surface-hover); color: var(--primary); }
    .dropdown-divider { height: 1px; background: var(--border); margin: 0.35rem 0; }

    .skeleton { background: linear-gradient(90deg, var(--surface-hover) 25%, var(--border) 50%, var(--surface-hover) 75%); background-size: 200% 100%; animation: loading 1.5s infinite; }
    @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    .spinner { width: 18px; height: 18px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .results-panel { background: var(--surface-hover); border-radius: var(--radius-lg); padding: 0.75rem; border: 1px solid var(--border); }
    .result-box { background:#0b1220; color:#e5e7eb; padding:0.75rem; border-radius:10px; min-height:120px; font-family:var(--font-mono); white-space: pre-wrap; }
    .result-header { display:flex; align-items:center; justify-content: space-between; margin-bottom:0.4rem; }
    .metric { display:inline-flex; background: #0ea5e9; color:#fff; border-radius: 999px; padding: 0.1rem 0.5rem; font-size: 0.75rem; margin-left: 0.25rem; }

    /* Chat */
    .chat-panel { display:none; }
    .chat-panel.active { display:block; }
    .chat-box { background:#0b1220; color:#e5e7eb; border-radius: 12px; padding: 0.75rem; height: 360px; overflow-y: auto; border:1px solid #1f2937; }
    .chat-msg { padding: 0.5rem 0.6rem; margin: 0.35rem 0; border-radius: 10px; max-width: 85%; }
    .chat-user { background:#1f2937; margin-left:auto; }
    .chat-assistant { background:#111827; border:1px solid #374151; }
    .chat-input { display:flex; gap:0.5rem; margin-top:0.5rem; }
    .chat-input input { flex:1; }

    .component-chip { border:1px dashed var(--primary); color:var(--primary); background: rgba(99,102,241,0.08); padding:0.5rem 0.75rem; border-radius: 999px; cursor:pointer; display:inline-flex; gap:0.5rem; align-items:center; margin: 0.25rem; font-weight:600; }
    .component-chip:hover { background: var(--primary); color:#fff; }

    .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }
    .badge { display:inline-flex; align-items:center; gap:0.4rem; padding:0.2rem 0.5rem; border-radius:999px; background:var(--surface); border:1px solid var(--border); font-size:0.75rem; }

    /* Shake effect for guiding focus */
    @keyframes shake { 0%{transform: translateX(0);} 25%{transform: translateX(-3px);} 50%{transform: translateX(3px);} 75%{transform: translateX(-2px);} 100%{transform: translateX(0);} }
    .shake { animation: shake 0.35s ease-in-out; }

    /* Section properties */
    .section-props {
      display: grid; grid-template-columns: 1fr auto; gap: 0.5rem; align-items: end; margin-top: 0.25rem;
      padding: 0.5rem; border:1px dashed var(--border); border-radius: var(--radius-lg); background: var(--surface-hover);
    }
    .section-props .actions { display:flex; gap:0.5rem; flex-wrap: wrap; }
    .muted { color: var(--text-muted); font-size: 0.85rem; }
    /* Fluent/Apple + Fluent UI inspired enhancements */
    body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
    .btn:focus-visible, .form-input:focus, .form-textarea:focus, .form-select:focus { box-shadow: 0 0 0 3px rgba(99,102,241,0.35); outline: none; }
    aside.sidebar-left, aside.sidebar-right { resize: horizontal; overflow: auto; min-width: 240px; }
    .header { backdrop-filter: blur(20px) saturate(160%); background: linear-gradient(180deg, rgba(255,255,255,0.78), rgba(255,255,255,0.5)); }
    [data-theme="dark"] .header { background: linear-gradient(180deg, rgba(30,41,59,0.74), rgba(30,41,59,0.45)); }
    .panel { backdrop-filter: blur(14px) saturate(160%); }

    /* Command Palette */
    .cmdp-body { padding: 0.75rem 1rem; }
    .cmdp-input { width: 100%; padding: 0.75rem 1rem; border-radius: 10px; border: 1px solid var(--border); background: var(--surface); color: var(--text-primary); }
    .cmdp-list { margin-top: 0.5rem; max-height: 50vh; overflow: auto; }
    .cmdp-item { padding: 0.55rem 0.75rem; border-radius: 10px; display:flex; align-items:center; justify-content: space-between; cursor:pointer; }
    .cmdp-item:hover, .cmdp-item.active { background: var(--surface-hover); color: var(--primary); }
    /* macOS window controls */
    .window-controls { position:absolute; left:16px; top:10px; display:flex; gap:8px; z-index:101; }
    .window-controls .wc { width:12px; height:12px; border-radius:50%; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.08); }
    .window-controls .wc.red { background:#ff5f57; }
    .window-controls .wc.yellow { background:#ffbd2e; }
    .window-controls .wc.green { background:#28c840; }
    /* CodeMirror macOS-like styling */
    .CodeMirror { height:auto; min-height:160px; font-family: var(--font-mono); font-size: 0.9rem; border: 1px solid var(--border); border-radius: 10px; background: var(--surface); color: var(--text-primary); padding: 4px 0; }
    .CodeMirror-scroll { max-height: 420px; }
    .CodeMirror-focused { box-shadow: 0 0 0 3px rgba(99,102,241,0.15); }
    .CodeMirror .cm-variable { color:#2563eb; font-weight:600; }
    .CodeMirror .cm-section { color:#059669; font-weight:600; }
    .CodeMirror .cm-hashtag { color:#94a3b8; font-style:italic; }
    .CodeMirror-hints { z-index: 2000; font-family: var(--font-sans); }
    .CodeMirror-hint { padding: 6px 8px; }
    .CodeMirror-hint-active { background: var(--primary); color:#fff; }
    /* Segmented control */
    .segmented { display:inline-flex; border:1px solid var(--border); border-radius:10px; overflow:hidden; background: var(--surface); }
    .segmented button { padding: 6px 10px; border:none; background:transparent; color:var(--text-secondary); cursor:pointer; }
    .segmented button.active { background: var(--surface-hover); color: var(--primary); font-weight:600; }
    /* Context menu look */
    .context-menu { position:absolute; z-index:1500; min-width:220px; background:var(--surface); border:1px solid var(--border); border-radius:12px; box-shadow: var(--shadow-xl); display:none; }
    .context-menu .item { padding:8px 10px; cursor:pointer; display:flex; gap:8px; align-items:center; }
    .context-menu .item:hover { background: var(--surface-hover); color: var(--primary); }
  </style>
</head>
<body>
  <div class="toast-container" id="toastContainer" aria-live="polite" aria-atomic="true"></div>

  <div class="app-container">
    <header class="header" role="banner">
      <div class="header-content">
        <div class="window-controls" aria-hidden="true"><span class="wc red"></span><span class="wc yellow"></span><span class="wc green"></span></div>
        <div class="window-controls" aria-hidden="true"><span class="wc red"></span><span class="wc yellow"></span><span class="wc green"></span></div>
        <div class="logo-section">
          <div class="logo" aria-hidden="true"><i class="fas fa-rocket"></i></div>
          <div class="logo-text">
            <div class="logo-title">LLM Prompt Studio Pro</div>
            <div class="logo-subtitle">Advanced Prompt Engineering Platform</div>
          </div>
          <div class="status-badge" aria-label="Auto-save actif" id="autosaveBadge">
            <span class="status-dot"></span>
            <span id="autosaveLabel">Auto-save actif</span>
          </div>
        </div>

        <nav class="nav-actions" aria-label="Actions">
          <button class="btn btn-secondary btn-icon tooltip" aria-label="Nouveau prompt" id="newPromptBtn">
            <i class="fas fa-plus"></i>
          </button>
          <button class="btn btn-secondary btn-icon tooltip" aria-label="Importer projet" id="importProjectBtn">
            <i class="fas fa-upload"></i>
          </button>
          <button class="btn btn-secondary btn-icon tooltip" aria-label="Exporter projet" id="exportProjectBtn">
            <i class="fas fa-download"></i>
          </button>
          <button class="btn btn-secondary btn-icon tooltip" aria-label="Partager" id="shareBtn">
            <i class="fas fa-share-alt"></i>
          </button>
          <div class="dropdown" id="settingsDropdown">
            <button class="btn btn-secondary btn-icon tooltip" aria-haspopup="true" aria-expanded="false" data-tooltip="Param√®tres">
              <i class="fas fa-cog"></i>
            </button>
            <div class="dropdown-menu" role="menu" aria-label="Param√®tres">
              <div class="dropdown-item" id="toggleThemeBtn">
                <i class="fas fa-moon"></i>
                <span>Mode sombre</span>
              </div>
              <div class="dropdown-item" id="keyboardHelp">
                <i class="fas fa-keyboard"></i>
                <span>Raccourcis</span>
              </div>
              <div class="dropdown-item" id="apiKeysBtn">
                <i class="fas fa-key"></i>
                <span>Cl√©s API</span>
              </div>
              <div class="dropdown-divider"></div>
              <div class="dropdown-item" id="aboutBtn">
                <i class="fas fa-info-circle"></i>
                <span>√Ä propos</span>
              </div>
            </div>
          </div>
          <button class="btn btn-primary" id="runPromptBtn" aria-label="Tester le prompt" disabled>
            <i class="fas fa-play"></i>
            <span id="runPromptLabel">Tester le prompt</span>
            <span class="spinner" id="runSpinner" style="display:none;"></span>
          </button>
        </nav>
      </div>
    </header>

    <main class="main-content">
      <!-- Left Sidebar -->
      <aside class="sidebar-left" aria-label="Biblioth√®que et composants">
        <div class="panel prompt-library">
          <div class="panel-header">
            <h2 class="panel-title">
              <i class="fas fa-folder-open"></i>
              <span>Projets & Biblioth√®que</span>
            </h2>
            <button class="btn btn-accent btn-icon" id="newProjectBtn" aria-label="Nouveau projet"><i class="fas fa-folder-plus"></i></button>
          </div>

          <div class="library-toolbar">
            <div class="search-box" style="flex:1">
              <div class="input-group">
                <i class="fas fa-search input-group-icon"></i>
                <input type="text" class="form-input" id="searchInput" placeholder="Rechercher..." />
              </div>
            </div>
            <div class="view-toggle" role="group" aria-label="Changer la vue">
              <button class="toggle active" id="listViewBtn" title="Vue liste"><i class="fas fa-list"></i></button>
              <button class="toggle" id="gridViewBtn" title="Vue cartes"><i class="fas fa-border-all"></i></button>
            </div>
          </div>

          <div class="filter-tags">
            <span class="tag-chip active" data-filter="*">Tous</span>
            <span class="tag-chip" data-filter="Marketing">Marketing</span>
            <span class="tag-chip" data-filter="Code">Code</span>
            <span class="tag-chip" data-filter="Cr√©atif">Cr√©atif</span>
            <span class="tag-chip" data-filter="Business">Business</span>
            <span class="tag-chip" data-filter="RH">RH</span>
            <span class="tag-chip" data-filter="L√©gal">L√©gal</span>
            <span class="tag-chip" data-filter="SEO">SEO</span>
            <span class="tag-chip" data-filter="SQL">SQL</span>
            <span class="tag-chip" data-filter="Python">Python</span>
          </div>

          <!-- Navigation hi√©rarchique Projets -->
          <div class="panel" style="padding:0.75rem;">
            <div class="sections-bar">
              <div style="font-weight:600; color: var(--text-secondary);">Projets</div>
              <div style="display:flex; gap:0.35rem;">
                <button class="btn btn-secondary btn-icon" id="addFolderBtn" title="Nouveau dossier"><i class="fas fa-folder-plus"></i></button>
                <button class="btn btn-secondary btn-icon" id="addPromptBtn" title="Nouveau prompt"><i class="fas fa-file-circle-plus"></i></button>
              </div>
            </div>
            <div id="projectTree" aria-label="Arborescence des projets"></div>
          </div>

          <div id="libraryContainer">
            <ul class="prompt-list" id="promptList">
              <li class="prompt-item active" data-key="marketing">
                <div class="prompt-item-title">Assistant Marketing Digital</div>
                <div class="prompt-item-preview">Cr√©er des strat√©gies de contenu optimis√©es pour le SEO...</div>
                <div class="prompt-item-meta">
                  <span class="prompt-item-tag tag-marketing">Marketing</span>
                  <span class="prompt-item-tag">SEO</span>
                </div>
              </li>
              <li class="prompt-item" data-key="python_review">
                <div class="prompt-item-title">Code Review Assistant (Python)</div>
                <div class="prompt-item-preview">Analyser et am√©liorer la qualit√© du code Python, d√©tecter les bugs...</div>
                <div class="prompt-item-meta">
                  <span class="prompt-item-tag tag-code">Code</span>
                  <span class="prompt-item-tag tag-code">Python</span>
                </div>
              </li>
              <li class="prompt-item" data-key="social_posts">
                <div class="prompt-item-title">G√©n√©rateur de Posts Sociaux</div>
                <div class="prompt-item-preview">Cr√©er des posts engageants pour LinkedIn, Twitter, Instagram...</div>
                <div class="prompt-item-meta">
                  <span class="prompt-item-tag tag-marketing">Marketing</span>
                  <span class="prompt-item-tag tag-creative">Cr√©atif</span>
                </div>
              </li>
              <li class="prompt-item" data-key="translator">
                <div class="prompt-item-title">Traducteur Technique</div>
                <div class="prompt-item-preview">Traduit des documents techniques en conservant le jargon...</div>
                <div class="prompt-item-meta"><span class="prompt-item-tag">Traduction</span></div>
              </li>
              <li class="prompt-item" data-key="sql_gen">
                <div class="prompt-item-title">G√©n√©rateur de Requ√™tes SQL</div>
                <div class="prompt-item-preview">Transforme une demande en langage naturel en requ√™te SQL...</div>
                <div class="prompt-item-meta">
                  <span class="prompt-item-tag tag-code">Code</span>
                  <span class="prompt-item-tag tag-code">SQL</span>
                </div>
              </li>
            </ul>
          </div>

          <!-- Components library -->
          <div class="panel" style="margin-top:0.75rem;">
            <div class="panel-header">
              <h3 class="panel-title"><i class="fas fa-puzzle-piece"></i> Composants de prompt</h3>
            </div>
            <div>
              <div class="component-chip" data-component="json">
                <i class="fas fa-code"></i> Format JSON
              </div>
              <div class="component-chip" data-component="tone">
                <i class="fas fa-paint-brush"></i> Ton & Style
              </div>
              <div class="component-chip" data-component="rubric">
                <i class="fas fa-clipboard-check"></i> Rubrique d'√©valuation
              </div>
              <div class="component-chip" data-component="safety">
                <i class="fas fa-shield-alt"></i> Garde-fous
              </div>
            </div>
          </div>

        </div>
      </aside>

      <!-- Center Editor -->
      <section class="editor-panel" aria-label="√âditeur principal">
        <div class="panel" id="editorPanel">
          <div class="panel-header">
            <h2 class="panel-title">
              <i class="fas fa-edit"></i>
              <span>√âditeur de Prompt</span>
            </h2>
            <div class="editor-modes" role="tablist">
              <button class="editor-mode active" role="tab" id="modeEditorBtn" aria-selected="true">√âditeur</button>
              <button class="editor-mode" role="tab" id="modeChatBtn" aria-selected="false">Mode Conversation</button>
            </div>
          </div>

          <!-- Toolbar -->
          <div class="editor-toolbar" role="toolbar" aria-label="Outils d'√©dition">
            <div class="toolbar-group" aria-label="Mise en forme">
              <button class="toolbar-btn" data-cmd="**" title="Gras"><i class="fas fa-bold"></i></button>
              <button class="toolbar-btn" data-cmd="*" title="Italique"><i class="fas fa-italic"></i></button>
              <button class="toolbar-btn" data-cmd="__" title="Soulign√©"><i class="fas fa-underline"></i></button>
              <button class="toolbar-btn" data-cmd="`" title="Code"><i class="fas fa-code"></i></button>
              <button class="toolbar-btn" id="optimizeBtn" title="Optimiser tokens"><i class="fas fa-gauge"></i></button>
            </div>
            <div class="toolbar-group" aria-label="Listes">
              <button class="toolbar-btn" data-insert="- " title="Liste"><i class="fas fa-list-ul"></i></button>
              <button class="toolbar-btn" data-insert="1) " title="Liste num√©rot√©e"><i class="fas fa-list-ol"></i></button>
              <button class="toolbar-btn" data-insert="> " title="Citation"><i class="fas fa-quote-right"></i></button>
            </div>
            <div class="toolbar-group dropdown" id="strategyDropdown">
              <button class="toolbar-btn" title="Ajouter une strat√©gie de raisonnement"><i class="fas fa-chess"></i> Strat√©gies</button>
              <div class="dropdown-menu" id="strategyMenu" aria-label="Strat√©gies"></div>
            </div>
            <div class="toolbar-group">
              <button class="toolbar-btn" id="addVariableBtn" title="Ajouter variable"><i class="fas fa-at"></i></button>
              <button class="toolbar-btn" id="addTemplateBtn" title="Ins√©rer template"><i class="fas fa-file-alt"></i></button>
            </div>
          </div>

          <!-- Variables -->
          <div class="variables-section" aria-live="polite">
            <h3 style="margin-bottom: 0.5rem; color: var(--primary); display:flex; gap:0.5rem; align-items:center;">
              <i class="fas fa-magic"></i> Variables dynamiques
            </h3>
            <div id="variable-chips-container" style="display:flex; flex-wrap: wrap;">
              <span class="variable-chip" data-variable="{{topic}}">
                <i class="fas fa-tag"></i>
                {{topic}}
              </span>
              <span id="add-variable-btn" class="variable-chip">
                <i class="fas fa-plus-circle"></i>
                Ajouter
              </span>
            </div>
          </div>

          <!-- Titre -->
          <div class="form-group">
            <label class="form-label">
              Titre du prompt
              <span class="required">*</span>
            </label>
            <input id="prompt-title" type="text" class="form-input" placeholder="Ex: Assistant de r√©daction SEO" value="Assistant Marketing Digital"/>
          </div>

          <!-- Sections controls -->
          <div class="sections-bar">
            <div style="flex:1; font-weight:600; color: var(--text-secondary);">Structure du Prompt</div>
            <div style="display:flex; gap:0.5rem; align-items:center;">
              <button id="addSectionBtn" class="btn btn-secondary btn-icon" aria-label="Ajouter une section"><i class="fas fa-plus"></i></button>
              <div class="dropdown" id="sectionsDropdown">
                <button class="btn btn-secondary btn-icon" aria-haspopup="true" aria-expanded="false" aria-label="Menu sections"><i class="fas fa-ellipsis-h"></i></button>
                <div class="dropdown-menu">
                  <div class="dropdown-item" id="resetDefaultSections"><i class="fas fa-undo"></i> Restaurer sections par d√©faut</div>
                  <div class="dropdown-item" id="exportSections"><i class="fas fa-download"></i> Exporter sections (JSON)</div>
                  <div class="dropdown-item" id="importSections"><i class="fas fa-upload"></i> Importer sections (JSON)</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Conteneur pour la structure hi√©rarchique -->
          <div id="sectionsContainer"></div>

          <!-- √âditeur de contenu de section -->
          <div id="sectionEditorContainer" class="tab-content" style="margin-top: 1rem;">
            <div class="form-group">
              <label class="form-label" id="sectionEditorLabel">Contenu de la section</label>
              <textarea id="section-textarea" class="form-textarea" placeholder="S√©lectionnez une section pour l'√©diter..." disabled></textarea>
            </div>

            <!-- Propri√©t√©s de section -->
            <div class="section-props" id="sectionProps" style="display:none;">
              <div>
                <div class="form-group" style="margin-bottom:0.5rem;">
                  <label class="form-label">Nom (balise)</label>
                  <input type="text" id="sectionNameInput" class="form-input" placeholder="ex: context, instructions..." />
                  <div class="muted">Le nom d√©termine la balise dans l‚Äôaper√ßu: <code>&lt;nom&gt;</code></div>
                </div>
                <div class="form-group" style="margin-bottom:0;">
                  <label class="form-label">Ic√¥ne</label>
                  <select id="sectionIconSelect" class="form-select">
                    <option value="fa-shield-halved">System</option>
                    <option value="fa-brain">Thinking</option>
                    <option value="fa-layer-group">Context</option>
                    <option value="fa-list-check">Instructions</option>
                    <option value="fa-ban">Constraints</option>
                    <option value="fa-lightbulb">Examples</option>
                    <option value="fa-paint-brush">Style</option>
                    <option value="fa-code">Output</option>
                    <option value="fa-diagram-project">CoT</option>
                    <option value="fa-tree">ToT</option>
                    <option value="fa-project-diagram">GoT</option>
                    <option value="fa-brain">ReAct</option>
                    <option value="fa-chess-knight">RAP</option>
                    <option value="fa-terminal">PAL</option>
                    <option value="fa-sitemap">SoT</option>
                    <option value="fa-list-ul">Scratchpad</option>
                  </select>
                </div>
              </div>
              <div class="actions">
                <button class="btn btn-secondary" id="moveUpBtn" title="Monter"><i class="fas fa-arrow-up"></i></button>
                <button class="btn btn-secondary" id="moveDownBtn" title="Descendre"><i class="fas fa-arrow-down"></i></button>
                <button class="btn btn-secondary" id="duplicateSectionBtn" title="Dupliquer"><i class="fas fa-copy"></i></button>
                <button class="btn btn-danger" id="deleteSectionBtn" title="Supprimer"><i class="fas fa-trash"></i></button>
              </div>
            </div>
          </div>

          <!-- Prompt principal -->
          <div class="form-group">
            <label class="form-label">
              Instruction Utilisateur (User)
              <span class="required">*</span>
            </label>
            <textarea id="prompt-textarea" class="form-textarea" style="min-height: 200px;" placeholder="√âcrivez votre prompt ici...">Cr√©er une strat√©gie de contenu compl√®te pour {{topic}} en incluant:

- Analyse de l'audience cible
- Calendrier √©ditorial sur 3 mois
- 10 id√©es d'articles optimis√©s SEO
- Strat√©gie de distribution multi-canal
- KPIs et m√©triques de succ√®s

Le tout doit √™tre adapt√© pour l'industrie {{industry}} et cibler {{target_audience}}.</textarea>
          </div>

          <!-- Preview -->
          <div class="preview-section" id="previewPane">
            <div class="preview-header">
              <span class="preview-title">
                <i class="fas fa-eye"></i> Aper√ßu en temps r√©el
                <span id="tokenEstimate" class="metric" title="Tokens estim√©s">~0 tok</span>
              </span>
              <div class="preview-actions">
                <button class="copy-btn" id="copyPreviewBtn"><i class="fas fa-copy"></i> Copier</button>
                <!-- Simulation streaming supprim√©e -->
                <button class="optimize-btn" id="optimizeAllBtn"><i class="fas fa-gauge"></i> Optimiser tout</button>
              </div>
            </div>
            <div id="previewContent"></div>
          </div>

          <!-- Validation & Stats -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-top: 1rem;">
            <div class="panel" style="padding: 0.75rem;">
              <h4 style="margin-bottom: 0.5rem; color: var(--success);">
                <i class="fas fa-check-circle"></i> Validation
              </h4>
              <ul id="validationList" style="list-style: none; font-size: 0.875rem;">
                <li><i class="fas fa-check" style="color: var(--success);"></i> Structure correcte</li>
                <li><i class="fas fa-exclamation" style="color: var(--warning);"></i> Variables manquantes</li>
              </ul>
            </div>
            <div class="panel" style="padding: 0.75rem;">
              <h4 style="margin-bottom: 0.5rem; color: var(--info);">
                <i class="fas fa-chart-bar"></i> Statistiques
              </h4>
              <ul style="list-style: none; font-size: 0.875rem;">
                <li id="statTokens">Tokens estim√©s: <strong>0</strong></li>
                <li id="statComplexity">Complexit√©: <strong>‚Äî</strong></li>
                <li id="statQuality">Score qualit√©: <strong>‚Äî</strong></li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Results streaming -->
        <div class="panel" id="resultsPanel">
          <div class="panel-header">
            <h3 class="panel-title">
              <i class="fas fa-terminal"></i>
              <span>R√©sultats d'ex√©cution</span>
            </h3>
            <div>
              <button class="btn btn-secondary btn-icon" id="clearResultsBtn" title="Effacer"><i class="fas fa-eraser"></i></button>
              <button class="btn btn-danger btn-icon" id="stopStreamBtn" title="Stop"><i class="fas fa-stop"></i></button>
            </div>
          </div>
          <div class="results-panel">
            <div class="result-header">
              <div><strong>Sortie</strong> <span id="resultMetrics" class="metric">‚Äî</span></div>
              <div id="resultStatus" class="badge" style="display:none;"></div>
            </div>
            <div class="result-box" id="runOutput" aria-live="polite"></div>
          </div>
        </div>

        <!-- Tests -->
        <div class="panel" id="testsPanel">
          <div class="panel-header">
            <h3 class="panel-title"><i class="fas fa-vial"></i> Suites de Tests</h3>
            <div class="segmented" role="tablist" aria-label="Mode d'ex√©cution">
              <button class="active" id="testsModeSingle">S√©quentiel</button>
              <button id="testsModeParallel">Parall√®le</button>
            </div>
          </div>
          <div style="display:grid; grid-template-columns: 1.2fr 1fr; gap:0.75rem;">
            <div>
              <div style="display:flex; gap:0.5rem; flex-wrap:wrap; margin-bottom:0.5rem;">
                <button class="btn btn-secondary" id="addSuiteBtn"><i class="fas fa-plus"></i> Nouvelle suite</button>
                <button class="btn btn-secondary" id="importCsvSuiteBtn"><i class="fas fa-upload"></i> Importer CSV</button>
                <button class="btn btn-secondary" id="exportSuitesBtn"><i class="fas fa-download"></i> Exporter</button>
                <button class="btn btn-accent" id="runSuitesBtn"><i class="fas fa-play"></i> Ex√©cuter</button>
                <button class="btn btn-danger" id="clearCacheBtn"><i class="fas fa-broom"></i> Vider cache</button>
              </div>
              <div id="suitesList" class="cards-grid" aria-live="polite">
                <div class="card" id="emptySuitesState">Aucune suite. Cr√©ez-en une pour commencer.</div>
              </div>
            </div>
            <div>
              <div class="settings-group">
                <h3 class="settings-group-title"><i class="fas fa-clipboard-check"></i> R√®gles de validation</h3>
                <div class="toggle-switch"><span class="toggle-label">JSON valide</span><label class="toggle-input"><input type="checkbox" id="ruleJson" /><span class="toggle-slider"></span></label></div>
                <div class="toggle-switch"><span class="toggle-label">Contient mot-cl√©</span><label class="toggle-input"><input type="checkbox" id="ruleKeyword" /><span class="toggle-slider"></span></label></div>
                <div class="form-group" id="ruleKeywordWrap" style="display:none; margin-top:0.5rem;"><input type="text" id="ruleKeywordInput" class="form-input" placeholder="Mot-cl√©" /></div>
                <div class="toggle-switch"><span class="toggle-label">Correspond √† une RegExp</span><label class="toggle-input"><input type="checkbox" id="ruleRegex" /><span class="toggle-slider"></span></label></div>
                <div class="form-group" id="ruleRegexWrap" style="display:none; margin-top:0.5rem;"><input type="text" id="ruleRegexInput" class="form-input" placeholder= "/^regex$/i" /></div>
                <div class="toggle-switch"><span class="toggle-label">Ne contient pas un mot-cl√©</span><label class="toggle-input"><input type="checkbox" id="ruleNotKeyword" /><span class="toggle-slider"></span></label></div>
                <div class="form-group" id="ruleNotKeywordWrap" style="display:none; margin-top:0.5rem;"><input type="text" id="ruleNotKeywordInput" class="form-input" placeholder="Mot interdit" /></div>
              </div>
              <div class="settings-group">
                <h3 class="settings-group-title"><i class="fas fa-code-branch"></i> Mod√®les</h3>
                <div style="display:flex; flex-wrap:wrap; gap:0.5rem;">
                  <label class="badge"><input type="checkbox" class="modelChk" value="GPT-4" checked style="margin-right:6px;"/> GPT-4</label>
                  <label class="badge"><input type="checkbox" class="modelChk" value="Claude 3.5" checked style="margin-right:6px;"/> Claude 3.5</label>
                  <label class="badge"><input type="checkbox" class="modelChk" value="Gemini 1.5" checked style="margin-right:6px;"/> Gemini 1.5</label>
                </div>
              </div>
              <div class="settings-group">
                <h3 class="settings-group-title"><i class="fas fa-database"></i> Cache</h3>
                <div class="muted">R√©sultats mis en cache par combinaison (mod√®le + prompt + variables). <span id="cacheCount">0</span> entr√©es.</div>
              </div>
            </div>
          </div>
          <div class="results-panel" style="margin-top:0.75rem;">
            <div class="result-header"><strong>R√©sultats</strong></div>
            <div id="testsResults" class="result-box"></div>
          </div>
        </div>
        
        <!-- History -->
        <div class="panel" id="historyPanel">
          <div class="panel-header">
            <h3 class="panel-title">
              <i class="fas fa-history"></i>
              <span>Historique des versions</span>
            </h3>
            <div style="display:flex; gap:0.5rem;">
              <button class="btn btn-secondary" id="saveVersionBtn"><i class="fas fa-save"></i> Sauvegarder version</button>
              <button class="btn btn-accent" id="compareABOpen"><i class="fas fa-columns"></i> Comparer A/B</button>
            </div>
          </div>
          <div id="historyCards" class="cards-grid">
            <!-- Dynamique -->
          </div>
        </div>

        <!-- A/B testing -->
        <div class="panel" id="abPanel" style="display:none;">
          <div class="panel-header">
            <h3 class="panel-title"><i class="fas fa-arrows-left-right"></i> Comparaison A/B</h3>
            <button class="btn btn-secondary btn-icon" id="closeAB"><i class="fas fa-xmark"></i></button>
          </div>
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:0.75rem;">
            <div>
              <div class="form-group">
                <label class="form-label">Variante A</label>
                <textarea id="abA" class="form-textarea" placeholder="Collez un prompt A"></textarea>
              </div>
              <div class="results-panel">
                <div class="result-header"><strong>R√©sultat A</strong></div>
                <div id="abAOut" class="result-box"></div>
              </div>
              <div style="display:flex; gap:0.5rem; margin-top:0.5rem;">
                <button class="btn btn-secondary" id="loadFromEditorA"><i class="fas fa-paste"></i> Depuis √©diteur</button>
              </div>
            </div>
            <div>
              <div class="form-group">
                <label class="form-label">Variante B</label>
                <textarea id="abB" class="form-textarea" placeholder="Collez un prompt B"></textarea>
              </div>
              <div class="results-panel">
                <div class="result-header"><strong>R√©sultat B</strong></div>
                <div id="abBOut" class="result-box"></div>
              </div>
              <div style="display:flex; gap:0.5rem; margin-top:0.5rem;">
                <button class="btn btn-secondary" id="loadFromEditorB"><i class="fas fa-paste"></i> Depuis √©diteur</button>
              </div>
            </div>
          </div>
          <div class="modal-footer" style="border-top:none; padding:0; margin-top:0.75rem;">
            <button class="btn btn-primary" id="runAB"><i class="fas fa-play"></i> Lancer A/B</button>
            <button class="btn btn-secondary" id="scoreAB"><i class="fas fa-ranking-star"></i> √âvaluer</button>
          </div>
        </div>

        <!-- Chat mode -->
        <div class="panel chat-panel" id="chatPanel">
          <div class="panel-header">
            <h3 class="panel-title"><i class="fas fa-comments"></i> Mode Conversation (simulation)</h3>
            <div>
              <button class="btn btn-secondary btn-icon" id="resetChatBtn" title="R√©initialiser"><i class="fas fa-broom"></i></button>
            </div>
          </div>
          <div class="chat-box" id="chatBox" aria-live="polite"></div>
          <div class="chat-input">
            <input type="text" id="chatInput" class="form-input" placeholder="Votre message..." />
            <button class="btn btn-primary" id="sendChatBtn"><i class="fas fa-paper-plane"></i> Envoyer</button>
          </div>
        </div>

      </section>

      <!-- Right Sidebar -->
      <aside class="sidebar-right" aria-label="Param√®tres et outils">
        <div class="panel settings-panel">
          <!-- Variables values -->
          <div class="panel" style="padding: 0.75rem; margin-bottom: 1rem; order: -1;">
            <div class="panel-header" style="padding-bottom: 0.5rem; margin-bottom: 0.5rem;">
              <h3 class="panel-title">
                <i class="fas fa-tasks"></i>
                <span>Valeurs des Variables</span>
              </h3>
            </div>
            <div id="variable-inputs-container">
              <p class="text-muted" style="font-size: 0.875rem; text-align: center;">Aucune variable d√©tect√©e.</p>
            </div>
          </div>

          <div class="panel-header">
            <h2 class="panel-title">
              <i class="fas fa-sliders-h"></i>
              <span>Param√®tres du Mod√®le</span>
            </h2>
          </div>

          <!-- Model Selection -->
          <div class="settings-group">
            <h3 class="settings-group-title"><i class="fas fa-robot"></i> Mod√®le IA</h3>
            <select class="form-select" id="modelSelect">
              <option>GPT-4 Turbo (128k)</option>
              <option>GPT-4 Vision</option>
              <option selected>Claude 4 Opus</option>
              <option>Claude 3.5 Sonnet</option>
              <option>Gemini 1.5 Pro</option>
              <option>Llama 3 70B</option>
            </select>
          </div>

          <!-- Persona -->
          <div class="settings-group">
            <h3 class="settings-group-title"><i class="fas fa-user-tie"></i> Persona / R√¥le</h3>
            <select id="personaSelect" class="form-select">
              <option value="none">Aucun (personnalis√©)</option>
              <option value="seo">Expert SEO Senior</option>
              <option value="python">D√©veloppeur Python Senior</option>
              <option value="pm">Product Manager Data</option>
              <option value="legal">Juriste Contrats</option>
              <option value="ux">UX Writer</option>
            </select>
            <div style="display:flex; align-items:center; justify-content:space-between; margin-top:0.5rem;">
              <label class="toggle-input"><input type="checkbox" id="lockSystem"><span class="toggle-slider"></span></label>
              <span class="toggle-label">Verrouiller section System</span>
              <button class="btn btn-secondary" id="applyPersonaBtn" title="Appliquer dans System"><i class="fas fa-wand-magic-sparkles"></i> Appliquer</button>
            </div>
          </div>

          <!-- Param√®tres avanc√©s -->
          <div class="settings-group">
            <h3 class="settings-group-title"><i class="fas fa-thermometer-half"></i> Param√®tres avanc√©s</h3>

            <div class="range-slider">
              <div class="range-slider-header"><span class="range-slider-label">Temp√©rature</span><span class="range-slider-value">0.7</span></div>
              <input type="range" class="range-input" min="0" max="2" step="0.1" value="0.7" />
            </div>

            <div class="range-slider">
              <div class="range-slider-header"><span class="range-slider-label">Max Tokens</span><span class="range-slider-value">2048</span></div>
              <input type="range" class="range-input" min="100" max="8000" step="100" value="2048" />
            </div>

            <div class="range-slider">
              <div class="range-slider-header"><span class="range-slider-label">Top P</span><span class="range-slider-value">0.9</span></div>
              <input type="range" class="range-input" min="0" max="1" step="0.1" value="0.9" />
            </div>

            <div class="range-slider">
              <div class="range-slider-header"><span class="range-slider-label">Frequency Penalty</span><span class="range-slider-value">0</span></div>
              <input type="range" class="range-input" min="-2" max="2" step="0.1" value="0" />
            </div>
          </div>

          <!-- Options -->
          <div class="settings-group">
            <h3 class="settings-group-title"><i class="fas fa-cog"></i> Options</h3>
            <div class="toggle-switch">
              <span class="toggle-label">Streaming</span>
              <label class="toggle-input"><input type="checkbox" id="optStreaming" checked /><span class="toggle-slider"></span></label>
            </div>
            <div class="toggle-switch">
              <span class="toggle-label">Cache responses</span>
              <label class="toggle-input"><input type="checkbox" id="optCache" checked /><span class="toggle-slider"></span></label>
            </div>
            <div class="toggle-switch">
              <span class="toggle-label">Auto-save</span>
              <label class="toggle-input"><input type="checkbox" id="optAutosave" checked /><span class="toggle-slider"></span></label>
            </div>
            <div class="toggle-switch">
              <span class="toggle-label">Mode s√ªr</span>
              <label class="toggle-input"><input type="checkbox" id="optSafe" /><span class="toggle-slider"></span></label>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="settings-group">
            <h3 class="settings-group-title"><i class="fas fa-bolt"></i> Actions rapides</h3>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
              <button class="btn btn-secondary" id="openCmdPaletteBtn" style="width: 100%;"><i class="fas fa-magnifying-glass"></i> Command Palette (Ctrl/Cmd+K)</button>
              <button class="btn btn-accent" id="openBatchBtn" style="width: 100%;"><i class="fas fa-table"></i> Test par lots (CSV)</button>
              <!-- Optimizer button removed to avoid duplicate with preview actions -->
            </div>
          </div>

          <!-- API Stats -->
          <div class="settings-group">
            <h3 class="settings-group-title"><i class="fas fa-chart-line"></i> Utilisation API</h3>
            <div style="margin-bottom: 0.75rem;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 0.35rem;">
                <span style="font-size: 0.875rem;">Tokens estim√©s</span>
                <span id="apiTokenUsage" style="font-size: 0.875rem; font-weight: 600;">0 / 100,000</span>
              </div>
              <div class="progress"><div class="progress-bar" id="apiTokenBar" style="width: 0%; height:8px; background: var(--primary-gradient); border-radius:999px;"></div></div>
            </div>
            <div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 0.35rem;">
                <span style="font-size: 0.875rem;">Requ√™tes</span>
                <span id="apiReqUsage" style="font-size: 0.875rem; font-weight: 600;">0 / 500</span>
              </div>
              <div class="progress"><div class="progress-bar" id="apiReqBar" style="width: 0%; height:8px; background: var(--primary-gradient); border-radius:999px;"></div></div>
            </div>
          </div>
        </div>
      </aside>
    </main>
  </div>

  <!-- Modal: Ajouter section -->
  <div class="modal" id="addSectionModal" role="dialog" aria-modal="true" aria-labelledby="addSectionTitle">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="addSectionTitle"><i class="fas fa-layer-group"></i> Ajouter une section</div>
        <button class="modal-close" data-close-modal="#addSectionModal"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Nom de la section</label>
          <input type="text" id="newSectionName" class="form-input" placeholder="Ex: context, instructions, output..." />
        </div>
        <div class="form-group">
          <label class="form-label">Ic√¥ne</label>
          <select id="newSectionIcon" class="form-select">
            <option value="fa-shield-halved">System</option>
            <option value="fa-brain">Thinking</option>
            <option value="fa-layer-group" selected>Context</option>
            <option value="fa-list-check">Instructions</option>
            <option value="fa-ban">Constraints</option>
            <option value="fa-lightbulb">Examples</option>
            <option value="fa-paint-brush">Style</option>
            <option value="fa-code">Output Format</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Template</label>
          <select id="newSectionTemplate" class="form-select">
            <option value="">Vide</option>
            <option value="context">Contexte (d√©tails, audience, contraintes de domaine)</option>
            <option value="instructions">Instructions (objectifs, √©tapes, ton)</option>
            <option value="constraints">Contraintes (do/don‚Äôt, longueur, formats)</option>
            <option value="examples">Exemples (few-shot)</option>
            <option value="style">Style (ton, persona, niveaux)</option>
            <option value="output">Format de sortie (JSON, sections, titres)</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Contenu initial</label>
          <textarea id="newSectionContent" class="form-textarea" placeholder="Contenu initial de la section (optionnel)"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-close-modal="#addSectionModal">Annuler</button>
        <button class="btn btn-primary" id="confirmAddSection"><i class="fas fa-plus"></i> Ajouter</button>
      </div>
    </div>
  </div>

  <!-- Modal: Batch tests -->
  <div class="modal" id="batchModal" role="dialog" aria-modal="true" aria-labelledby="batchTitle">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="batchTitle"><i class="fas fa-table"></i> Test par lots (CSV)</div>
        <button class="modal-close" data-close-modal="#batchModal"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom:0.5rem;">Importez un CSV dont les colonnes correspondent aux variables (ex: topic, industry, target_audience).</p>
        <div style="display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center;">
          <input type="file" id="csvInput" accept=".csv" />
          <div class="form-group" style="margin:0;">
            <label class="form-label">R√®gle d'√©valuation</label>
            <select id="batchRule" class="form-select">
              <option value="none">Aucune</option>
              <option value="json">JSON valide</option>
              <option value="keyword">Contient mot-cl√©</option>
            </select>
          </div>
          <div class="form-group" id="batchKeywordWrap" style="display:none; margin:0;">
            <label class="form-label">Mot-cl√©</label>
            <input type="text" id="batchKeyword" class="form-input" placeholder="mot-cl√©..." />
          </div>
          <button class="btn btn-primary" id="runBatchBtn"><i class="fas fa-play"></i> Lancer</button>
        </div>
        <div id="batchSummary" style="margin-top:0.5rem;"></div>
        <div style="margin-top:0.5rem;">
          <div id="batchTable" class="result-box" style="background:#0b1220; color:#e5e7eb;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-close-modal="#batchModal">Fermer</button>
      </div>
    </div>
  </div>

  <!-- Modal: Optimisation -->
  <div class="modal" id="optModal" role="dialog" aria-modal="true" aria-labelledby="optTitle">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="optTitle"><i class="fas fa-gauge"></i> Optimisation des tokens</div>
        <button class="modal-close" data-close-modal="#optModal"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Avant</label>
          <textarea id="optBefore" class="form-textarea" style="min-height:140px;" readonly></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Proposition optimis√©e</label>
          <textarea id="optAfter" class="form-textarea" style="min-height:180px;"></textarea>
          <div style="font-size:0.85rem; margin-top:0.35rem;">
            <span id="optStats" class="metric">‚Äî</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-close-modal="#optModal">Fermer</button>
        <button class="btn btn-primary" id="applyOptimization"><i class="fas fa-check"></i> Remplacer</button>
      </div>
    </div>
  </div>

  <!-- Command Palette Modal -->
  <div class="modal" id="cmdPalette" role="dialog" aria-modal="true" aria-labelledby="cmdTitle">
    <div class="modal-content" style="max-width: 720px;">
      <div class="modal-header">
        <div class="modal-title" id="cmdTitle"><i class="fas fa-magnifying-glass"></i> Command Palette</div>
        <button class="modal-close" data-close-modal="#cmdPalette"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body cmdp-body">
        <input id="cmdPaletteInput" class="cmdp-input" type="text" placeholder="Rechercher une commande‚Ä¶ (tapez > pour actions)">
        <div id="cmdPaletteList" class="cmdp-list" role="listbox"></div>
      </div>
      <div class="modal-footer" style="justify-content: space-between;">
        <div class="muted">Navigation: ‚Üë/‚Üì ‚Ä¢ Valider: Entr√©e ‚Ä¢ Fermer: √âchap</div>
        <button class="btn btn-secondary" data-close-modal="#cmdPalette">Fermer</button>
      </div>
    </div>
  </div>

  <!-- Modal: Cl√©s API -->
  <div class="modal" id="apiKeysModal" role="dialog" aria-modal="true" aria-labelledby="apiKeysTitle">
    <div class="modal-content" style="max-width:640px;">
      <div class="modal-header">
        <div class="modal-title" id="apiKeysTitle"><i class="fas fa-key"></i> Cl√©s API</div>
        <button class="modal-close" data-close-modal="#apiKeysModal"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <div class="form-group"><label class="form-label">OpenAI</label><input type="password" id="keyOpenAI" class="form-input" placeholder="sk-..." /></div>
        <div class="form-group"><label class="form-label">Anthropic</label><input type="password" id="keyAnthropic" class="form-input" placeholder="anthropic-..." /></div>
        <div class="form-group"><label class="form-label">Google</label><input type="password" id="keyGoogle" class="form-input" placeholder="AIza..." /></div>
        <div class="muted">Stock√©es localement (localStorage). Jamais envoy√©es.</div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-close-modal="#apiKeysModal">Fermer</button>
        <button class="btn btn-primary" id="saveApiKeysBtn"><i class="fas fa-save"></i> Enregistrer</button>
      </div>
    </div>
  </div>
  <script>
    // CodeMirror mode for PromptX language (Markdown + variables + sections + comments)
    (function(){
      if (window.CodeMirror && CodeMirror.defineSimpleMode) {
        CodeMirror.defineSimpleMode('promptx', {
          start: [
            { regex: /#.*/, token: 'comment' },
            { regex: /{{[^}]*}}/, token: 'variable' },
            { regex: /<\/?[a-zA-Z0-9_-]+>/, token: 'section' },
            { regex: /\*\*[^*]+\*\*/, token: 'strong' },
            { regex: /\*[^*]+\*/, token: 'em' },
            { regex: /`[^`]+`/, token: 'atom' }
          ],
          meta: { lineComment: '#' }
        });
      }
    })();

    class PromptStudio {
  buildCommands() {
    const cmds = [];
    const add = (id, label, action, icon='fa-circle-dot', section='G√©n√©ral') => cmds.push({id,label,action,icon,section});
    add('new-prompt','Nouveau prompt', () => this.resetEditor(), 'fa-file-circle-plus');
    add('run-prompt','Tester le prompt', () => this.testPrompt(), 'fa-play');
    add('optimize-all','Optimiser tout', () => this.openOptimization(true), 'fa-gauge-high');
    add('toggle-theme','Basculer th√®me', () => this.toggleTheme(), 'fa-moon');
    add('open-batch','Ouvrir test par lots', () => this.openBatch(), 'fa-table');
    add('save-version','Sauvegarder version', () => this.saveVersion(), 'fa-save');
    add('compare-ab','Ouvrir comparaison A/B', () => this.openAB(), 'fa-arrows-left-right');
    add('copy-preview','Copier l‚Äôaper√ßu', () => this.copyToClipboard(), 'fa-copy');
    add('apply-persona','Appliquer persona', () => this.applyPersona(), 'fa-user-tie', 'Persona');
    return cmds;
  }

  openCommandPalette() {
    const modal = document.getElementById('cmdPalette');
    const input = document.getElementById('cmdPaletteInput');
    const list = document.getElementById('cmdPaletteList');
    if (!modal) return;
    const render = (q='') => {
      const str = (q||'').toLowerCase();
      list.innerHTML = '';
      const filtered = this.commands.filter(c => c.label.toLowerCase().includes(str) || c.section.toLowerCase().includes(str));
      filtered.forEach((c,i) => {
        const item = document.createElement('div');
        item.className = 'cmdp-item';
        item.setAttribute('role','option');
        item.innerHTML = `<div style="display:flex; gap:.5rem; align-items:center;"><i class="fas ${c.icon}"></i><strong>${this.escape(c.label)}</strong></div><span class="muted">${this.escape(c.section)}</span>`;
        item.addEventListener('click', () => { c.action(); modal.classList.remove('active'); });
        list.appendChild(item);
        if (i===0) item.classList.add('active');
      });
    };
    modal.classList.add('active');
    render('');
    setTimeout(()=>{ input?.focus(); input?.select(); }, 50);
    let idx = 0;
    const keyHandler = (e) => {
      const items = Array.from(list.querySelectorAll('.cmdp-item'));
      if (e.key === 'ArrowDown') { e.preventDefault(); idx=Math.min(items.length-1, idx+1); }
      if (e.key === 'ArrowUp') { e.preventDefault(); idx=Math.max(0, idx-1); }
      if (e.key === 'Enter') { e.preventDefault(); items[idx]?.click(); cleanup(); }
      if (e.key === 'Escape') { cleanup(); }
      items.forEach(el=>el.classList.remove('active')); items[idx]?.classList.add('active');
    };
    const inputHandler = (e) => { idx=0; render(e.target.value.replace(/^>/,'')); };
    const cleanup = () => {
      modal.classList.remove('active');
      input?.removeEventListener('input', inputHandler);
      document.removeEventListener('keydown', keyHandler);
    };
    input?.addEventListener('input', inputHandler);
    document.addEventListener('keydown', keyHandler);
  }

      enrichStrategies() {
        const generic = (title) => `But: Appliquer la strat√©gie ${title} avec rigueur et tra√ßabilit√©.
Entr√©es:
- Contexte du probl√®me
- Contraintes/objectif mesurable
- Donn√©es d'appui si disponibles

Proc√©dure d√©taill√©e:
1) Reformuler le probl√®me et le cadrer en 1-2 phrases.
2) √âtablir hypoth√®ses cl√©s et crit√®res de succ√®s.
3) Ex√©cuter la m√©thode ${title} pas √† pas en limitant les sauts logiques.
4) Produire une sortie structur√©e avec d√©cisions justifi√©es.

Heuristiques d'arr√™t:
- Les crit√®res de succ√®s sont satisfaits
- Plus d'am√©lioration marginale visible

V√©rifications qualit√©:
- Coh√©rence globale et absence de contradictions
- Tra√ßabilit√© des √©tapes, formatage propre
- R√©ponse actionnable et mesurable

Modes:
- Compact: 5-8 lignes, essentiel et directement exploitable
- Exhaustif: tous les raisonnements et alternatives utiles

Anti-patterns:
- Verbiage non justifi√©, √©tapes opaques, conclusions non fond√©es.`;

        const playbooks = {
          cot: `But: R√©solution par raisonnement explicite (Chain-of-Thought).
Pr√©-requis:
- Objectif clair + m√©triques
- Contraintes explicites

√âtapes:
1) D√©composer le probl√®me en sous-probl√®mes atomiques.
2) R√©soudre chaque sous-probl√®me avec justification.
3) R√©concilier les r√©sultats et expliciter les compromis.
4) Formuler la r√©ponse finale avec r√©sum√© et prochaines actions.

Qualit√©:
- Chaque √©tape doit avoir une raison et un r√©sultat.
- Pas de saut logique.

Sortie:
- Bref r√©capitulatif, √©tapes num√©rot√©es, solution finale.
- Bloc JSON optionnel des d√©cisions cl√©s: {"hypotheses":[], "steps":[], "decision":"..."}.`,
          thot: `But: Maintenir un fil de pens√©e persistant sur plusieurs tours (Thread-of-Thought).
√âtapes:
1) Rappel synth√©tique du contexte √† chaque tour.
2) Formuler le prochain pas avec justification.
3) Tenir un journal des d√©cisions (m√©ta-m√©moire).
4) R√©sumer p√©riodiquement l'√©tat et les TODOs.
Sortie: journal compact + proposition d'action imm√©diate.`,
          ltm: `But: Du simple au complexe (Least-to-Most).
√âtapes:
1) Lister les sous-probl√®mes du plus facile au plus dur.
2) R√©soudre les faciles pour cr√©er des briques.
3) Composer vers la solution complexe en int√©grant les briques.
4) V√©rifier coh√©rence globale et √©checs √©ventuels.`,
          tot: `But: Explorer et √©valuer plusieurs branches (Tree-of-Thoughts).
√âtapes:
1) G√©n√©rer 2-4 branches ind√©pendantes.
2) Pour chaque branche: forces/faiblesses/risques.
3) √âvaluer selon crit√®res (co√ªt, risque, impact, temps).
4) S√©lectionner la meilleure, fusionner √©l√©ments utiles des autres.
Sortie: tableau comparatif + plan retenu.`,
          got: `But: Repr√©senter les id√©es en graphe (Graph-of-Thoughts).
√âtapes:
1) Noeuds = id√©es/√©tats, Ar√™tes = d√©pendances.
2) Annoter co√ªts/b√©n√©fices par ar√™te.
3) Trouver parcours optimal (ex: plus court/plus robuste).
4) Traduire le parcours en plan d'action.
Sortie: liste des noeuds/liaisons + chemin retenu.`,
          sc: `But: Obtenir robustesse via self-consistency.
√âtapes:
1) G√©n√©rer N variantes (‚â•3) avec seeds diff√©rents.
2) Mesurer la coh√©rence vs crit√®res (r√®gles, tests simples).
3) Voter/agr√©ger la meilleure r√©ponse.
Sortie: score par variante + d√©cision finale.`,
          cbp: `But: Complexity-Based Prompting.
√âtapes:
1) Inclure au moins un exemple complexe (few-shot).
2) Forcer justification multi-√©tapes.
3) Exiger validation (tests, r√®gles) en fin de r√©ponse.
Sortie: r√©ponse + bloc "validation".`,
          react: `But: Alterner Raisonnement / Action (ReAct).
Boucle:
- Thought: exposer bri√®vement la r√©flexion.
- Act: ex√©cuter une requ√™te/outillage (d√©crire l'outil).
- Observe: int√©grer le r√©sultat.
R√©p√©ter jusqu'√† obtention.
Sortie: historique Thought/Act/Obs + r√©ponse finale.`,
          rap: `But: Planification et recherche de plans (Reasoning via Planning).
√âtapes:
1) D√©finir √©tats, actions, co√ªts.
2) Explorer l'espace (ex: MCTS) sur horizon limit√©.
3) S√©lectionner plan Pareto-optimal.
4) Ex√©cuter/it√©rer avec feedback.
Sortie: plan s√©quenc√© avec jalons & m√©triques.`,
          pal: `But: D√©l√©guer calculs √† un programme (PAL).
√âtapes:
1) Isoler les parties calculables.
2) D√©finir I/O du programme (exemples rapides).
3) Ex√©cuter/√©muler et capturer sorties.
4) Int√©grer r√©sultats dans la r√©ponse.
Sortie: pseudo-code + r√©sultats + interpr√©tation.`,
          stepback: `But: Abstraction avant d√©tails (Step-Back).
√âtapes:
1) Formuler principes/directives g√©n√©rales.
2) D√©cliner sur les cas particuliers.
3) V√©rifier non-contradiction.
Sortie: principes ‚ûú application.`,
          ap: `But: Transfert par analogie.
√âtapes:
1) Choisir une analogie structurelle pertinente.
2) Mapper √©l√©ments source ‚ûú cible.
3) Identifier limites de l‚Äôanalogie.
Sortie: analogie + transfert + limites.`,
          gkp: `But: G√©n√©rer le socle de connaissances requis.
√âtapes:
1) Lister connaissances manquantes.
2) G√©n√©rer d√©finitions/faits utiles.
3) Marquer incertitudes.
Sortie: knowledge-base synth√©tique + drapeaux d'incertitude.`,
          s2a: `But: Attention Syst√®me 2 (filtrage).
√âtapes:
1) Lister toutes les infos.
2) Tagger pertinence (√©lev√©e/moyenne/faible).
3) Ne garder que l'essentiel.
Sortie: contexte filtr√© + justification.`,
          dsp: `But: Stimulus directionnel.
√âtapes:
1) D√©finir les indicateurs √† susciter.
2) Cr√©er prompts d'orientation.
3) V√©rifier d√©rives/effets pervers.
Sortie: stimuli + garde-fous.`,
          active: `But: S√©lection active d'information.
√âtapes:
1) Identifier incertitudes/besoins.
2) Poser 3-5 questions cibl√©es.
3) Affiner le plan.
Sortie: Q/R ‚ûú plan affin√©.`,
          reflexion: `But: Auto-critique et r√©vision.
√âtapes:
1) G√©n√©rer un brouillon.
2) Produire une critique structur√©e (rubrique).
3) Appliquer corrections.
Sortie: v1 ‚ûú critique ‚ûú v2.`,
          meta: `But: Am√©liorer le prompt lui-m√™me.
√âtapes:
1) Diagnostiquer les faiblesses (ambig√ºit√©s, longueur, manque de crit√®res).
2) R√©√©crire avec contraintes mesurables.
3) Valider par mini-tests.
Sortie: prompt v1/v2 + diffs.`,
          bootstrap: `But: Amor√ßage it√©ratif sans annotation.
√âtapes:
1) G√©n√©rer.
2) Corriger erreurs √©videntes.
3) R√©g√©n√©rer guid√© par les corrections.
Sortie: traces d'it√©rations + version stable.`,
          vae: `But: V√©rifier puis √©diter (Verify-and-Edit).
√âtapes:
1) G√©n√©rer la sortie.
2) Passer une grille de v√©rification (tests/r√®gles).
3) Appliquer un patch minimal.
Sortie: rapport de v√©rif + patch + sortie finale.`,
          recursive: `But: Raffinement successif.
√âtapes:
1) D√©finir crit√®res d'arr√™t.
2) It√©rer: √©valuer ‚ûú am√©liorer.
3) Sauver checkpoints.
Sortie: historique des it√©rations + version finale.`,
          sot: `But: Squelette d'abord (Skeleton-of-Thought).
√âtapes:
1) Lister les points cl√©s (1 ligne/point).
2) D√©velopper chaque point en parall√®le.
3) Synchroniser et harmoniser.
Sortie: skeleton ‚ûú d√©veloppement.`,
          scratchpad: `But: Montrer le travail (scratchpad).
√âtapes:
1) R√©server une zone de calcul.
2) Y inscrire les √©tapes interm√©diaires.
3) Nettoyer avant rendu final (si requis).
Sortie: scratchpad + r√©ponse propre.`,
          chain: `But: Cha√Æner des prompts.
√âtapes:
1) D√©composer en sous-prompts s√©quentiels.
2) D√©finir interfaces (I/O) entre maillons.
3) Orchestrer et agr√©ger les sorties.
Sortie: pipeline + r√©sultats.`,
          persona: `But: Adapter le r√¥le.
√âtapes:
1) D√©finir expertise/ton/contraintes.
2) Appliquer aux d√©cisions et au style.
3) Rester coh√©rent sur toute la sortie.
Sortie: r√©ponses conformes au r√¥le.`,
          emotion: `But: Injecter la nuance √©motionnelle correcte.
√âtapes:
1) Choisir l'√©motion et l'intensit√© ad√©quates.
2) Ajouter signaux subtils (lexique, rythme).
3) V√©rifier convenance contexte/audience.
Sortie: texte expressif mais professionnel.`,
          cont: `But: Comparer et trancher (contrastif).
√âtapes:
1) G√©n√©rer 2-3 alternatives distinctes.
2) Comparer crit√®res objectifs.
3) Choisir et justifier.
Sortie: tableau comparatif + d√©cision.`,
          mai: `But: Approche ma√Øeutique.
√âtapes:
1) Poser questions progressives (du g√©n√©ral au pr√©cis).
2) Faire √©merger hypoth√®ses de l'utilisateur.
3) Reformuler et conclure.
Sortie: Q/R guid√©es + synth√®se.`,
          mmcot: `But: CoT multimodal.
√âtapes:
1) D√©crire bri√®vement l'entr√©e visuelle (structure, r√©gions).
2) Raisonner √©tape par √©tape avec r√©f√©rences aux √©l√©ments visuels.
3) Conclure avec v√©rifications crois√©es texte‚Üîvision.
Sortie: raisonnement multimodal clair.`
        };

        Object.entries(this.strategies).forEach(([k, it]) => {
          const extra = playbooks[k] || generic(it.title);
          const resume = it.content || '';
          it.content = `${resume}\n\n====================\nPLAYBOOK D√âTAILL√â\n====================\n${extra}\n\nChecklist de sortie:\n- [ ] Objectif satisfait\n- [ ] √âtapes tra√ßables\n- [ ] Crit√®res/mesures fournis\n- [ ] D√©cisions justifi√©es\n- [ ] Prochaines actions claires`;
        });

        // D√©duplication basique
        const seen = new Set();
        Object.keys(this.strategies).forEach(k => {
          const c = this.strategies[k].content;
          const sig = c.trim();
          if (seen.has(sig)) delete this.strategies[k]; else seen.add(sig);
        });
      }

      constructor() {
        this.state = {
          prompts: [],
          currentPrompt: { id: this.uid(), title: 'Assistant Marketing Digital' },
          settings: {
            model: 'Claude 4 Opus',
            temperature: 0.7,
            maxTokens: 2048,
            topP: 0.9,
            frequencyPenalty: 0,
            streaming: true,
            cache: true,
            autoSave: true,
            safeMode: false
          },
          history: [],
          variableValues: {},
          isDarkMode: false,
          sections: [], // Structure en arbre
          activeSectionId: null,
          apiUsage: { tokens: 0, req: 0 },
          chatHistory: [],
          streamTimers: new Map(),
          isRunning: false,
        };
        this.templates = this.initTemplates();
        this.personas = this.initPersonas();
        this.libraryData = this.initLibrary();
        this.strategies = this.initStrategies();
        this.enrichStrategies();
        this.init();
      }

      uid() { return 's_' + Math.random().toString(36).slice(2, 9); }

      init() {
        this.loadFromStorage();
        if (!this.state.sections || this.state.sections.length === 0) this.resetDefaultSections();
        // Toujours garantir la pr√©sence de la section thinking (non retirable)
        this.ensureThinkingSection();
        this.setupEventListeners();
        this.initializeUI(); this.commands = this.buildCommands(); this.enrichStrategies();
        this.startAutoSave();
      }

      initTemplates() {
        return {
          sections: {
            context: `Contexte:\n- Domaine: {{industry}}\n- Audience: {{target_audience}}\n- Produits/Services: ...\n- Contraintes de marque: ...\n\nObjectif global:\n- ...\n\nInfos compl√©mentaires:\n- ...`,
            instructions: `Objectifs:\n1) ...\n2) ...\n\n√âtapes:\n- ...\n\nTon & style:\n- ...`,
            constraints: `Contraintes:\n- Longueur: ...\n- Interdits: ...\n- Format: ...\n- Lignes directrices: ...`,
            examples: `Exemple 1 (Input -> Output):\nInput: ...\nOutput: ...\n\nExemple 2:\nInput: ...\nOutput: ...`,
            style: `Style / Persona:\n- Ton: ...\n- Niveau de d√©tail: ...\n- Langue: fr-FR\n- Formatage: ...`,
            output: `Format de sortie attendu (JSON):\n{\n  "titre": "...",\n  "sections": [\n    { "nom": "...", "contenu": "..." }\n  ]\n}`
          },
          components: {
            json: `Veuillez retourner UNIQUEMENT un JSON valide, sans texte hors JSON.\nSch√©ma:\n{\n  "titre": "string",\n  "sections": [{ "nom":"string", "contenu":"string" }],\n  "kpis": ["string"]\n}`,
            tone: `Ton & Style:\n- Ton: professionnel, clair, concis\n- Public: {{target_audience}}\n- Niveau: interm√©diaire √† avanc√©\n- Langue: fr-FR`,
            rubric: `Crit√®res d'√©valuation (0-5):\n- Clart√©\n- Exhaustivit√©\n- Exactitude\n- Actionnabilit√©\n- Format/Conformit√©`,
            safety: `Garde-fous:\n- Pas d'affirmations factuelles non sourc√©es\n- √âvite contenus sensibles/inappropri√©s\n- Si incertitude, demander pr√©cision √† l'utilisateur`
          }
        };
      }

      initStrategies() {
        // abbr -> { title, icon, content }
        return {
          cot: { title: 'Chain-of-Thought', icon: 'fa-diagram-project',
            content: `Objectif: R√©soudre en raisonnant par √©tapes.\nProc√©dure:\n- D√©compose le probl√®me.\n- Raisonne √©tape par √©tape (brefs interm√©diaires).\n- Conclus clairement.\nNote: privil√©gier concision et exactitude.` },
          thot: { title: 'Thread-of-Thought', icon: 'fa-comments',
            content: `Objectif: Maintenir un fil coh√©rent sur plusieurs tours.\nProc√©dure:\n- Rappelle le contexte utile.\n- Propose le prochain pas.\n- R√©sume p√©riodiquement les d√©cisions.` },
          ltm: { title: 'Least-to-Most', icon: 'fa-sort-amount-up',
            content: `Objectif: Aller du simple au complexe.\nProc√©dure:\n1) R√©soudre sous-probl√®mes faciles.\n2) Composer vers probl√®mes durs.\n3) Consolider en une solution globale.` },
          tot: { title: 'Tree-of-Thoughts', icon: 'fa-tree',
            content: `Objectif: Explorer plusieurs pistes.\nProc√©dure:\n- G√©n√®re 2-3 branches.\n- √âvalue avantages/inconv√©nients.\n- Choisis la meilleure et synth√©tise.` },
          got: { title: 'Graph-of-Thoughts', icon: 'fa-project-diagram',
            content: `Objectif: Relier des id√©es en graphe.\nProc√©dure:\n- Noeuds = id√©es cl√©s.\n- Ar√™tes = d√©pendances.\n- Parcours optimal -> r√©ponse.` },
          sc: { title: 'Self-Consistency', icon: 'fa-check-double',
            content: `Objectif: Robustesse.\nProc√©dure:\n- G√©n√©re 3+ r√©ponses.\n- Vote majoritaire pour la plus coh√©rente.` },
          cbp: { title: 'Complexity-Based Prompting', icon: 'fa-layer-group',
            content: `Objectif: Favoriser prompts √† cha√Ænes profondes.\nProc√©dure:\n- Inclure exemples complexes.\n- Forcer la justification multi-√©tapes.` },
          react: { title: 'ReAct', icon: 'fa-brain',
            content: `Objectif: Alterner Raisonnement/Action.\nBoucle:\n- Raisonnement (court)\n- Action (recherche, outil)\n- Observation\nR√©p√©ter jusqu'√† solution.` },
          rap: { title: 'Reasoning via Planning', icon: 'fa-chess-knight',
            content: `Objectif: Planifier (MCTS/plan).\nProc√©dure:\n- Mod√©liser √©tats et actions.\n- Simuler branches (co√ªt/b√©n√©fice).\n- Ex√©cuter le meilleur plan.` },
          pal: { title: 'Program-Aided (PAL)', icon: 'fa-terminal',
            content: `Objectif: Confier calculs √† un programme.\nProc√©dure:\n- D√©composer en sous-√©tapes.\n- D√©l√©guer calcul √† Python/outil.\n- Int√©grer r√©sultats.` },
          stepback: { title: 'Step-Back', icon: 'fa-arrow-rotate-left',
            content: `Objectif: Abstraction d‚Äôabord.\nProc√©dure:\n- Exprimer principes g√©n√©raux.\n- Appliquer aux d√©tails.\n- √âviter erreurs locales.` },
          ap: { title: 'Analogical Prompting', icon: 'fa-link',
            content: `Objectif: G√©n√©rer des analogies.\nProc√©dure:\n- Cr√©er exemple analogue pertinent.\n- Transf√©rer structure √† la cible.` },
          gkp: { title: 'Generated Knowledge', icon: 'fa-book-open',
            content: `Objectif: Rappeler connaissances.\nProc√©dure:\n- G√©n√©rer facts/definitions utiles.\n- Utiliser ces connaissances pour r√©pondre.` },
          s2a: { title: 'System 2 Attention', icon: 'fa-filter',
            content: `Objectif: Filtrer contexte.\nProc√©dure:\n- Retenir seulement infos pertinentes.\n- Ignorer distractions/biais.` },
          dsp: { title: 'Directional Stimulus', icon: 'fa-compass',
            content: `Objectif: Stimuli guid√©s.\nProc√©dure:\n- G√©n√©rer indices directionnels.\n- Orienter vers sortie d√©sir√©e.` },
          active: { title: 'Active Prompting', icon: 'fa-question',
            content: `Objectif: S√©lection active.\nProc√©dure:\n- Identifier incertitudes.\n- Poser questions cibl√©es.\n- Affiner le prompt.` },
          reflexion: { title: 'Reflexion Prompting', icon: 'fa-rotate',
            content: `Objectif: Auto-r√©vision.\nProc√©dure:\n- G√©n√©rer brouillon.\n- Critiquer et am√©liorer.\n- Livrer version r√©vis√©e.` },
          meta: { title: 'Meta-Prompting', icon: 'fa-infinity',
            content: `Objectif: Am√©liorer le prompt lui-m√™me.\nProc√©dure:\n- Analyser le prompt.\n- Proposer r√©√©criture.\n- It√©rer.` },
          bootstrap: { title: 'Bootstrap Prompting', icon: 'fa-seedling',
            content: `Objectif: Amor√ßage it√©ratif.\nProc√©dure:\n- G√©n√©rer -> corriger -> r√©g√©n√©rer.\n- R√©duire erreurs sans annotation.` },
          vae: { title: 'Verify-and-Edit', icon: 'fa-user-check',
            content: `Objectif: V√©rifier puis √©diter.\nProc√©dure:\n- √âtape 1: g√©n√©ration.\n- √âtape 2: v√©rification syst√©matique.\n- √âdits cibl√©s.` },
          recursive: { title: 'Recursive Prompting', icon: 'fa-rotate-left',
            content: `Objectif: Raffinements successifs.\nProc√©dure:\n- Fournir feedback s√©quentiel.\n- Am√©liorer √† chaque it√©ration.` },
          sot: { title: 'Skeleton-of-Thought', icon: 'fa-sitemap',
            content: `Objectif: G√©n√©rer d‚Äôabord un squelette.\nProc√©dure:\n- Lister points cl√©s.\n- D√©velopper chaque point en parall√®le.` },
          scratchpad: { title: 'Scratchpad', icon: 'fa-list-ul',
            content: `Objectif: Montrer le travail.\nProc√©dure:\n- Tenir un espace de calcul.\n- Consigner √©tapes interm√©diaires.` },
          chain: { title: 'Prompt Chaining', icon: 'fa-link',
            content: `Objectif: Cha√Æner des prompts.\nProc√©dure:\n- D√©composer en sous-prompts.\n- Faire circuler les sorties.` },
          persona: { title: 'Role/Persona', icon: 'fa-user-tie',
            content: `Objectif: Adopter un r√¥le.\nProc√©dure:\n- D√©finir expertise/ton.\n- Adapter style et contraintes.` },
          emotion: { title: 'Emotion Prompting', icon: 'fa-face-smile',
            content: `Objectif: Nuance √©motionnelle.\nProc√©dure:\n- Injecter signaux √©motionnels.\n- Rester appropri√© et utile.` },
          cont: { title: 'Contrastive', icon: 'fa-scale-balanced',
            content: `Objectif: Comparer options.\nProc√©dure:\n- G√©n√©rer alternatives.\n- Argumenter choix.` },
          mai: { title: 'Maieutic', icon: 'fa-comments',
            content: `Objectif: Socratique.\nProc√©dure:\n- Questionner pour faire √©merger.\n- Guidage structur√©.` },
          mmcot: { title: 'Multimodal CoT', icon: 'fa-image',
            content: `Objectif: Raisonnement multimodal.\nProc√©dure:\n- √âtapes: raisonner -> r√©pondre.\n- Int√©grer texte + vision.` }
        };
      }

      initPersonas() {
        return {
          none: '',
          seo: `Tu es un expert SEO senior (10+ ans). Tu ma√Ætrises audits techniques, strat√©gie de mots-cl√©s, maillage interne, E-E-A-T, et r√©daction optimis√©e.`,
          python: `Tu es un d√©veloppeur Python senior. Tu √©cris un code propre (PEP8), test√©, document√©. Tu anticipes les edge-cases et performances.`,
          pm: `Tu es Product Manager Data. Tu cadres des probl√®mes, d√©finis KPIs, priorises avec RICE, et communiques clairement aux stakeholders.`,
          legal: `Tu es juriste en contrats. Tu r√©diges des clauses claires, identifies les risques, assures conformit√© et s√©curit√© juridique.`,
          ux: `Tu es UX Writer. Tu privil√©gies la clart√©, concision, et coh√©rence. Tu fais des micro-copies accessibles et orient√©es action.`
        };
      }

      initLibrary() {
        return {
          marketing: {
            title: 'Assistant Marketing Digital',
            tags: ['Marketing','SEO'],
            prompt: `Cr√©er une strat√©gie de contenu compl√®te pour {{topic}} incluant calendrier √©ditorial, id√©es d'articles SEO et KPIs. Cible: {{target_audience}} dans l'industrie {{industry}}.`,
            sections: {
              System: `Tu es un expert en marketing digital focalis√© sur SEO et croissance organique.`,
              Context: `Produit: ...\nMarch√©: ...\nAudience: {{target_audience}}`,
              Instructions: `1) Analyse\n2) Strat√©gie\n3) Plan d'ex√©cution\n4) KPIs`,
              Constraints: `Langue: fr-FR\nFormat: sections claires\nLongueur: concis et actionnable`,
              Examples: ``
            }
          },
          python_review: {
            title: 'Code Review Assistant (Python)',
            tags: ['Code','Python'],
            prompt: `Passe en revue ce code Python et propose am√©liorations, complexit√©, s√©curit√©.`,
            sections: {
              System: `Tu es un d√©veloppeur Python senior.`,
              Context: `Projet: API web\nStack: FastAPI, Pydantic`,
              Instructions: `- V√©rifie PEP8\n- Identifie les edge cases\n- Propose des tests unitaires`,
              Constraints: `Pas de modifications destructives\nConcis`,
              Examples: ``
            }
          },
          social_posts: {
            title: 'G√©n√©rateur de Posts Sociaux',
            tags: ['Marketing','Cr√©atif'],
            prompt: `G√©n√®re 5 posts pour {{topic}} adapt√©s √† LinkedIn et X.`,
            sections: {
              System: `Tu es un copywriter cr√©atif.`,
              Context: `Brand voice: pro, accessible`,
              Instructions: `Inclure CTA, hashtags pertinents`,
              Constraints: `Max 280 caract√®res pour X`,
              Examples: ``
            }
          },
          translator: {
            title: 'Traducteur Technique',
            tags: ['Traduction','Tech'],
            prompt: `Traduire en fr-FR en gardant le jargon technique.`,
            sections: {
              System: `Tu es un traducteur technique exp√©riment√©.`,
              Context: `Domaine: cloud & DevOps`,
              Instructions: `Pr√©server la pr√©cision terminologique`,
              Constraints: `Format Markdown si pr√©sent`,
              Examples: ``
            }
          },
          sql_gen: {
            title: 'G√©n√©rateur de Requ√™tes SQL',
            tags: ['Code','SQL'],
            prompt: `Convertis la demande en SQL standard (PostgreSQL).`,
            sections: {
              System: `Tu es un expert SQL.`,
              Context: `Tables: users(id, name, created_at), orders(id, user_id, amount, created_at)`,
              Instructions: `V√©rifie les jointures et groupements`,
              Constraints: `Retourne uniquement la requ√™te`,
              Examples: ``
            }
          }
        };
      }

      sanitizeSections(nodes) {
        if (!Array.isArray(nodes)) return [];
        return nodes.map(node => ({
          ...node,
          children: this.sanitizeSections(node.children)
        }));
      }

      ensureThinkingSection() {
        // Trouve par fixedKey en priorit√©, sinon par nom
        let thinkingInfo = this.findNodeByFixedKey('thinking');
        if (!thinkingInfo) {
          const byName = this.state.sections.find(s => (s.name || '').toLowerCase() === 'thinking');
          if (byName) {
            byName.deletable = false;
            byName.fixedKey = 'thinking';
            return byName;
          }
        }
        if (!thinkingInfo) {
          const thinking = {
            id: this.uid(),
            name: 'thinking',
            icon: 'fa-brain',
            deletable: false,
            fixedKey: 'thinking',
            content: `Espace de raisonnement. Ajoutez des sous-sections abr√©g√©es (cot, tot, got, react, ...) via le menu Strat√©gies.`,
            children: []
          };
          // placer juste apr√®s System si possible
          const sysIdx = this.state.sections.findIndex(s => (s.name || '').toLowerCase() === 'system');
          if (sysIdx >= 0) this.state.sections.splice(sysIdx + 1, 0, thinking);
          else this.state.sections.unshift(thinking);
          return thinking;
        }
        return thinkingInfo.node;
      }

      loadFromStorage() {
        const saved = localStorage.getItem('promptStudioV2');
        if (!saved) return;
        try {
          const data = JSON.parse(saved);
          Object.assign(this.state, {
            prompts: data.prompts || [],
            currentPrompt: data.currentPrompt || this.state.currentPrompt,
            settings: { ...this.state.settings, ...(data.settings || {}) },
            variableValues: data.variableValues || {},
            isDarkMode: typeof data.isDarkMode === 'boolean' ? data.isDarkMode : this.state.isDarkMode,
            sections: this.sanitizeSections(data.sections) || [],
            activeSectionId: data.activeSectionId || null,
            history: Array.isArray(data.history) ? data.history : [],
            apiUsage: data.apiUsage || this.state.apiUsage
          });
        } catch (e) { console.warn('Load error', e); }
      }

      saveToStorage() {
        try {
          const payload = {
            prompts: this.state.prompts,
            currentPrompt: this.state.currentPrompt,
            settings: this.state.settings,
            variableValues: this.state.variableValues,
            isDarkMode: this.state.isDarkMode,
            sections: this.state.sections,
            activeSectionId: this.state.activeSectionId,
            history: this.state.history,
            apiUsage: this.state.apiUsage
          };
          localStorage.setItem('promptStudioV2', JSON.stringify(payload));
        } catch (e) { console.warn('Save error', e); }
      }

      setupEventListeners() {
        // Header dropdowns
        document.getElementById('settingsDropdown')?.addEventListener('click', (e) => e.currentTarget.classList.toggle('active'));
        document.addEventListener('click', (e) => {
          const dd = document.getElementById('settingsDropdown');
          if (dd && !dd.contains(e.target)) dd.classList.remove('active');
          const sd = document.getElementById('sectionsDropdown');
          if (sd && !sd.contains(e.target)) sd.classList.remove('active');
          const st = document.getElementById('strategyDropdown');
          if (st && !st.contains(e.target)) st.classList.remove('active');
        });
        document.getElementById('toggleThemeBtn')?.addEventListener('click', () => this.toggleTheme());
        document.getElementById('keyboardHelp')?.addEventListener('click', () => {
          this.showToast('Raccourcis: Ctrl/Cmd+S (Sauver) ‚Ä¢ Ctrl/Cmd+Enter (Tester) ‚Ä¢ Ctrl/Cmd+K (Palette de commandes)', 'info');
        });
        document.getElementById('aboutBtn')?.addEventListener('click', () => {
          this.showToast('LLM Prompt Studio Pro ‚Äî Monofichier HTML. Simulation sans appel API.', 'info');
        });

        // Project actions
        document.getElementById('newProjectBtn')?.addEventListener('click', () => this.createProject());
        document.getElementById('projectSelect')?.addEventListener('change', (e) => {
          this.showToast(`Projet actif: ${e.target.value}`, 'info');
        });

        // Run prompt buttons
        document.getElementById('runPromptBtn')?.addEventListener('click', () => this.testPrompt());
        // runPromptBtn2 removed from Quick Actions to reduce duplication

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
          if (e.ctrlKey || e.metaKey) {
            if (e.key.toLowerCase() === 's') { e.preventDefault(); this.savePrompt(); }
            if (e.key.toLowerCase() === 'enter') { e.preventDefault(); this.testPrompt(); }
            if (e.key.toLowerCase() === 'k') { e.preventDefault(); this.openCommandPalette(); }
          }
        });

        // Toolbar
        document.querySelectorAll('.toolbar-btn[data-cmd]').forEach(btn => {
          btn.addEventListener('click', () => this.wrapSelection(btn.dataset.cmd));
        });
        document.querySelectorAll('.toolbar-btn[data-insert]').forEach(btn => {
          btn.addEventListener('click', () => this.insertAtCursor(btn.dataset.insert));
        });
        document.getElementById('strategyDropdown')?.addEventListener('click', (e) => {
          e.currentTarget.classList.toggle('active');
        });
        // Strat√©gies: d√©l√©gation de clic
        document.getElementById('strategyMenu')?.addEventListener('click', (e) => {
          const item = e.target.closest('.dropdown-item[data-strategy]');
          if (!item) return;
          const key = item.getAttribute('data-strategy');
          this.addStrategySection(key);
          this.showToast(`Strat√©gie ajout√©e: <${key}>`, 'success');
        });

        document.getElementById('addVariableBtn')?.addEventListener('click', () => this.addNewVariable());
        document.getElementById('addTemplateBtn')?.addEventListener('click', () => this.openAddSectionModal());
        
        // Copy and streaming simulation
        document.getElementById('copyPreviewBtn')?.addEventListener('click', () => this.copyToClipboard());
        // Simulation streaming supprim√©e (bouton retir√©)
        document.getElementById('optimizeAllBtn')?.addEventListener('click', () => this.openOptimization(true));
        // optimizeAllBtn2 removed to avoid duplication; use preview Optimize Tout
        document.getElementById('optimizeBtn')?.addEventListener('click', () => this.openOptimization(false));

        // Text changes
        document.getElementById('prompt-textarea')?.addEventListener('input', () => { this.detectAndRenderVariables(); this.updatePreview(); this.updateStats(); this.refreshRunButtons(); this.saveToStorage(); });
        document.getElementById('section-textarea')?.addEventListener('input', (e) => {
          const s = this.findNodeById(this.state.activeSectionId);
          if (!s) return;
          s.node.content = e.target.value;
          this.detectAndRenderVariables(); this.updatePreview(); this.updateStats(); this.refreshRunButtons(); this.saveToStorage();
        });

        // Section props handlers
        document.getElementById('sectionNameInput')?.addEventListener('input', (e) => {
          const s = this.findNodeById(this.state.activeSectionId);
          if (!s) return;
          s.node.name = (e.target.value || '').trim();
          this.renderSections(); this.updatePreview(); this.saveToStorage();
        });
        document.getElementById('sectionIconSelect')?.addEventListener('change', (e) => {
          const s = this.findNodeById(this.state.activeSectionId);
          if (!s) return;
          s.node.icon = e.target.value;
          this.renderSections(); this.saveToStorage();
        });
        document.getElementById('duplicateSectionBtn')?.addEventListener('click', () => this.duplicateSection(this.state.activeSectionId));
        document.getElementById('deleteSectionBtn')?.addEventListener('click', () => this.deleteSection(this.state.activeSectionId));
        document.getElementById('moveUpBtn')?.addEventListener('click', () => this.moveSectionUp(this.state.activeSectionId));
        document.getElementById('moveDownBtn')?.addEventListener('click', () => this.moveSectionDown(this.state.activeSectionId));

        // Sections
        document.getElementById('addSectionBtn')?.addEventListener('click', () => this.openAddSectionModal());
        document.querySelectorAll('[data-close-modal]').forEach(btn => btn.addEventListener('click', (e) => {
          const sel = e.currentTarget.getAttribute('data-close-modal');
          document.querySelector(sel)?.classList.remove('active');
        }));
        document.getElementById('newSectionTemplate')?.addEventListener('change', (e) => {
          const content = this.getTemplateContent(e.target.value);
          const area = document.getElementById('newSectionContent');
          if (area && content) area.value = content;
        });
        document.getElementById('confirmAddSection')?.addEventListener('click', () => this.confirmAddSection());
        document.getElementById('sectionsDropdown')?.addEventListener('click', (e) => {
          e.currentTarget.classList.toggle('active');
        });

        document.getElementById('resetDefaultSections')?.addEventListener('click', () => {
          if (confirm('Restaurer les sections par d√©faut ?')) {
            this.resetDefaultSections(); this.renderSections(); this.detectAndRenderVariables(); this.updatePreview(); this.refreshRunButtons(); this.saveToStorage();
            this.showToast('Sections par d√©faut restaur√©es', 'success');
          }
        });
        document.getElementById('exportSections')?.addEventListener('click', () => this.exportSections());
        document.getElementById('importSections')?.addEventListener('click', () => this.importSections());

        // Variables
        document.getElementById('add-variable-btn')?.addEventListener('click', () => this.addNewVariable());

        // Library view toggle
        document.getElementById('listViewBtn')?.addEventListener('click', () => this.toggleLibraryView('list'));
        document.getElementById('gridViewBtn')?.addEventListener('click', () => this.toggleLibraryView('grid'));
        document.getElementById('searchInput')?.addEventListener('input', () => this.filterLibrary());
        document.querySelectorAll('.tag-chip').forEach(tag => tag.addEventListener('click', (e) => this.filterByTag(e.currentTarget)));
        this.bindLibraryClicks();

        // Components insert
        document.querySelectorAll('.component-chip').forEach(c => {
          c.addEventListener('click', () => this.insertComponent(c.dataset.component));
        });

        // Results panel
        document.getElementById('clearResultsBtn')?.addEventListener('click', () => { document.getElementById('runOutput').textContent = ''; });
        document.getElementById('stopStreamBtn')?.addEventListener('click', () => this.stopStreaming(document.getElementById('runOutput')));

        // History
        document.getElementById('saveVersionBtn')?.addEventListener('click', () => this.saveVersion());
        document.getElementById('compareABOpen')?.addEventListener('click', () => this.openAB());

        // AB actions
        document.getElementById('closeAB')?.addEventListener('click', () => this.closeAB());
        document.getElementById('loadFromEditorA')?.addEventListener('click', () => { document.getElementById('abA').value = this.buildFullPrompt(); });
        document.getElementById('loadFromEditorB')?.addEventListener('click', () => { document.getElementById('abB').value = this.buildFullPrompt(); });
        document.getElementById('runAB')?.addEventListener('click', () => this.runAB());
        document.getElementById('scoreAB')?.addEventListener('click', () => this.scoreAB());

        // Chat mode
        document.getElementById('modeEditorBtn')?.addEventListener('click', () => this.switchMode('editor'));
        document.getElementById('modeChatBtn')?.addEventListener('click', () => this.switchMode('chat'));
        document.getElementById('sendChatBtn')?.addEventListener('click', () => this.sendChat());
        document.getElementById('chatInput')?.addEventListener('keydown', (e) => { if (e.key === 'Enter') this.sendChat(); });
        document.getElementById('resetChatBtn')?.addEventListener('click', () => this.resetChat());

        // Persona
        document.getElementById('applyPersonaBtn')?.addEventListener('click', () => this.applyPersona());

        // Batch tests
        document.getElementById('openBatchBtn')?.addEventListener('click', () => this.openBatch());
        document.getElementById('openCmdPaletteBtn')?.addEventListener('click', () => this.openCommandPalette());
        document.getElementById('batchRule')?.addEventListener('change', (e) => {
          document.getElementById('batchKeywordWrap').style.display = e.target.value === 'keyword' ? 'block' : 'none';
        });
        document.getElementById('runBatchBtn')?.addEventListener('click', () => this.runBatch());

        // Optimize modal
        document.getElementById('applyOptimization')?.addEventListener('click', () => this.applyOptimization());

        // Header project-level actions
        document.getElementById('newPromptBtn')?.addEventListener('click', () => this.resetEditor());
        document.getElementById('exportProjectBtn')?.addEventListener('click', () => this.exportProject());
        document.getElementById('importProjectBtn')?.addEventListener('click', () => this.importProject());
        document.getElementById('shareBtn')?.addEventListener('click', () => this.shareProject());

        // Model select
        document.getElementById('modelSelect')?.addEventListener('change', (e) => {
          this.state.settings.model = e.target.value;
          this.saveToStorage();
        });

        // Options toggles reflect in header badge
        document.getElementById('optAutosave')?.addEventListener('change', (e) => this.refreshAutosaveBadge(e.target.checked));
      }

      initializeUI() {
        if (this.state.isDarkMode) document.body.setAttribute('data-theme', 'dark');
        this.renderSections();
        this.renderHistory();
        this.renderStrategyMenu();
        this.detectAndRenderVariables();
        this.updatePreview();
        this.updateStats();
        this.refreshRunButtons();
        this.updateApiUsageBars();
        this.refreshAutosaveBadge(this.state.settings.autoSave);
      }

      renderStrategyMenu() {
        const menu = document.getElementById('strategyMenu');
        if (!menu) return;
        menu.innerHTML = '';
        const order = Object.keys(this.strategies); // already a good spread
        order.forEach(key => {
          const it = this.strategies[key];
          const div = document.createElement('div');
          div.className = 'dropdown-item';
          div.setAttribute('data-strategy', key);
          div.innerHTML = `<i class="fas ${it.icon}"></i> <strong>${key}</strong> ‚Äî ${this.escape(it.title)}`;
          menu.appendChild(div);
        });
      }

      // ===================================================================
      // LOGIQUE DE GESTION DES SECTIONS (HI√âRARCHIQUE)
      // ===================================================================

      resetDefaultSections() {
        this.state.sections = [
          { id: this.uid(), name: 'system', icon: 'fa-shield-halved', deletable: false, content: 'Tu es un assistant expert...', children: [] },
          { id: this.uid(), name: 'thinking', icon: 'fa-brain', deletable: false, fixedKey: 'thinking', content: 'Espace de raisonnement. Ajoutez des strat√©gies via le menu.', children: [] },
          { id: this.uid(), name: 'context', icon: 'fa-layer-group', deletable: true, content: '', children: [] },
          { id: this.uid(), name: 'instructions', icon: 'fa-list-check', deletable: true, content: '', children: [] },
          { id: this.uid(), name: 'constraints', icon: 'fa-ban', deletable: true, content: '', children: [] },
          { id: this.uid(), name: 'examples', icon: 'fa-lightbulb', deletable: true, content: '', children: [] }
        ];
        this.state.activeSectionId = this.state.sections[0]?.id || null;
        this.saveToStorage();
      }

      renderSections() {
        const container = document.getElementById('sectionsContainer');
        container.innerHTML = '';
        this.state.sections.forEach(section => this.renderSectionNode(section, container, 0));
        this.renderActiveSectionContent();
      }

      renderSectionNode(section, parentElement, level) {
        const item = document.createElement('div');
        item.className = 'section-item';
        item.dataset.sectionId = section.id;
        item.draggable = true;
        item.style.paddingLeft = `${0.75 + level * 1.5}rem`;
        if (section.id === this.state.activeSectionId) {
            item.classList.add('active');
        }

        item.innerHTML = `
            <span class="drag-handle"><i class="fas fa-grip-vertical"></i></span>
            <i class="fas ${section.icon || 'fa-layer-group'}"></i>
            <span class="section-label">${this.escape(section.name)}</span>
            ${section.deletable !== false ? '<span class="close-section" title="Supprimer"><i class="fas fa-times"></i></span>' : ''}
        `;

        item.addEventListener('dragstart', e => {
            e.stopPropagation();
            e.dataTransfer.setData('text/plain', section.id);
            e.currentTarget.classList.add('dragging');
        });
        item.addEventListener('dragend', e => e.currentTarget.classList.remove('dragging'));
        
        item.addEventListener('dragover', e => {
            e.preventDefault();
            e.stopPropagation();
            const rect = item.getBoundingClientRect();
            const offset = e.clientY - rect.top;
            const height = rect.height;
            document.querySelectorAll('.section-item').forEach(el => el.classList.remove('drop-feedback-top', 'drop-feedback-bottom', 'drop-feedback-nest'));
            if (offset < height * 0.25) item.classList.add('drop-feedback-top');
            else if (offset > height * 0.75) item.classList.add('drop-feedback-bottom');
            else item.classList.add('drop-feedback-nest');
        });

        item.addEventListener('dragleave', () => {
            item.classList.remove('drop-feedback-top', 'drop-feedback-bottom', 'drop-feedback-nest');
        });

        item.addEventListener('drop', e => {
            e.preventDefault();
            e.stopPropagation();
            item.classList.remove('drop-feedback-top', 'drop-feedback-bottom', 'drop-feedback-nest');
            
            const draggedId = e.dataTransfer.getData('text/plain');
            const targetId = section.id;
            if (draggedId === targetId) return;

            const rect = item.getBoundingClientRect();
            const offset = e.clientY - rect.top;
            const height = rect.height;

            let mode;
            if (offset < height * 0.25) mode = 'before';
            else if (offset > height * 0.75) mode = 'after';
            else mode = 'nest';

            this.moveSection(draggedId, targetId, mode);
        });

        item.addEventListener('click', (e) => {
            if (e.target.closest('.close-section')) return;
            this.setActiveSection(section.id);
        });
        item.querySelector('.close-section')?.addEventListener('click', (e) => {
            e.stopPropagation();
            this.deleteSection(section.id);
        });

        parentElement.appendChild(item);

        if (section.children && section.children.length > 0) {
            section.children.forEach(child => this.renderSectionNode(child, parentElement, level + 1));
        }
      }
      
      findNodeAndParent(id, tree = this.state.sections, parent = null) {
        for (const node of tree) {
            if (node.id === id) return { node, parent };
            if (node.children && node.children.length > 0) {
                const found = this.findNodeAndParent(id, node.children, node);
                if (found) return found;
            }
        }
        return null;
      }

      findNodeByFixedKey(fixedKey, tree = this.state.sections, parent = null) {
        for (const node of tree) {
          if (node.fixedKey === fixedKey) return { node, parent };
          if (node.children && node.children.length) {
            const res = this.findNodeByFixedKey(fixedKey, node.children, node);
            if (res) return res;
          }
        }
        return null;
      }

      findNodeById(id, tree = this.state.sections, parent = null) {
        if (!id) return null;
        for (const node of tree) {
          if (node.id === id) return { node, parent };
          if (node.children && node.children.length) {
            const r = this.findNodeById(id, node.children, node);
            if (r) return r;
          }
        }
        return null;
      }

      isDescendant(node, potentialParent) {
        if (!potentialParent.children) return false;
        if (potentialParent.children.some(child => child.id === node.id)) return true;
        for (const child of potentialParent.children) {
            if (this.isDescendant(node, child)) return true;
        }
        return false;
      }

      moveSection(draggedId, targetId, mode) {
        const draggedInfo = this.findNodeAndParent(draggedId);
        const targetInfo = this.findNodeAndParent(targetId);

        if (!draggedInfo || !targetInfo) return;

        if (mode === 'nest' && (draggedInfo.node.id === targetInfo.node.id || this.isDescendant(targetInfo.node, draggedInfo.node))) {
            this.showToast("Impossible d'imbriquer un √©l√©ment dans lui-m√™me.", "error");
            return;
        }

        const sourceArray = draggedInfo.parent ? draggedInfo.parent.children : this.state.sections;
        const draggedIndex = sourceArray.findIndex(n => n.id === draggedId);
        const [draggedNode] = sourceArray.splice(draggedIndex, 1);

        if (mode === 'nest') {
            targetInfo.node.children = targetInfo.node.children || [];
            targetInfo.node.children.push(draggedNode);
        } else {
            const destArray = targetInfo.parent ? targetInfo.parent.children : this.state.sections;
            const targetIndex = destArray.findIndex(n => n.id === targetId);
            if (mode === 'before') {
                destArray.splice(targetIndex, 0, draggedNode);
            } else { // 'after'
                destArray.splice(targetIndex + 1, 0, draggedNode);
            }
        }

        this.renderSections();
        this.updatePreview();
        this.saveToStorage();
      }

      setActiveSection(id) {
        this.state.activeSectionId = id;
        this.renderSections();
      }

      renderActiveSectionContent() {
        const sectionInfo = this.findNodeById(this.state.activeSectionId);
        const label = document.getElementById('sectionEditorLabel');
        const area = document.getElementById('section-textarea');
        const props = document.getElementById('sectionProps');
        const nameInput = document.getElementById('sectionNameInput');
        const iconSelect = document.getElementById('sectionIconSelect');
        const delBtn = document.getElementById('deleteSectionBtn');
        const dupBtn = document.getElementById('duplicateSectionBtn');

        if (sectionInfo && label && area) {
          label.textContent = `Contenu de la section: ${sectionInfo.node.name}`;
          area.value = sectionInfo.node.content || '';
          area.disabled = false;
          props.style.display = 'grid';
          nameInput.value = sectionInfo.node.name || '';
          iconSelect.value = sectionInfo.node.icon || 'fa-layer-group';
          delBtn.disabled = (sectionInfo.node.deletable === false);
          dupBtn.disabled = !!sectionInfo.node.fixedKey; // √©viter duplication de "thinking"
        } else if (area) {
          label.textContent = 'Contenu de la section';
          area.value = '';
          area.placeholder = 'S√©lectionnez une section pour l\'√©diter...';
          area.disabled = true;
          props.style.display = 'none';
        }
      }

      confirmAddSection() {
        const name = (document.getElementById('newSectionName').value || '').trim();
        const icon = document.getElementById('newSectionIcon').value || 'fa-layer-group';
        const templKey = document.getElementById('newSectionTemplate').value || '';
        let content = document.getElementById('newSectionContent').value || '';
        if (!content && templKey) content = this.getTemplateContent(templKey);
        if (!name) { this.showToast('Veuillez entrer un nom de section', 'warning'); return; }
        
        const newSec = { id: this.uid(), name, icon, deletable: true, content, children: [] };
        
        this.state.sections.push(newSec);
        this.state.activeSectionId = newSec.id;
        document.getElementById('addSectionModal').classList.remove('active');
        this.renderSections();
        this.detectAndRenderVariables();
        this.updatePreview();
        this.refreshRunButtons();
        this.saveToStorage();
        this.showToast(`Section "${name}" ajout√©e`, 'success');
      }

      deleteSection(id) {
        const info = this.findNodeAndParent(id);
        if (!info) return;
        if (info.node.deletable === false) { this.showToast('Cette section ne peut pas √™tre supprim√©e', 'warning'); return; }
        if (!confirm(`Supprimer la section "${info.node.name}" et tous ses enfants ?`)) return;

        const parentArray = info.parent ? info.parent.children : this.state.sections;
        const index = parentArray.findIndex(n => n.id === id);
        parentArray.splice(index, 1);

        if (this.state.activeSectionId === id) {
            this.state.activeSectionId = this.state.sections[0]?.id || null;
        }
        
        this.renderSections();
        this.detectAndRenderVariables();
        this.updatePreview();
        this.refreshRunButtons();
        this.saveToStorage();
        this.showToast(`Section "${info.node.name}" supprim√©e`, 'success');
      }

      duplicateSection(id) {
        const info = this.findNodeAndParent(id);
        if (!info) return;
        if (info.node.fixedKey) { this.showToast('Cette section ne peut pas √™tre dupliqu√©e', 'warning'); return; }
        const clone = JSON.parse(JSON.stringify(info.node));
        const assignIds = (node) => { node.id = this.uid(); (node.children||[]).forEach(assignIds); };
        assignIds(clone);
        const arr = info.parent ? info.parent.children : this.state.sections;
        const idx = arr.findIndex(n => n.id === id);
        arr.splice(idx + 1, 0, clone);
        this.state.activeSectionId = clone.id;
        this.renderSections(); this.updatePreview(); this.saveToStorage();
        this.showToast('Section dupliqu√©e', 'success');
      }

      moveSectionUp(id) {
        const info = this.findNodeAndParent(id);
        if (!info) return;
        const arr = info.parent ? info.parent.children : this.state.sections;
        const idx = arr.findIndex(n => n.id === id);
        if (idx <= 0) return;
        const [item] = arr.splice(idx, 1);
        arr.splice(idx - 1, 0, item);
        this.renderSections(); this.updatePreview(); this.saveToStorage();
      }
      moveSectionDown(id) {
        const info = this.findNodeAndParent(id);
        if (!info) return;
        const arr = info.parent ? info.parent.children : this.state.sections;
        const idx = arr.findIndex(n => n.id === id);
        if (idx < 0 || idx >= arr.length - 1) return;
        const [item] = arr.splice(idx, 1);
        arr.splice(idx + 1, 0, item);
        this.renderSections(); this.updatePreview(); this.saveToStorage();
      }

      openAddSectionModal() {
        document.getElementById('newSectionName').value = '';
        document.getElementById('newSectionIcon').value = 'fa-layer-group';
        document.getElementById('newSectionTemplate').value = '';
        document.getElementById('newSectionContent').value = '';
        document.getElementById('addSectionModal').classList.add('active');
      }

      getTemplateContent(key) { return this.templates.sections[key] || ''; }

      exportSections() {
        const data = JSON.stringify(this.state.sections, null, 2);
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'sections.json'; a.click();
        URL.revokeObjectURL(url);
        this.showToast('Sections export√©es', 'success');
      }

      importSections() {
        const input = document.createElement('input');
        input.type = 'file'; input.accept = 'application/json';
        input.onchange = async (e) => {
          const file = e.target.files[0];
          if (!file) return;
          try {
            const text = await file.text();
            const json = JSON.parse(text);
            if (!Array.isArray(json)) throw new Error('Format invalide');
            this.state.sections = this.sanitizeSections(json);
            this.ensureThinkingSection();
            this.state.activeSectionId = this.state.sections[0]?.id || null;
            this.renderSections(); this.detectAndRenderVariables(); this.updatePreview(); this.refreshRunButtons(); this.saveToStorage();
            this.showToast('Sections import√©es', 'success');
          } catch (err) { console.error(err); this.showToast('√âchec de l\'import', 'error'); }
        };
        input.click();
      }

      addStrategySection(key) {
        const strat = this.strategies[key];
        if (!strat) { this.showToast('Strat√©gie inconnue', 'error'); return; }
        const thinking = this.ensureThinkingSection();

        // V√©rifie si une section enfant du m√™me nom existe
        const existing = (thinking.children || []).find(ch => (ch.name || '').toLowerCase() === key.toLowerCase());
        if (existing) {
          if (confirm(`La strat√©gie <${key}> existe d√©j√†. Voulez-vous en cr√©er une copie ?`)) {
            const clone = { id: this.uid(), name: key, icon: strat.icon, deletable: true, content: strat.content, children: [] };
            thinking.children.push(clone);
            this.state.activeSectionId = clone.id;
          } else {
            this.state.activeSectionId = existing.id;
          }
        } else {
          const node = { id: this.uid(), name: key, icon: strat.icon, deletable: true, content: strat.content, children: [] };
          thinking.children = thinking.children || [];
          thinking.children.push(node);
          this.state.activeSectionId = node.id;
        }
        this.renderSections();
        this.renderActiveSectionContent();
        this.updatePreview();
        this.refreshRunButtons();
        this.saveToStorage();
      }

      // Variables
      addNewVariable() {
        const name = prompt("Nom de la nouvelle variable (sans les accolades) :", "ma_variable");
        if (name && name.trim() !== "") {
          const sanitizedName = name.trim().replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
          if (sanitizedName) {
            const variable = `{{${sanitizedName}}}`;
            this.insertVariable(variable);
          } else { alert("Nom de variable invalide."); }
        }
      }

      detectAndRenderVariables() {
        const promptText = document.getElementById('prompt-textarea')?.value || '';
        let sectionsText = '';
        const traverse = (nodes) => {
            for (const node of nodes) {
                sectionsText += (node.content || '') + ' ';
                if (node.children) traverse(node.children);
            }
        };
        traverse(this.state.sections);
        const fullText = sectionsText + promptText;

        const regex = /{{\s*([a-zA-Z0-9_]+)\s*}}/g;
        const matches = fullText.matchAll(regex);
        const uniqueVars = new Set(Array.from(matches, match => match[1]));

        const chipsContainer = document.getElementById('variable-chips-container');
        const addButton = document.getElementById('add-variable-btn');
        chipsContainer.innerHTML = '';
        uniqueVars.forEach(varName => {
          const chip = document.createElement('span');
          chip.className = 'variable-chip';
          chip.dataset.variable = `{{${varName}}}`;
          chip.innerHTML = `<i class="fas fa-tag"></i> {{${varName}}}`;
          chipsContainer.appendChild(chip);
        });
        chipsContainer.appendChild(addButton);

        const inputsContainer = document.getElementById('variable-inputs-container');
        inputsContainer.innerHTML = '';
        if (uniqueVars.size === 0) {
          inputsContainer.innerHTML = '<p class="text-muted" style="font-size: 0.875rem; text-align: center;">Aucune variable d√©tect√©e.</p>';
        } else {
          uniqueVars.forEach(varName => {
            const formGroup = document.createElement('div');
            formGroup.className = 'form-group';
            const label = document.createElement('label');
            label.className = 'form-label';
            label.textContent = varName;
            const input = document.createElement('input');
            input.type = 'text'; input.className = 'form-input';
            input.placeholder = `Valeur pour {{${varName}}}`; input.dataset.variableName = varName;
            input.value = this.state.variableValues[varName] || '';
            input.addEventListener('input', (e) => {
              this.state.variableValues[varName] = e.target.value;
              this.updatePreview(); this.updateStats(); this.refreshRunButtons(); this.saveToStorage();
            });
            formGroup.appendChild(label); formGroup.appendChild(input);
            inputsContainer.appendChild(formGroup);
          });
        }

        document.getElementById('variable-chips-container').onclick = (e) => {
          const chip = e.target.closest('.variable-chip[data-variable]');
          if (chip) this.insertVariable(chip.dataset.variable);
        };
      }

      insertVariable(variable) {
        const activeTextarea = document.activeElement.tagName === 'TEXTAREA' ? document.activeElement : document.getElementById('section-textarea');
        if (activeTextarea && !activeTextarea.disabled) {
          const start = activeTextarea.selectionStart || activeTextarea.value.length;
          const end = activeTextarea.selectionEnd || activeTextarea.value.length;
          const text = activeTextarea.value;
          activeTextarea.value = text.substring(0, start) + variable + text.substring(end);
          activeTextarea.selectionStart = activeTextarea.selectionEnd = start + variable.length;
          activeTextarea.focus();
          activeTextarea.dispatchEvent(new Event('input', { bubbles: true }));
        }
      }

      // Editor helpers
      wrapSelection(marker) {
        const el = document.activeElement.tagName === 'TEXTAREA' ? document.activeElement : document.getElementById('prompt-textarea');
        if (!el || el.disabled) return;
        const start = el.selectionStart ?? 0; const end = el.selectionEnd ?? 0;
        const before = el.value.slice(0, start);
        const sel = el.value.slice(start, end);
        const after = el.value.slice(end);
        el.value = before + marker + sel + marker + after;
        el.selectionStart = start + marker.length; el.selectionEnd = end + marker.length;
        el.dispatchEvent(new Event('input', { bubbles: true }));
      }
      insertAtCursor(text) {
        const el = document.activeElement.tagName === 'TEXTAREA' ? document.activeElement : document.getElementById('prompt-textarea');
        if (!el || el.disabled) return;
        const start = el.selectionStart ?? el.value.length; const end = el.selectionEnd ?? el.value.length;
        el.value = el.value.substring(0, start) + text + el.value.substring(end);
        el.selectionStart = el.selectionEnd = start + text.length;
        el.dispatchEvent(new Event('input', { bubbles: true }));
      }

      // Preview
      replacer(text) {
        let out = text || '';
        for (const [varName, varValue] of Object.entries(this.state.variableValues)) {
          const rx = new RegExp(`{{\\s*${varName}\\s*}}`, 'g');
          const replacement = varValue || `{{${varName}}}`;
          out = out.replace(rx, replacement);
        }
        return out;
      }

      escapeHtml(text) { const div = document.createElement('div'); div.textContent = text || ''; return div.innerHTML; }

      updatePreview() {
        const previewContent = document.getElementById('previewContent');
        if (!previewContent) return;

        const renderVars = (txt) => this.escapeHtml(txt).replace(/{{\s*([a-zA-Z0-9_]+)\s*}}/g, (m, v) => `<span class="var-miss" data-var="${this.escape(v)}" title="Cliquer pour remplir">${this.escapeHtml(m)}</span>`);
        
        const buildPreviewRecursive = (nodes, indent = '') => {
            let html = '';
            for (const node of nodes) {
                if (!node.content && (!node.children || node.children.length === 0)) continue;
                
                const tagName = (node.name || '').toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_-]/g, '');
                html += `${indent}<strong>&lt;${tagName}&gt;</strong>\n`;
                if (node.content) {
                    html += `${indent}  ` + renderVars(this.replacer(node.content)).replace(/\n/g, `\n${indent}  `) + '\n';
                }
                if (node.children && node.children.length > 0) {
                    html += buildPreviewRecursive(node.children, indent + '  ');
                }
                html += `${indent}<strong>&lt;/${tagName}&gt;</strong>\n\n`;
            }
            return html;
        };

        let content = buildPreviewRecursive(this.state.sections);
        
        const userPrompt = this.replacer(document.getElementById('prompt-textarea')?.value || '');
        if (userPrompt.trim()) {
          content += `<strong>&lt;user&gt;</strong>\n${renderVars(userPrompt)}\n<strong>&lt;/user&gt;</strong>`;
        }
        
        previewContent.innerHTML = content.trim() || 'Aper√ßu vide...';

        previewContent.querySelectorAll('.var-miss').forEach(span => {
          span.addEventListener('click', () => {
            const name = span.getAttribute('data-var');
            const rightInput = Array.from(document.querySelectorAll('#variable-inputs-container input')).find(i => i.dataset.variableName === name);
            if (rightInput) { rightInput.focus(); rightInput.classList.add('shake'); setTimeout(()=>rightInput.classList.remove('shake'), 500); }
          });
        });

        this.updateTokenEstimate();
      }

      buildFullPrompt() {
        const buildPromptRecursive = (nodes, indent = '') => {
            let text = '';
            for (const node of nodes) {
                if (!node.content && (!node.children || node.children.length === 0)) continue;

                const tagName = (node.name || '').toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_-]/g, '');
                text += `${indent}<${tagName}>\n`;
                if (node.content) {
                    text += `${indent}  ` + this.replacer(node.content).replace(/\n/g, `\n${indent}  `) + '\n';
                }
                if (node.children && node.children.length > 0) {
                    text += buildPromptRecursive(node.children, indent + '  ');
                }
                text += `${indent}</${tagName}>\n\n`;
            }
            return text;
        };

        let fullPrompt = buildPromptRecursive(this.state.sections);
        
        const user = this.replacer(document.getElementById('prompt-textarea')?.value || '');
        if (user.trim()) {
            fullPrompt += `<user>\n${user}\n</user>`;
        }
        return fullPrompt.trim();
      }

      // Token estimate
      approxTokens(str) {
        if (!str) return 0;
        const byChars = Math.ceil(str.length / 4);
        const byWords = Math.ceil((str.split(/\s+/).length) * 1.3);
        return Math.round((byChars + byWords) / 2);
      }
      updateTokenEstimate() {
        const full = this.buildFullPrompt();
        const tok = this.approxTokens(full);
        document.getElementById('tokenEstimate').textContent = `~${tok} tok`;
        document.getElementById('statTokens').innerHTML = `Tokens estim√©s: <strong>${tok}</strong>`;
      }

      updateStats() {
        const full = this.buildFullPrompt();
        const tok = this.approxTokens(full);
        const complexity = tok < 300 ? 'Faible' : tok < 1200 ? 'Moyenne' : '√âlev√©e';
        const missingVars = (full.match(/{{\s*([a-zA-Z0-9_]+)\s*}}/g) || []).length;
        const quality = Math.max(0, 100 - Math.floor(missingVars * 10) - Math.floor(tok / 1000 * 10));
        document.getElementById('statComplexity').innerHTML = `Complexit√©: <strong>${complexity}</strong>`;
        document.getElementById('statQuality').innerHTML = `Score qualit√©: <strong>${quality}/100</strong>`;
        const valList = document.getElementById('validationList');
        valList.innerHTML = `
          <li><i class="fas fa-check" style="color: var(--success);"></i> Structure correcte</li>
          <li><i class="fas ${missingVars ? 'fa-exclamation' : 'fa-check'}" style="color: ${missingVars ? 'var(--warning)' : 'var(--success)'};"></i> ${missingVars ? 'Variables manquantes' : 'Variables d√©finies'}</li>
          <li><i class="fas ${tok > 3000 ? 'fa-exclamation' : 'fa-check'}" style="color: ${tok > 3000 ? 'var(--warning)' : 'var(--success)'};"></i> Longueur ${tok > 3000 ? '√©lev√©e' : 'optimale'}</li>
        `;
      }

      refreshRunButtons() {
        const full = this.buildFullPrompt();
        const missingVars = (full.match(/{{\s*([a-zA-Z0-9_]+)\s*}}/g) || []).length;
        const hasUser = (document.getElementById('prompt-textarea')?.value || '').trim().length > 0;
        const disabled = (!hasUser) || missingVars > 0;
        const btn1 = document.getElementById('runPromptBtn');
        if (btn1) {
          btn1.disabled = disabled || this.state.isRunning;
          btn1.title = disabled ? 'Compl√©tez le prompt et les variables' : 'Tester le prompt';
        }
      }

      // Theme
      toggleTheme() {
        this.state.isDarkMode = !this.state.isDarkMode;
        if (this.state.isDarkMode) document.body.setAttribute('data-theme', 'dark');
        else document.body.removeAttribute('data-theme');
        this.saveToStorage();
      }

      // Clipboard
      copyToClipboard() {
        const text = this.buildFullPrompt();
        navigator.clipboard.writeText(text).then(() => this.showToast('Copi√© dans le presse-papiers!', 'success'))
          .catch(() => this.showToast('Erreur lors de la copie', 'error'));
      }

      // Run / simulate LLM
      testPrompt() {
        if (this.state.isRunning) { this.showToast('Ex√©cution d√©j√† en cours...', 'warning'); return; }
        const btn = document.getElementById('runPromptBtn');
        const label = document.getElementById('runPromptLabel');
        const spinner = document.getElementById('runSpinner');
        this.state.isRunning = true;
        if (btn) btn.disabled = true; spinner.style.display = 'inline-block'; label.textContent = 'Ex√©cution...';

        this.state.apiUsage.req = Math.min(500, this.state.apiUsage.req + 1);
        this.updateApiUsageBars();

        const out = document.getElementById('runOutput'); out.textContent = '';
        const prompt = this.buildFullPrompt();
        const streamText = this.simulateLLMResponse(prompt);

        const estimatedTok = this.approxTokens(prompt) + Math.ceil(streamText.length / 4);
        this.state.apiUsage.tokens = Math.min(100000, this.state.apiUsage.tokens + estimatedTok);
        this.updateApiUsageBars();

        const finish = () => {
          if (btn) btn.disabled = false; spinner.style.display = 'none'; label.textContent = 'Tester le prompt';
          this.state.isRunning = false;
          this.refreshRunButtons();
          this.showToast('Test termin√© (simulation)', 'success');
          document.getElementById('resultMetrics').textContent = `~${Math.ceil(streamText.length/4)} tok`;
        };

        if (this.state.settings.streaming && document.getElementById('optStreaming').checked) {
          this.streamTo(out, streamText, 15, finish);
        } else {
          out.textContent = streamText;
          finish();
        }
      }

      simulateLLMResponse(prompt) {
        const seed = prompt.slice(0, 200).replace(/\n+/g, ' ').trim();
        const systemNode = this.state.sections.find(s => (s.name || '').toLowerCase() === 'system');
        const personaHint = systemNode ? (systemNode.content || '').slice(0,120) : '';
        const base = `Analyse:\n- Contexte compris.\n- Objectifs prioris√©s.\n- Contraintes int√©gr√©es.\n\nPlan:\n1) Audit rapide\n2) Strat√©gie\n3) Ex√©cution\n4) Mesure\n\nD√©tails:\n${seed}\n\nNotes persona:\n${personaHint}\n\nSortie structur√©e:\n{\n  "titre": "Plan d'action",\n  "sections": [\n    { "nom": "Strat√©gie", "contenu": "..." },\n    { "nom": "Ex√©cution", "contenu": "..." }\n  ],\n  "kpis": ["Trafic", "Conversions", "CAC"]\n}\n\nFin.`;
        return base;
      }

      streamTo(el, text, chunk = 20, doneCb = null) {
        this.stopStreaming(el);
        let i = 0;
        const timer = setInterval(() => {
          el.textContent += text.slice(i, i + chunk);
          el.scrollTop = el.scrollHeight;
          i += chunk;
          if (i >= text.length) {
            this.stopStreaming(el);
            doneCb && doneCb();
          }
        }, 30);
        this.state.streamTimers.set(el, timer);
      }
      stopStreaming(el = null) {
        if (el) {
          const t = this.state.streamTimers.get(el);
          if (t) { clearInterval(t); this.state.streamTimers.delete(el); }
          return;
        }
        this.state.streamTimers.forEach((t) => clearInterval(t));
        this.state.streamTimers.clear();
      }
      simulatePreviewStream() {
        const el = document.getElementById('previewContent');
        const full = el.innerText || el.textContent || '';
        const shuffled = (full.split(' ').slice(0, 180).join(' ') + ' ...').trim();
        el.textContent = '';
        this.streamTo(el, shuffled, 10);
      }

      updateApiUsageBars() {
        const t = Math.min(100000, this.state.apiUsage.tokens);
        const r = Math.min(500, this.state.apiUsage.req);
        document.getElementById('apiTokenUsage').textContent = `${t.toLocaleString('fr-FR')} / 100,000`;
        document.getElementById('apiReqUsage').textContent = `${r} / 500`;
        document.getElementById('apiTokenBar').style.width = `${(t/100000)*100}%`;
        document.getElementById('apiReqBar').style.width = `${(r/500)*100}%`;
      }

      startAutoSave() { if (this.state.settings.autoSave) setInterval(() => this.saveToStorage(), 30000); }

      refreshAutosaveBadge(enabled) {
        const badge = document.getElementById('autosaveBadge');
        const label = document.getElementById('autosaveLabel');
        label.textContent = enabled ? 'Auto-save actif' : 'Auto-save d√©sactiv√©';
        badge.style.background = enabled ? 'linear-gradient(135deg, #10b981, #059669)' : 'linear-gradient(135deg, #475569, #334155)';
        this.state.settings.autoSave = !!enabled;
        this.saveToStorage();
      }

      showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        const iconMap = { success: 'fa-check-circle', error: 'fa-exclamation-circle', warning: 'fa-exclamation-triangle', info: 'fa-info-circle' };
        toast.innerHTML = `<i class="fas ${iconMap[type]} toast-icon"></i><span class="toast-message">${this.escapeHtml(message)}</span>`;
        container.appendChild(toast);
        setTimeout(() => { toast.style.opacity = 0; setTimeout(() => toast.remove(), 300); }, 3500);
      }

      // Library view + actions
      bindLibraryClicks() {
        const loadItem = (key) => {
          const item = this.libraryData[key];
          if (!item) return;
          document.getElementById('prompt-title').value = item.title;
          this.resetDefaultSections(); // Start fresh
          this.ensureThinkingSection();
          const systemNode = this.state.sections.find(s => (s.name || '').toLowerCase() === 'system');
          if (systemNode && item.sections.System) systemNode.content = item.sections.System;
          
          Object.entries(item.sections).forEach(([name, content]) => {
              const low = name.toLowerCase();
              if (low === 'system') return;
              const existing = this.state.sections.find(s => (s.name || '').toLowerCase() === low);
              if (existing) existing.content = content;
              else this.state.sections.push({ id: this.uid(), name: low, icon: 'fa-layer-group', deletable: true, content, children: [] });
          });

          document.getElementById('prompt-textarea').value = item.prompt;
          this.renderSections(); this.detectAndRenderVariables(); this.updatePreview(); this.updateStats(); this.refreshRunButtons(); this.saveToStorage();
          this.showToast(`Mod√®le charg√©: ${item.title}`, 'success');
        };
        const list = document.getElementById('promptList');
        if (list) {
          list.querySelectorAll('.prompt-item').forEach(li => {
            li.addEventListener('click', () => {
              list.querySelectorAll('.prompt-item').forEach(x=>x.classList.remove('active'));
              li.classList.add('active');
              const key = li.getAttribute('data-key');
              loadItem(key);
            });
          });
        }
        const grid = document.getElementById('promptGrid');
        if (grid) {
          grid.querySelectorAll('.prompt-card').forEach(card => {
            card.addEventListener('click', () => loadItem(card.getAttribute('data-key')));
          });
        }
      }

      toggleLibraryView(mode) {
        const lc = document.getElementById('libraryContainer');
        const listBtn = document.getElementById('listViewBtn');
        const gridBtn = document.getElementById('gridViewBtn');
        listBtn.classList.toggle('active', mode==='list'); gridBtn.classList.toggle('active', mode==='grid');
        if (mode === 'grid') {
          const list = document.getElementById('promptList');
          const items = Array.from(list.querySelectorAll('.prompt-item')).map(li => ({
            title: li.querySelector('.prompt-item-title')?.textContent.trim(),
            preview: li.querySelector('.prompt-item-preview')?.textContent.trim(),
            tags: Array.from(li.querySelectorAll('.prompt-item-tag')).map(t => t.textContent.trim()),
            key: li.getAttribute('data-key')
          }));
          lc.innerHTML = `<div class="prompt-grid" id="promptGrid"></div>`;
          const grid = document.getElementById('promptGrid');
          items.forEach(it => {
            const card = document.createElement('div');
            card.className = 'prompt-card';
            card.setAttribute('data-key', it.key);
            card.innerHTML = `<div style="font-weight:700; margin-bottom:0.25rem;">${this.escapeHtml(it.title)}</div>
              <div style="font-size:0.8rem; color:var(--text-secondary); margin-bottom:0.35rem;">${this.escapeHtml(it.preview)}</div>
              <div style="display:flex; gap:0.25rem; flex-wrap:wrap;">
                ${it.tags.map(t => `<span class="prompt-item-tag">${this.escapeHtml(t)}</span>`).join('')}
              </div>`;
            grid.appendChild(card);
          });
          this.bindLibraryClicks();
        } else {
          const order = ['marketing','python_review','social_posts','translator','sql_gen'];
          lc.innerHTML = '';
          const ul = document.createElement('ul'); ul.className = 'prompt-list'; ul.id = 'promptList';
          order.forEach((key,i)=>{
            const item = this.libraryData[key];
            const li = document.createElement('li'); li.className = 'prompt-item' + (i===0?' active':''); li.setAttribute('data-key', key);
            const tags = item.tags || [];
            li.innerHTML = `<div class="prompt-item-title">${this.escapeHtml(item.title)}</div>
              <div class="prompt-item-preview">${this.escapeHtml(item.prompt.slice(0,80))}...</div>
              <div class="prompt-item-meta">${tags.map(t=>`<span class="prompt-item-tag">${this.escapeHtml(t)}</span>`).join('')}</div>`;
            ul.appendChild(li);
          });
          lc.appendChild(ul);
          this.bindLibraryClicks();
        }
      }

      filterLibrary() {
        const q = (document.getElementById('searchInput').value || '').toLowerCase();
        document.querySelectorAll('#promptList .prompt-item').forEach(it => {
          const t = it.querySelector('.prompt-item-title')?.textContent.toLowerCase() || '';
          const p = it.querySelector('.prompt-item-preview')?.textContent.toLowerCase() || '';
          it.style.display = (t.includes(q) || p.includes(q)) ? '' : 'none';
        });
      }
      filterByTag(tagEl) {
        document.querySelectorAll('.tag-chip').forEach(t => t.classList.remove('active'));
        tagEl.classList.add('active');
        const filter = tagEl.getAttribute('data-filter');
        document.querySelectorAll('#promptList .prompt-item').forEach(it => {
          if (filter === '*') { it.style.display = ''; return; }
          const tags = Array.from(it.querySelectorAll('.prompt-item-tag')).map(t => t.textContent.trim());
          it.style.display = tags.includes(filter) ? '' : 'none';
        });
      }

      // Components
      insertComponent(key) {
        const txt = this.templates.components[key] || '';
        if (!txt) return;
        this.insertAtCursor('\n' + txt + '\n');
        this.showToast('Composant ins√©r√©', 'success');
      }

      // Persona
      applyPersona() {
        const sel = document.getElementById('personaSelect').value;
        const txt = this.personas[sel] || '';
        const system = this.state.sections.find(s => (s.name || '').toLowerCase() === 'system');
        if (!system) return;
        const locked = document.getElementById('lockSystem').checked;
        if (locked) { this.showToast('System verrouill√©', 'warning'); return; }
        system.content = txt || system.content;
        this.renderActiveSectionContent();
        this.updatePreview(); this.saveToStorage();
        this.showToast('Persona appliqu√© au System', 'success');
      }

      // Optimization
      openOptimization(all = false) {
        const before = all ? this.buildFullPrompt() : (document.activeElement?.tagName==='TEXTAREA' ? document.activeElement.value : document.getElementById('prompt-textarea').value);
        const after = this.optimizeText(before);
        document.getElementById('optBefore').value = before;
        document.getElementById('optAfter').value = after;
        const tb = this.approxTokens(before), ta = this.approxTokens(after);
        document.getElementById('optStats').textContent = `Avant: ~${tb} tok | Apr√®s: ~${ta} tok | Gain: ${Math.max(0,tb-ta)} tok`;
        document.getElementById('optModal').dataset.applyTarget = all ? 'all' : 'active';
        document.getElementById('optModal').classList.add('active');
      }
      optimizeText(text) {
        if (!text) return '';
        let out = text.slice();
        const patterns = [
          /(?:s'il te pla√Æt|s'il vous pla√Æt|merci de|veuillez|sois|soyez|assure-toi|assurez-vous de)/gi,
          /\b(en effet|de ce fait|par cons√©quent|afin de|dans le but de)\b/gi
        ];
        patterns.forEach(rx => { out = out.replace(rx, ''); });
        out = out.replace(/[ \t]+/g, ' ').replace(/\n{3,}/g, '\n\n').trim();
        out = out.replace(/^\s*-\s+/gm, '- ');
        out = out.replace(/\b(doit|devrait)\b/gi, '=>');
        return out;
      }
      applyOptimization() {
        const target = document.getElementById('optModal').dataset.applyTarget;
        const val = document.getElementById('optAfter').value;
        if (target === 'all') {
          const traverseAndOptimize = (nodes) => {
              nodes.forEach(node => {
                  node.content = this.optimizeText(node.content || '');
                  if (node.children) traverseAndOptimize(node.children);
              });
          };
          traverseAndOptimize(this.state.sections);
          const userTa = document.getElementById('prompt-textarea');
          userTa.value = this.optimizeText(userTa.value);
          userTa.dispatchEvent(new Event('input', { bubbles: true }));
        } else {
          const el = document.activeElement?.tagName==='TEXTAREA' ? document.activeElement : document.getElementById('prompt-textarea');
          el.value = val; el.dispatchEvent(new Event('input', { bubbles: true }));
        }
        document.getElementById('optModal').classList.remove('active');
        this.renderSections(); this.updatePreview(); this.saveToStorage();
        this.showToast('Optimisation appliqu√©e', 'success');
      }

      // History
      savePrompt() {
        const title = document.getElementById('prompt-title')?.value || 'Sans titre';
        this.showToast(`Prompt "${title}" sauvegard√© !`, 'success');
        this.saveToStorage();
      }
      saveVersion() {
        const v = {
          id: this.uid(),
          title: document.getElementById('prompt-title')?.value || 'Sans titre',
          prompt: this.buildFullPrompt(),
          date: new Date().toLocaleString('fr-FR')
        };
        this.state.history.unshift(v);
        this.renderHistory();
        this.saveToStorage();
        this.showToast('Version sauvegard√©e', 'success');
      }
      renderHistory() {
        const wrap = document.getElementById('historyCards');
        wrap.innerHTML = '';
        this.state.history.slice(0, 6).forEach((h) => {
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <div class="card-icon"><i class="fas fa-code-branch"></i></div>
            <div class="card-title">${this.escapeHtml(h.title || 'Version')}</div>
            <div class="card-description">Cr√©√© le ${this.escapeHtml(h.date)}</div>
            <div style="display:flex; gap:0.5rem; margin-top:0.5rem; flex-wrap:wrap;">
              <button class="btn btn-secondary btn-icon" title="Copier" data-copy="${h.id}"><i class="fas fa-copy"></i></button>
              <button class="btn btn-secondary btn-icon" title="Charger dans √©diteur" data-load="${h.id}"><i class="fas fa-upload"></i></button>
            </div>
          `;
          wrap.appendChild(card);
        });
        wrap.querySelectorAll('[data-copy]').forEach(b => b.addEventListener('click', () => {
          const id = b.getAttribute('data-copy');
          const v = this.state.history.find(x => x.id === id);
          if (v) { navigator.clipboard.writeText(v.prompt); this.showToast('Version copi√©e', 'success'); }
        }));
        wrap.querySelectorAll('[data-load]').forEach(b => b.addEventListener('click', () => {
          const id = b.getAttribute('data-load');
          const v = this.state.history.find(x => x.id === id);
          if (!v) return;
          const instr = this.state.sections.find(s => (s.name || '').toLowerCase() === 'instructions') || this.state.sections[0];
          instr.content = v.prompt;
          this.renderSections(); this.updatePreview(); this.saveToStorage();
          this.showToast('Version charg√©e dans l‚Äô√©diteur', 'success');
        }));
      }

      openAB() { document.getElementById('abPanel').style.display = 'block'; }
      closeAB() { document.getElementById('abPanel').style.display = 'none'; this.stopStreaming(document.getElementById('abAOut')); this.stopStreaming(document.getElementById('abBOut')); }
      runAB() {
        const A = document.getElementById('abA').value.trim();
        const B = document.getElementById('abB').value.trim();
        if (!A || !B) { this.showToast('Veuillez fournir A et B', 'warning'); return; }
        const outA = document.getElementById('abAOut');
        const outB = document.getElementById('abBOut');
        outA.textContent = ''; outB.textContent = '';
        const respA = this.simulateLLMResponse(A);
        const respB = this.simulateLLMResponse(B);
        this.streamTo(outA, respA, 15);
        this.streamTo(outB, respB, 15);
      }
      scoreAB() {
        const a = document.getElementById('abAOut').textContent || '';
        const b = document.getElementById('abBOut').textContent || '';
        if (!a || !b) { this.showToast('Lancez d‚Äôabord A/B', 'warning'); return; }
        const score = (txt) => {
          let s = 0;
          try { JSON.parse((txt.match(/{[\s\S]*}/) || ['{}'])[0]); s += 30; } catch { /* noop */ }
          if (/Plan|√âtapes|Objectifs/i.test(txt)) s += 20;
          if (/KPI|KPIs|metrics|m√©triques/i.test(txt)) s += 20;
          s += Math.max(0, 30 - Math.floor(txt.length/400));
          return s;
        };
        const sa = score(a), sb = score(b);
        this.showToast(`Score A: ${sa} | Score B: ${sb} ‚Äî ${sa>sb?'A gagne':(sb>sa?'B gagne':'√âgalit√©')}`, 'info');
      }

      // Chat mode (simulation)
      switchMode(mode) {
        const edBtn = document.getElementById('modeEditorBtn');
        const chBtn = document.getElementById('modeChatBtn');
        const chat = document.getElementById('chatPanel');
        if (mode === 'chat') {
          edBtn.classList.remove('active'); chBtn.classList.add('active'); chat.classList.add('active');
          document.getElementById('editorPanel').scrollIntoView({ behavior:'smooth', block:'start' });
          if (this.state.chatHistory.length === 0) this.addAssistant('Bonjour, je suis pr√™t √† tester votre prompt en mode conversation. Posez votre premi√®re question.');
        } else {
          edBtn.classList.add('active'); chBtn.classList.remove('active'); chat.classList.remove('active');
        }
      }
      addMessage(role, content) {
        const box = document.getElementById('chatBox');
        const div = document.createElement('div');
        div.className = `chat-msg ${role === 'user' ? 'chat-user' : 'chat-assistant'}`;
        div.textContent = content;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
      }
      addAssistant(txt) { this.state.chatHistory.push({ role:'assistant', content:txt }); this.addMessage('assistant', txt); }
      sendChat() {
        const input = document.getElementById('chatInput');
        const msg = input.value.trim(); if (!msg) return;
        input.value = '';
        this.state.chatHistory.push({ role:'user', content:msg }); this.addMessage('user', msg);
        const sys = this.state.sections.find(s => (s.name || '').toLowerCase()==='system')?.content || '';
        const context = this.buildFullPrompt().slice(0, 400);
        const reply = `Compris. (${this.state.settings.model})\nContexte: ${sys.slice(0,80)}...\nR√©ponse: ${this.generateReply(msg, context)}`;
        setTimeout(() => this.addAssistant(reply), 300);
      }
      generateReply(msg, ctx) {
        if (/liste|points|steps|√©tapes/i.test(msg)) return `Voici 3 points:\n1) Analyse rapide\n2) Proposition\n3) Prochaines actions`;
        if (/json/i.test(msg)) return `{\n  "ok": true,\n  "msg": "Exemple JSON conforme",\n  "ctx": "${(ctx||'').replace(/"/g,'\\"').slice(0,60)}..."\n}`;
        return `Merci pour votre message. Je me base sur le contexte et adapte la r√©ponse.`;
      }
      resetChat() { this.state.chatHistory = []; document.getElementById('chatBox').innerHTML = ''; }

      // Batch
      openBatch() { document.getElementById('batchModal').classList.add('active'); }
      parseCSV(text) {
        const rows = [];
        let cur = '', row = [], inQuotes = false;
        const pushCell = () => { row.push(cur); cur=''; };
        for (let i=0;i<text.length;i++) {
          const c = text[i], n = text[i+1];
          if (c === '"') {
            if (inQuotes && n === '"') { cur += '"'; i++; }
            else inQuotes = !inQuotes;
          } else if (c === ',' && !inQuotes) { pushCell(); }
          else if ((c === '\n' || c === '\r') && !inQuotes) { if (cur!=='' || row.length>0) { pushCell(); rows.push(row); row=[]; } }
          else { cur += c; }
        }
        if (cur!=='' || row.length>0) { pushCell(); rows.push(row); }
        if (rows.length === 0) return { headers: [], rows: [] };
        const headers = rows.shift().map(h=>h.trim());
        const data = rows.filter(r=>r.length && r.some(c=>c.trim()!==''))
          .map(r => { const obj={}; headers.forEach((h,i)=> obj[h] = (r[i]||'').trim()); return obj; });
        return { headers, rows: data };
      }
      runBatch() {
        const file = document.getElementById('csvInput').files?.[0];
        if (!file) { this.showToast('S√©lectionnez un CSV', 'warning'); return; }
        const rule = document.getElementById('batchRule').value;
        const keyword = document.getElementById('batchKeyword').value.trim();
        file.text().then(text => {
          const { headers, rows } = this.parseCSV(text);
          if (headers.length === 0) { this.showToast('CSV vide ou invalide', 'error'); return; }
          let success = 0;
          const tableLines = [];
          rows.forEach((row, idx) => {
            const savedVars = { ...this.state.variableValues };
            Object.keys(row).forEach(k => this.state.variableValues[k] = row[k]);
            const prompt = this.buildFullPrompt();
            const out = this.simulateLLMResponse(prompt);
            let pass = true;
            if (rule === 'json') { try { JSON.parse((out.match(/{[\s\S]*}/) || ['{}'])[0]); pass = true; } catch { pass = false; } }
            if (rule === 'keyword') pass = keyword ? out.toLowerCase().includes(keyword.toLowerCase()) : true;
            if (pass) success++;
            tableLines.push(`[${idx+1}] ${pass ? 'OK' : 'KO'} | vars=${JSON.stringify(row)} | len=${out.length}`);
            this.state.variableValues = savedVars;
          });
          const pct = rows.length ? Math.round(success / rows.length * 100) : 0;
          document.getElementById('batchSummary').innerHTML = `<strong>${success}/${rows.length}</strong> r√©ussites (${pct}%)`;
          document.getElementById('batchTable').textContent = tableLines.join('\n');
          this.showToast('Batch termin√© (simulation)', 'success');
        });
      }

      // Project helpers
      resetEditor() {
        if (!confirm('Cr√©er un nouveau prompt (le contenu actuel restera sauvegard√© dans le stockage local) ?')) return;
        document.getElementById('prompt-title').value = 'Nouveau prompt';
        document.getElementById('prompt-textarea').value = '';
        this.resetDefaultSections();
        this.renderSections(); this.detectAndRenderVariables(); this.updatePreview(); this.updateStats(); this.refreshRunButtons(); this.saveToStorage();
        this.showToast('√âditeur r√©initialis√©', 'success');
      }
      exportProject() {
        const data = localStorage.getItem('promptStudioV2') || '{}';
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'prompt-studio-projet.json'; a.click(); URL.revokeObjectURL(url);
        this.showToast('Projet export√©', 'success');
      }
      importProject() {
        const input = document.createElement('input'); input.type = 'file'; input.accept = 'application/json';
        input.onchange = async (e) => {
          const file = e.target.files?.[0]; if (!file) return;
          try {
            const text = await file.text(); JSON.parse(text); // validate
            localStorage.setItem('promptStudioV2', text);
            this.loadFromStorage(); this.ensureThinkingSection(); this.initializeUI();
            this.showToast('Projet import√©', 'success');
          } catch { this.showToast('Fichier invalide', 'error'); }
        };
        input.click();
      }
      shareProject() {
        try {
          const data = localStorage.getItem('promptStudioV2') || '{}';
          const compressed = btoa(unescape(encodeURIComponent(data)));
          navigator.clipboard.writeText(compressed).then(()=>this.showToast('Lien/copier pr√™t (payload en presse-papiers)', 'success'));
        } catch { this.showToast('Impossible de partager', 'error'); }
      }
      createProject() {
        const name = prompt('Nom du projet :', 'Nouveau Projet');
        if (!name) return;
        const select = document.getElementById('projectSelect');
        const opt = document.createElement('option'); opt.value = name.replace(/\s+/g,'_').toLowerCase(); opt.textContent = name;
        select.appendChild(opt); select.value = opt.value;
        this.showToast(`Projet cr√©√©: ${name}`, 'success');
      }

      // Settings updater via sliders and toggles
      updateSetting(setting, value) {
        const settingMap = {
          'Temp√©rature': 'temperature', 'Max Tokens': 'maxTokens', 'Top P': 'topP',
          'Frequency Penalty': 'frequencyPenalty', 'Streaming': 'streaming',
          'Cache responses': 'cache', 'Auto-save': 'autoSave', 'Mode s√ªr': 'safeMode'
        };
        const key = settingMap[setting];
        if (key) {
          this.state.settings[key] = value;
          if (key === 'autoSave') this.refreshAutosaveBadge(!!value);
          this.saveToStorage();
        }
      }

      // Utilities
      escape(text) { return (text || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[m])); }
    }

    // Boot
    document.addEventListener('DOMContentLoaded', () => {
      window.promptStudio = new PromptStudio();

      // Bind sliders and toggles to settings
      document.querySelectorAll('.range-input').forEach(input => {
        input.addEventListener('input', (e) => {
          const value = e.target.value;
          const valueSpan = e.target.parentElement.querySelector('.range-slider-value');
          if (valueSpan) valueSpan.textContent = value;
          const label = e.target.parentElement.querySelector('.range-slider-label').textContent;
          window.promptStudio.updateSetting(label, parseFloat(value));
        });
      });
      document.querySelectorAll('.toggle-input input').forEach(toggle => {
        toggle.addEventListener('change', (e) => {
          const label = e.target.closest('.toggle-switch')?.querySelector('.toggle-label')?.textContent || '';
          window.promptStudio.updateSetting(label, e.target.checked);
        });
      });
    });
  </script>
  
  <!-- Icons (Lucide) and CodeMirror -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/markdown/markdown.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/mode/simple.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/diff_match_patch/20121119/diff_match_patch.js"></script>
  
  <style>
    /* Apple/Microsoft-inspired design polish */
    :root {
      --winmica: rgba(255,255,255,0.55);
      --winmica-dark: rgba(17,24,39,0.55);
      --gesture-ease: cubic-bezier(.2,.8,.2,1);
    }
    /* System font first for native feel */
    body, input, textarea, select, button { font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Inter, Helvetica, Arial, system-ui, sans-serif; }
    code, pre, .form-textarea { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, 'Fira Code', Consolas, 'Liberation Mono', monospace; }

    /* Subtle glass material for panels */
    .panel { background: color-mix(in srgb, var(--surface) 84%, transparent); border: 1px solid color-mix(in srgb, var(--border) 70%, transparent); box-shadow: 0 8px 24px rgba(0,0,0,.06); }
    [data-theme="dark"] .panel { background: color-mix(in srgb, var(--surface) 78%, transparent); }

    /* Contextual Menu */
    .context-menu { position: fixed; z-index: 4000; min-width: 220px; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 20px 40px rgba(0,0,0,.18); padding: 6px; display: none; backdrop-filter: blur(20px) saturate(160%); }
    .context-menu.active { display: block; animation: fadeIn var(--transition-fast); }
    .cx-item { display: flex; align-items: center; gap: .6rem; padding: 8px 10px; border-radius: 10px; cursor: pointer; color: var(--text-primary); }
    .cx-item kbd { margin-left: auto; background: var(--surface-hover); border: 1px solid var(--border); padding: 0 6px; border-radius: 6px; font-size: .72rem; color: var(--text-secondary); }
    .cx-item:hover { background: var(--surface-hover); color: var(--primary); }
    .cx-sep { height: 1px; background: var(--border); margin: 4px 6px; }

    /* Suggestions popover for slash/auto-complete */
    .suggest-pop { position: absolute; z-index: 3500; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; min-width: 260px; max-height: 50vh; overflow: auto; box-shadow: var(--shadow-2xl); display: none; }
    .suggest-pop.active { display: block; animation: fadeInDown var(--transition-fast); }
    .suggest-item { display:flex; align-items:center; justify-content:space-between; gap:.5rem; padding:.55rem .75rem; cursor:pointer; }
    .suggest-item:hover, .suggest-item.active { background: var(--surface-hover); color: var(--primary); }
    .suggest-hint { font-size: .75rem; color: var(--text-muted); }

    /* Multi-select selection state */
    .section-item.selected { outline: 2px solid var(--primary); outline-offset: -2px; background: color-mix(in srgb, var(--primary) 7%, var(--surface-hover)); }
    .multi-select-bar { position: sticky; top: 6px; z-index: 150; display: none; align-items: center; justify-content: space-between; gap: .5rem; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: .5rem .6rem; box-shadow: var(--shadow-lg); }
    .multi-select-bar.active { display: flex; }

    /* Diff viewer */
    .diff-wrap { display:grid; grid-template-columns: 1fr 1fr; gap:.5rem; }
    .diff-col { background:#0b1220; color:#e5e7eb; border:1px solid #1f2937; border-radius: 10px; padding:.5rem; font-family: var(--font-mono, ui-monospace); font-size:.82rem; white-space: pre; overflow:auto; max-height: 60vh; }
    .d-add { background: rgba(16,185,129,.16); }
    .d-rem { background: rgba(239,68,68,.16); }
    .d-same { opacity: .7; }

    /* Tiny layout motion for list insertions */
    #sectionsContainer .section-item { transition: transform .18s var(--gesture-ease), background-color .18s var(--gesture-ease); will-change: transform; }
    /* macOS window controls */
    .window-controls { position:absolute; left:16px; top:10px; display:flex; gap:8px; z-index:101; }
    .window-controls .wc { width:12px; height:12px; border-radius:50%; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.08); }
    .window-controls .wc.red { background:#ff5f57; }
    .window-controls .wc.yellow { background:#ffbd2e; }
    .window-controls .wc.green { background:#28c840; }
    /* CodeMirror macOS-like styling */
    .CodeMirror { height:auto; min-height:160px; font-family: var(--font-mono); font-size: 0.9rem; border: 1px solid var(--border); border-radius: 10px; background: var(--surface); color: var(--text-primary); padding: 4px 0; }
    .CodeMirror-scroll { max-height: 420px; }
    .CodeMirror-focused { box-shadow: 0 0 0 3px rgba(99,102,241,0.15); }
    .CodeMirror .cm-variable { color:#2563eb; font-weight:600; }
    .CodeMirror .cm-section { color:#059669; font-weight:600; }
    .CodeMirror .cm-hashtag { color:#94a3b8; font-style:italic; }
    .CodeMirror-hints { z-index: 2000; font-family: var(--font-sans); }
    .CodeMirror-hint { padding: 6px 8px; }
    .CodeMirror-hint-active { background: var(--primary); color:#fff; }
    /* Segmented control */
    .segmented { display:inline-flex; border:1px solid var(--border); border-radius:10px; overflow:hidden; background: var(--surface); }
    .segmented button { padding: 6px 10px; border:none; background:transparent; color:var(--text-secondary); cursor:pointer; }
    .segmented button.active { background: var(--surface-hover); color: var(--primary); font-weight:600; }
    /* Context menu look */
    .context-menu { position:absolute; z-index:1500; min-width:220px; background:var(--surface); border:1px solid var(--border); border-radius:12px; box-shadow: var(--shadow-xl); display:none; }
    .context-menu .item { padding:8px 10px; cursor:pointer; display:flex; gap:8px; align-items:center; }
    .context-menu .item:hover { background: var(--surface-hover); color: var(--primary); }
  </style>

  <!-- Universal contextual menu -->
  <div id="contextMenu" class="context-menu" role="menu" aria-hidden="true"></div>
  <!-- Suggestions popover (slash, variables, sections) -->
  <div id="suggestPopover" class="suggest-pop" role="listbox" aria-hidden="true"></div>
  <!-- Floating multi-select actions bar -->
  <div id="multiSelectBar" class="multi-select-bar" aria-live="polite" style="margin: .5rem 1px;">
    <div><strong id="msCount">0</strong> s√©lectionn√©s</div>
    <div style="display:flex; gap:.35rem; flex-wrap:wrap;">
      <button class="btn btn-secondary" id="msDuplicate"><i class="fas fa-copy"></i> Dupliquer</button>
      <button class="btn btn-secondary" id="msExport"><i class="fas fa-download"></i> Export</button>
      <button class="btn btn-danger" id="msDelete"><i class="fas fa-trash"></i> Supprimer</button>
    </div>
  </div>

  <!-- Diff modal -->
  <div class="modal" id="diffModal" role="dialog" aria-modal="true" aria-labelledby="diffTitle">
    <div class="modal-content" style="max-width: 1000px;">
      <div class="modal-header">
        <div class="modal-title" id="diffTitle"><i class="fas fa-code-compare"></i> Comparaison de versions</div>
        <button class="modal-close" data-close-modal="#diffModal"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <div class="diff-wrap">
          <div>
            <div class="muted" style="margin-bottom:.35rem;">A (r√©f√©rence)</div>
            <pre id="diffA" class="diff-col"></pre>
          </div>
          <div>
            <div class="muted" style="margin-bottom:.35rem;">B (compar√©)</div>
            <pre id="diffB" class="diff-col"></pre>
          </div>
        </div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" data-close-modal="#diffModal">Fermer</button></div>
    </div>
  </div>

  <!-- Test suites manager modal -->
  <div class="modal" id="testsModal" role="dialog" aria-modal="true" aria-labelledby="testsTitle">
    <div class="modal-content" style="max-width: 920px;">
      <div class="modal-header">
        <div class="modal-title" id="testsTitle"><i class="fas fa-vial"></i> Gestionnaire de cas de test</div>
        <button class="modal-close" data-close-modal="#testsModal"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <div style="display:flex; gap:.75rem; flex-wrap:wrap; align-items:center;">
          <input id="tsName" class="form-input" placeholder="Nom de la suite (ex: Cas Nominaux)" style="flex:1;" />
          <button class="btn btn-secondary" id="tsCreate"><i class="fas fa-plus"></i> Cr√©er</button>
          <select id="tsSelect" class="form-select" style="min-width:200px;"></select>
          <button class="btn btn-accent" id="tsRun"><i class="fas fa-play"></i> Lancer</button>
        </div>
        <div class="muted" style="margin:.35rem 0 .5rem;">Ajoutez des lignes (jeux de variables) et des r√®gles de validation simples.</div>
        <div id="tsEditor" class="panel" style="padding:.5rem;">
          <div style="display:flex; gap:.5rem; align-items:center; margin-bottom:.5rem;">
            <button class="btn btn-secondary" id="tsAddRow"><i class="fas fa-row-insert"></i> Ajouter ligne</button>
            <button class="btn btn-secondary" id="tsImportCSV"><i class="fas fa-file-csv"></i> Import CSV</button>
            <div class="dropdown">
              <button class="btn btn-secondary btn-icon" id="tsRuleBtn" title="R√®gle"><i class="fas fa-check-double"></i></button>
              <div class="dropdown-menu" id="tsRuleMenu">
                <div class="dropdown-item" data-rule="none">Aucune</div>
                <div class="dropdown-item" data-rule="json">JSON valide</div>
                <div class="dropdown-item" data-rule="keyword">Contient mot-cl√©‚Ä¶</div>
              </div>
            </div>
          </div>
          <div id="tsRows"></div>
        </div>
        <div id="tsReport" style="margin-top:.5rem;"></div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" data-close-modal="#testsModal">Fermer</button></div>
    </div>
  </div>

  <script>
  (function(){
    const on = (el, ev, fn, opts) => el && el.addEventListener(ev, fn, opts||false);
    const qs = (s, r=document) => r.querySelector(s);
    const qsa = (s, r=document) => Array.from(r.querySelectorAll(s));
    const KMETA = navigator.platform.toLowerCase().includes('mac') ? '‚åò' : 'Ctrl';
    function ensureAfterInit(cb){ if (window.promptStudio) cb(); else document.addEventListener('DOMContentLoaded', cb, { once:true }); }

    ensureAfterInit(initEnhancements);

    function initEnhancements(){
      const ps = window.promptStudio;
      if (!ps) return;
      setupContextMenu(ps);
      enableSectionMultiSelect(ps);
      enableCrossPanelDragDrop(ps);
      setupIntelliSense(ps);
      enhanceValidationWithLinter(ps);
      setupBranchesAndDiff(ps);
      setupTestManager(ps);
      setupCodeMirror(ps);
      setupApiKeys(ps);
      setupProjectTree(ps);
      extendCommandPalette(ps);
      persistSidebarSizes();
      addQuickActionButtons(ps);
    }

    // ========== Contextual Menu ==========
    function setupContextMenu(ps){
      const menu = qs('#contextMenu');
      const hide = () => { menu.classList.remove('active'); menu.setAttribute('aria-hidden','true'); };
      const showAt = (x,y, items) => {
        menu.innerHTML = items.map(it => it==='sep' ? '<div class="cx-sep"></div>' : `<div class="cx-item" data-action="${it.id}"><i class="fas ${it.icon||'fa-circle'}"></i><span>${escapeHtml(it.label)}</span>${it.kbd?`<kbd>${it.kbd}</kbd>`:''}</div>`).join('');
        menu.style.left = Math.min(x, window.innerWidth-260) + 'px';
        menu.style.top = Math.min(y, window.innerHeight-200) + 'px';
        menu.classList.add('active');
        menu.setAttribute('aria-hidden','false');
      };
      on(document, 'click', (e)=>{ if(!menu.contains(e.target)) hide(); });
      on(document, 'keydown', (e)=>{ if(e.key==='Escape') hide(); });

      const buildForSection = (sid) => [
        { id:'sec_rename', label:'Renommer', icon:'fa-i-cursor', kbd:'Enter' },
        { id:'sec_duplicate', label:'Dupliquer', icon:'fa-copy', kbd: KMETA+'+D' },
        { id:'sec_add_child', label:'Ajouter sous-section', icon:'fa-plus' },
        'sep',
        { id:'sec_up', label:'Monter', icon:'fa-arrow-up' },
        { id:'sec_down', label:'Descendre', icon:'fa-arrow-down' },
        'sep',
        { id:'sec_copy', label:'Copier contenu', icon:'fa-clipboard' },
        { id:'sec_export', label:'Exporter JSON', icon:'fa-download' },
        'sep',
        { id:'sec_delete', label:'Supprimer', icon:'fa-trash' }
      ];
      const buildForVariable = (name) => [
        { id:'var_insert', label:'Ins√©rer '+name, icon:'fa-at', kbd: KMETA+'+I' },
        { id:'var_set', label:'D√©finir valeur‚Ä¶', icon:'fa-pen' },
        { id:'var_clear', label:'Effacer valeur', icon:'fa-eraser' }
      ];
      const buildGeneric = () => [
        { id:'copy_preview', label:'Copier aper√ßu', icon:'fa-copy', kbd: KMETA+'+C' },
        { id:'open_cmd', label:'Palette de commandes', icon:'fa-magnifying-glass', kbd: KMETA+'+K' }
      ];

      on(document, 'contextmenu', (e) => {
        const sec = e.target.closest('.section-item');
        const varc = e.target.closest('.variable-chip[data-variable]');
        const inEditor = e.target.closest('#editorPanel');
        if (sec || varc || inEditor) {
          e.preventDefault();
          if (sec){ showAt(e.clientX, e.clientY, buildForSection(sec.dataset.sectionId)); menu.dataset.targetType='section'; menu.dataset.id = sec.dataset.sectionId; }
          else if (varc){ const v = varc.dataset.variable; showAt(e.clientX, e.clientY, buildForVariable(v)); menu.dataset.targetType='variable'; menu.dataset.var = v; }
          else { showAt(e.clientX, e.clientY, buildGeneric()); menu.dataset.targetType='generic'; }
        }
      });

      on(menu, 'click', (e) => {
        const it = e.target.closest('.cx-item'); if(!it) return; const act = it.dataset.action; const t = menu.dataset.targetType; hide();
        if (t==='section') handleSectionAction(ps, menu.dataset.id, act);
        else if (t==='variable') handleVariableAction(ps, menu.dataset.var, act);
        else if (t==='generic') handleGenericAction(ps, act);
      });

      function handleSectionAction(ps, id, act){
        const info = ps.findNodeById(id);
        if (!info) return;
        switch (act) {
          case 'sec_rename': {
            const nn = prompt('Nouveau nom de section:', info.node.name||'');
            if (nn!==null){ info.node.name = (nn||'').trim()||info.node.name; ps.renderSections(); ps.updatePreview(); ps.saveToStorage(); }
            break; }
          case 'sec_duplicate': ps.duplicateSection(id); break;
          case 'sec_add_child': {
            info.node.children = info.node.children||[];
            info.node.children.push({ id: ps.uid(), name: 'sub', icon: 'fa-layer-group', deletable: true, content: '', children: [] });
            ps.renderSections(); ps.saveToStorage(); break; }
          case 'sec_up': ps.moveSectionUp(id); break;
          case 'sec_down': ps.moveSectionDown(id); break;
          case 'sec_copy': {
            const text = info.node.content||''; navigator.clipboard.writeText(text).then(()=>ps.showToast('Contenu copi√©','success')); break; }
          case 'sec_export': {
            const data = JSON.stringify(info.node, null, 2); const blob = new Blob([data],{type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`section_${(info.node.name||'node')}.json`; a.click(); URL.revokeObjectURL(url); break; }
          case 'sec_delete': ps.deleteSection(id); break;
        }
      }
      function handleVariableAction(ps, v, act){
        const name = v.replace(/[{}]/g,'');
        switch(act){
          case 'var_insert': ps.insertVariable(v); break;
          case 'var_set': {
            const val = prompt(`Valeur pour {{${name}}}:`, ps.state.variableValues[name]||''); if (val!==null){ ps.state.variableValues[name]=val; ps.updatePreview(); ps.saveToStorage(); }
            break; }
          case 'var_clear': { delete ps.state.variableValues[name]; ps.updatePreview(); ps.saveToStorage(); break; }
        }
      }
      function handleGenericAction(ps, act){ if (act==='copy_preview') ps.copyToClipboard(); if (act==='open_cmd') ps.openCommandPalette(); }
      function escapeHtml(t){ const d=document.createElement('div'); d.textContent=t||''; return d.innerHTML; }
    }

    // ========== Multi-select & batch actions ==========
    function enableSectionMultiSelect(ps){
      ps.selectedSectionIds = new Set();
      const bar = qs('#multiSelectBar');
      const updateBar = () => {
        qs('#msCount').textContent = ps.selectedSectionIds.size;
        bar.classList.toggle('active', ps.selectedSectionIds.size>1);
      };
      const container = qs('#sectionsContainer');
      on(container, 'click', (e) => {
        const item = e.target.closest('.section-item');
        if (!item) return;
        if (e.metaKey || e.ctrlKey) {
          e.preventDefault(); e.stopPropagation();
          const id = item.dataset.sectionId;
          if (ps.selectedSectionIds.has(id)) { ps.selectedSectionIds.delete(id); item.classList.remove('selected'); }
          else { ps.selectedSectionIds.add(id); item.classList.add('selected'); }
          updateBar();
        }
      }, true);
      on(qs('#msDelete'), 'click', () => { [...ps.selectedSectionIds].forEach(id => { try { ps.deleteSection(id); } catch(e){} }); ps.selectedSectionIds.clear(); updateBar(); });
      on(qs('#msDuplicate'), 'click', () => { [...ps.selectedSectionIds].forEach(id => { try { ps.duplicateSection(id); } catch(e){} }); ps.selectedSectionIds.clear(); updateBar(); });
      on(qs('#msExport'), 'click', () => {
        const nodes = [...ps.selectedSectionIds].map(id => ps.findNodeById(id)?.node).filter(Boolean);
        const data = JSON.stringify(nodes, null, 2); const blob = new Blob([data],{type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='sections_selection.json'; a.click(); URL.revokeObjectURL(url); ps.showToast('S√©lection export√©e','success');
      });
    }

    // ========== Drag & Drop between panels ==========
    function enableCrossPanelDragDrop(ps){
      // components -> editor
      qsa('.component-chip').forEach(ch => { ch.setAttribute('draggable','true'); on(ch,'dragstart',(e)=>{ e.dataTransfer.setData('text/plain', ps.templates.components[ch.dataset.component]||''); e.dataTransfer.effectAllowed='copy'; }); });
      // history -> AB
      const hwrap = qs('#historyCards');
      on(hwrap, 'dragstart', (e)=>{
        const card = e.target.closest('.card'); if (!card) return;
        const idx = [...hwrap.children].indexOf(card);
        const v = ps.state.history[idx]; if (!v) return;
        e.dataTransfer.setData('text/plain', v.prompt||'');
        e.dataTransfer.effectAllowed='copy';
      });
      qsa('#abA, #abB, #prompt-textarea, #section-textarea').forEach(area => {
        on(area, 'dragover', (e)=>{ e.preventDefault(); e.dataTransfer.dropEffect='copy'; });
        on(area, 'drop', (e)=>{ e.preventDefault(); const txt = e.dataTransfer.getData('text/plain'); if (!txt) return; insertAtCaret(area, txt); area.dispatchEvent(new Event('input',{bubbles:true})); });
      });
      function insertAtCaret(el, text){ const s = el.selectionStart||0, t = el.value; el.value = t.slice(0,s)+text+t.slice(el.selectionEnd||s); el.selectionStart = el.selectionEnd = s + text.length; }
    }

    // ========== CodeMirror Editor + Syntax Highlighting + Autocomplete ==========
    function setupCodeMirror(ps){
      if (!window.CodeMirror) return;
      const promptTA = qs('#prompt-textarea');
      const sectionTA = qs('#section-textarea');
      if (promptTA && !ps.cmPrompt){
        ps.cmPrompt = CodeMirror.fromTextArea(promptTA, { mode:'promptx', lineNumbers:false, lineWrapping:true, theme:'default' });
        ps.cmPrompt.on('change', (cm)=>{ promptTA.value = cm.getValue(); promptTA.dispatchEvent(new Event('input',{bubbles:true})); });
        ps.cmPrompt.on('inputRead', (cm, change)=>{ if(!change.text) return; const t=change.text.join(''); if(/[\/{]/.test(t.slice(-1))) showHints(cm); });
      }
      if (sectionTA && !ps.cmSection){
        ps.cmSection = CodeMirror.fromTextArea(sectionTA, { mode:'promptx', lineNumbers:false, lineWrapping:true, theme:'default', readOnly: sectionTA.disabled });
        ps.cmSection.on('change', (cm)=>{ sectionTA.value = cm.getValue(); sectionTA.dispatchEvent(new Event('input',{bubbles:true})); });
        ps.cmSection.on('inputRead', (cm, change)=>{ if(!change.text) return; const t=change.text.join(''); if(/[\/{<]/.test(t.slice(-1))) showHints(cm); });
      }
      // Patch renderActiveSectionContent to sync CodeMirror
      const orig = ps.renderActiveSectionContent.bind(ps);
      ps.renderActiveSectionContent = function(){ orig(); if(ps.cmSection){ const area = qs('#section-textarea'); ps.cmSection.setValue(area.value||''); ps.cmSection.setOption('readOnly', !!area.disabled); } };
      // Patch helpers to insert at cursor for CM
      const wrapSelOrig = ps.wrapSelection?.bind(ps);
      ps.wrapSelection = function(marker){ const cm = (ps.cmSection && ps.cmSection.hasFocus())? ps.cmSection : (ps.cmPrompt && ps.cmPrompt.hasFocus()? ps.cmPrompt : null); if (cm){ const sel=cm.getSelection(); cm.replaceSelection(marker+sel+marker,'around'); cm.focus(); } else { wrapSelOrig && wrapSelOrig(marker); } };
      const insertOrig = ps.insertAtCursor?.bind(ps);
      ps.insertAtCursor = function(text){ const cm = (ps.cmSection && ps.cmSection.hasFocus())? ps.cmSection : (ps.cmPrompt && ps.cmPrompt.hasFocus()? ps.cmPrompt : null); if (cm){ cm.replaceSelection(text,'end'); cm.focus(); } else { insertOrig && insertOrig(text); } };
      const insVarOrig = ps.insertVariable?.bind(ps);
      ps.insertVariable = function(v){ const cm = (ps.cmSection && ps.cmSection.hasFocus())? ps.cmSection : (ps.cmPrompt && ps.cmPrompt.hasFocus()? ps.cmPrompt : null); if (cm){ cm.replaceSelection(v,'end'); cm.focus(); } else { insVarOrig && insVarOrig(v); } };
      function showHints(cm){ if (!CodeMirror.hint) return; CodeMirror.showHint(cm, (editor)=>{
          const cur = editor.getCursor(); const tok = editor.getTokenAt(cur); const line = editor.getLine(cur.line).slice(0, cur.ch);
          let list = [];
          // Slash commands
          const mSlash = line.match(/\/(\w{0,24})$/);
          if (mSlash){ const q=mSlash[1].toLowerCase(); const arr = Object.keys(ps.strategies).map(k=>({text: ps.strategies[k].content, displayText:`/`+k+` ‚Äî `+ps.strategies[k].title})); list = arr.filter(it=> it.displayText.toLowerCase().includes(q)); return { list, from: CodeMirror.Pos(cur.line, cur.ch-q.length-1), to: cur } }
          // Variables
          const mVar = line.match(/{{([^}]{0,24})$/);
          if (mVar){ const q=mVar[1].toLowerCase(); const set=new Set(); qsa('#variable-chips-container .variable-chip[data-variable]').forEach(ch=>set.add(ch.dataset.variable.replace(/[{}]/g,''))); list = [...set].filter(n=>n.toLowerCase().includes(q)).map(n=>({text:`{{${n}}}`, displayText:`{{${n}}}`})); return { list, from: CodeMirror.Pos(cur.line, cur.ch-q.length), to: cur } }
          // Sections
          const mSec = line.match(/<(\w{0,24})$/);
          if (mSec){ const q=mSec[1].toLowerCase(); const names=[]; (ps.state.sections||[]).forEach(function walk(n){ names.push(n.name); (n.children||[]).forEach(walk); }); const arr=names.filter(n=> (n||'').toLowerCase().includes(q)).map(n=>({ text:`<${n}>\n\n</${n}>`, displayText:`<${n}>` })); return { list: arr, from: CodeMirror.Pos(cur.line, cur.ch-q.length-1), to: cur } }
          return null;
        }, { completeSingle: false }); }
    }

    // ========== Editor IntelliSense (slash + variables + sections) ==========
    function setupIntelliSense(ps){
      const pop = qs('#suggestPopover');
      const textareas = ['#prompt-textarea','#section-textarea'].map(s=>qs(s));
      let mode = null, items = [], index = 0, anchor = null;
      textareas.forEach(ta => {
        if (!ta) return;
        on(ta, 'keydown', (e)=>{
          if (pop.classList.contains('active')){
            if (e.key==='ArrowDown'){ e.preventDefault(); index=Math.min(items.length-1,index+1); renderPop(); }
            if (e.key==='ArrowUp'){ e.preventDefault(); index=Math.max(0,index-1); renderPop(); }
            if (e.key==='Enter' || e.key==='Tab'){ e.preventDefault(); applyItem(); }
            if (e.key==='Escape'){ hidePop(); }
          }
        });
        on(ta, 'input', ()=> { detect(ta); });
        on(ta, 'blur', ()=> setTimeout(hidePop, 120));
      });
      function detect(ta){
        const v = ta.value; const pos = ta.selectionStart||0; const left = v.slice(0,pos);
        const mSlash = left.match(/\/(\w{0,24})$/); // "/xxx"
        const mVar = left.match(/{{([^}]{0,24})$/);  // "{{xxx"
        const mSec = left.match(/<(\w{0,24})$/);    // "<xxx"
        if (mSlash) { mode='slash'; const q = mSlash[1].toLowerCase();
          const base = [...Object.keys(ps.strategies).map(k=>({label:`Strat√©gie: ${k}`, hint: ps.strategies[k].title, insert: ps.strategies[k].content })),
                        {label:'Composant: JSON', hint:'Format de sortie JSON', insert: ps.templates.components.json},
                        {label:'Composant: Ton & Style', hint:'Style', insert: ps.templates.components.tone},
                        {label:'Template: Contexte', hint:'Section', insert: ps.templates.sections.context}];
          items = base.filter(it => (it.label+it.hint).toLowerCase().includes(q)); index=0; anchor = caretPos(ta); renderPop(); return; }
        if (mVar){ mode='var'; const q = mVar[1].toLowerCase(); const set = new Set();
          // collect variables from preview detection
          qsa('#variable-chips-container .variable-chip[data-variable]').forEach(ch=>set.add(ch.dataset.variable.replace(/[{}/]/g,'')));
          items = [...set].filter(n=>n.toLowerCase().includes(q)).map(n=>({label:`{{${n}}}`, hint:'Variable', insert:`{{${n}}}` })); index=0; anchor = caretPos(ta); renderPop(); return; }
        if (mSec){ mode='sec'; const q = mSec[1].toLowerCase(); const names=[]; walk(ps.state.sections, n=>names.push(n.name));
          items = names.filter(n=> (n||'').toLowerCase().includes(q)).map(n=>({label:`<${n}>`, hint:'Balise section', insert:`<${n}>\n\n</${n}>`})); index=0; anchor = caretPos(ta); renderPop(); return; }
        hidePop();
      }
      function applyItem(){ const ta = document.activeElement; if (!ta || ta.tagName!=='TEXTAREA') return; const it = items[index]; if (!it) return; insertAtCaret(ta, it.insert); hidePop(); ta.dispatchEvent(new Event('input',{bubbles:true})); }
      function renderPop(){ if (!items.length) { hidePop(); return; } const rect = anchor||{x:20,y:20};
        pop.style.left = Math.min(rect.x, window.innerWidth-320) + 'px';
        pop.style.top = Math.min(rect.y+18, window.innerHeight-240) + 'px';
        pop.innerHTML = items.map((it,i)=>`<div class="suggest-item ${i===index?'active':''}" data-i="${i}"><span><strong>${escapeHtml(it.label)}</strong></span><span class="suggest-hint">${escapeHtml(it.hint||'')}</span></div>`).join('');
        pop.classList.add('active');
        qsa('.suggest-item', pop).forEach(div=> on(div, 'mousedown', (e)=>{ e.preventDefault(); index=+div.dataset.i; applyItem(); }));
      }
      function hidePop(){ pop.classList.remove('active'); items=[]; index=0; }
      function caretPos(el){
        const r = el.getBoundingClientRect();
        const lh = 18; // approx line height
        const lines = (el.value.slice(0, el.selectionStart||0).match(/\n/g)||[]).length;
        return { x: r.left + 24, y: r.top + 12 + lines*lh };
      }
      function insertAtCaret(el, text){ const s = el.selectionStart||0, t = el.value; el.value = t.slice(0,s)+text+t.slice(el.selectionEnd||s); el.selectionStart = el.selectionEnd = s + text.length; }
      function escapeHtml(t){ const d=document.createElement('div'); d.textContent=t||''; return d.innerHTML; }
      function walk(nodes, fn){ (nodes||[]).forEach(n=>{ fn(n); if (n.children) walk(n.children, fn); }); }
    }

    // ========== Linter / Analyzer ==========
    function enhanceValidationWithLinter(ps){
      const orig = ps.updateStats.bind(ps);
      ps.updateStats = function(){ orig(); runLinter(); };
      function runLinter(){
        try{
          const list = qs('#validationList'); if (!list) return;
          const prompt = ps.buildFullPrompt();
          const warns = [];
          const ambiguous = /(travailler|am√©liorer|optimiser|rapidement|bient√¥t|plus|meilleur|qualit√©)/ig;
          if (ambiguous.test(prompt)) warns.push({ icon:'fa-triangle-exclamation', text:'Ambigu√Øt√©s d√©tect√©es (adverbes vagues). Pr√©cisez les crit√®res.' });
          const hasFewShot = /(exemple|few-shot|<examples>)/i.test(prompt) || (ps.state.sections||[]).some(s => (s.name||'').toLowerCase()==='examples' && (s.content||'').trim());
          if (!hasFewShot) warns.push({ icon:'fa-lightbulb', text:'Aucun exemple fourni. Ajoutez un few-shot pour stabiliser la qualit√©.', fix:'add_examples' });
          const longUser = (qs('#prompt-textarea')?.value||'').length > 1600;
          if (longUser) warns.push({ icon:'fa-gauge-high', text:'Instruction utilisateur tr√®s longue. Envisagez une section Contexte + objectifs.', fix:'split_context' });
          const ul = document.createElement('ul'); ul.style.listStyle='none'; ul.style.fontSize='.875rem';
          ul.innerHTML = warns.map(w=>`<li><i class="fas ${w.icon}" style="color: var(--warning);"></i> ${escapeHtml(w.text)} ${w.fix?`<button class='btn btn-secondary btn-sm' data-fix='${w.fix}' style='margin-left:.35rem; padding:.2rem .45rem; font-size:.72rem;'>Corriger</button>`:''}</li>`).join('');
          list.appendChild(ul);
          qsa('[data-fix]', ul).forEach(b => on(b,'click',()=>applyFix(b.dataset.fix)));
        }catch(e){}
      }
      function applyFix(kind){
        const sname = kind==='add_examples' ? 'examples' : 'context';
        let sec = (window.promptStudio.state.sections||[]).find(s => (s.name||'').toLowerCase()===sname);
        if (!sec){ window.promptStudio.state.sections.push({ id: window.promptStudio.uid(), name: sname, icon: 'fa-lightbulb', deletable: true, content: '', children: [] }); }
        if (kind==='add_examples'){
          const tpl = window.promptStudio.templates.sections.examples; const ex = tpl || 'Exemple:\nInput: ...\nOutput: ...';
          sec = (window.promptStudio.state.sections||[]).find(s => (s.name||'').toLowerCase()==='examples');
          if (sec && !sec.content) sec.content = ex;
        }
        if (kind==='split_context'){
          const userTa = qs('#prompt-textarea');
          const val = userTa.value; userTa.value = val.slice(0, 800) + '\n\n(‚Ä¶suite dans <context>)';
          let ctx = (window.promptStudio.state.sections||[]).find(s => (s.name||'').toLowerCase()==='context');
          if (ctx) ctx.content = (ctx.content||'') + '\n' + val.slice(800);
          userTa.dispatchEvent(new Event('input', { bubbles:true }));
        }
        window.promptStudio.renderSections(); window.promptStudio.updatePreview(); window.promptStudio.saveToStorage();
      }
      function on(el,ev,fn){ el&&el.addEventListener(ev,fn); }
      function qsa(s,r=document){ return Array.from(r.querySelectorAll(s)); }
      function qs(s,r=document){ return r.querySelector(s); }
      function escapeHtml(t){ const d=document.createElement('div'); d.textContent=t||''; return d.innerHTML; }
    }

    // ========== Branches + Diff ==========
    function setupBranchesAndDiff(ps){
      const hdr = qs('#historyPanel .panel-header'); if (!hdr) return;
      const wrap = document.createElement('div'); wrap.style.display='flex'; wrap.style.gap='.35rem'; wrap.style.alignItems='center';
      wrap.innerHTML = `<select id="branchSelect" class="form-select" style="min-width:160px;"></select>
        <button class="btn btn-secondary" id="newBranch"><i class="fas fa-code-branch"></i> Nouvelle branche</button>`;
      hdr.appendChild(wrap);
      const storageKey = 'ps_branches_v1';
      function loadState(){ try { return JSON.parse(localStorage.getItem(storageKey)||'{}'); } catch { return {}; } }
      function saveState(s){ localStorage.setItem(storageKey, JSON.stringify(s)); }
      const st = loadState(); st.active = st.active || 'main'; st.data = st.data||{}; st.data[st.active] = st.data[st.active] || (ps.state.history||[]);
      saveState(st);
      function refreshBranches(){ const sel = qs('#branchSelect'); sel.innerHTML = Object.keys(st.data).map(b=>`<option ${b===st.active?'selected':''}>${b}</option>`).join(''); }
      refreshBranches();
      on(qs('#newBranch'), 'click', ()=>{ const name = prompt('Nom de la branche:', 'feature'); if (!name) return; if (st.data[name]) return alert('Existe d√©j√†'); st.data[name]=[]; st.active=name; saveState(st); ps.state.history = []; ps.renderHistory(); refreshBranches(); ps.showToast(`Branche cr√©√©e: ${name}`, 'success'); });
      on(qs('#branchSelect'), 'change', (e)=>{ st.active = e.target.value; st.data[st.active] = st.data[st.active]||[]; saveState(st); ps.state.history = st.data[st.active]; ps.renderHistory(); ps.showToast(`Branche active: ${st.active}`, 'info'); });
      // Patch saveVersion to commit into active branch
      const origSave = ps.saveVersion.bind(ps);
      ps.saveVersion = function(){ origSave(); st.data[st.active] = ps.state.history; saveState(st); };
      // Patch renderHistory to inject Diff buttons
      const origRender = ps.renderHistory.bind(ps);
      ps.renderHistory = function(){ origRender(); const cards = qs('#historyCards'); if (!cards) return; qsa('.card', cards).forEach((c, i)=>{
        const v = ps.state.history[i]; if (!v) return; const btn = document.createElement('button'); btn.className='btn btn-secondary btn-icon'; btn.title='Diff'; btn.innerHTML='<i class="fas fa-code-compare"></i>'; btn.addEventListener('click', ()=> openDiff(v.prompt, ps.buildFullPrompt())); c.querySelector('div[style*="flex"]').appendChild(btn);
      }); };
      function openDiff(a, b){ const {A,B}=diffLines(a,b); qs('#diffA').innerHTML = A; qs('#diffB').innerHTML = B; qs('#diffModal').classList.add('active'); }
      function diffLines(a,b){ const al=a.split(/\n/), bl=b.split(/\n/); const max=Math.max(al.length, bl.length); let A='',B=''; for(let i=0;i<max;i++){ const L=al[i]??'', R=bl[i]??''; if (L===R){ A+=escape(L)+'\n'; B+=escape(R)+'\n'; } else { if (L) A+=`<span class="d-rem">${escape(L)}</span>\n`; if (R) B+=`<span class="d-add">${escape(R)}</span>\n`; } } return {A,B}; }
      function escape(t){ const d=document.createElement('div'); d.textContent=t||''; return d.innerHTML; }
    }

    // ========== API Keys ==========
    function setupApiKeys(ps){
      const openBtn = qs('#apiKeysBtn'); const modal = qs('#apiKeysModal'); const saveBtn = qs('#saveApiKeysBtn');
      const KEY='ps_api_keys_v1'; const load=()=>{ try{return JSON.parse(localStorage.getItem(KEY)||'{}');}catch{return{}} };
      const save=(obj)=> localStorage.setItem(KEY, JSON.stringify(obj));
      on(openBtn,'click',()=>{ const s=load(); qs('#keyOpenAI').value=s.openai||''; qs('#keyAnthropic').value=s.anthropic||''; qs('#keyGoogle').value=s.google||''; modal.classList.add('active'); });
      on(saveBtn,'click',()=>{ save({ openai:qs('#keyOpenAI').value||'', anthropic:qs('#keyAnthropic').value||'', google:qs('#keyGoogle').value||'' }); modal.classList.remove('active'); ps.showToast('Cl√©s API enregistr√©es (localement)', 'success'); });
    }

    // ========== Project Tree ==========
    function setupProjectTree(ps){
      const treeEl = qs('#projectTree'); if (!treeEl) return;
      const KEY='ps_project_tree_v1';
      let data = load() || { name:'root', type:'folder', children:[{name:'Prompts', type:'folder', children:[]}] };
      render();
      on(qs('#addFolderBtn'),'click',()=>{ const name=prompt('Nom du dossier:','Nouveau dossier'); if(!name) return; data.children.push({name, type:'folder', children:[]}); save(); render(); });
      on(qs('#addPromptBtn'),'click',()=>{ const name=prompt('Nom du prompt:','Nouveau prompt'); if(!name) return; data.children.push({name, type:'prompt', id: ps.uid()}); save(); render(); });
      function render(){ treeEl.innerHTML = ''; const ul=document.createElement('ul'); ul.style.listStyle='none'; ul.style.paddingLeft='0'; build(data.children, ul, 0); treeEl.appendChild(ul); }
      function build(nodes, parent, level){ nodes.forEach(node=>{ const li=document.createElement('li'); li.style.paddingLeft=`${level*10}px`; li.style.margin='.15rem 0'; li.draggable = true; li.innerHTML = `<span class='badge' style='cursor:grab;'>${node.type==='folder'?'üìÅ':'üìù'}</span> <span class='node-name'>${escapeHtml(node.name)}</span>`; parent.appendChild(li);
          if(node.type==='prompt'){ li.addEventListener('click',()=>{ qsAll('#projectTree li').forEach(x=>x.classList.remove('active')); li.classList.add('active'); ps.showToast(`Prompt s√©lectionn√©: ${node.name}`, 'info'); }); }
          li.addEventListener('dragstart',(e)=>{ e.dataTransfer.setData('text/plain', JSON.stringify({ path: pathTo(node) })); });
          li.addEventListener('dragover',(e)=>{ e.preventDefault(); });
          li.addEventListener('drop',(e)=>{ e.preventDefault(); const src=JSON.parse(e.dataTransfer.getData('text/plain')); if(!src) return; moveByPath(src.path, pathTo(node)); save(); render(); });
          if(node.children && node.children.length){ const ul2=document.createElement('ul'); ul2.style.listStyle='none'; ul2.style.paddingLeft='0'; build(node.children, ul2, level+1); parent.appendChild(ul2); }
          const menuBtn=document.createElement('button'); menuBtn.className='btn btn-secondary btn-icon'; menuBtn.style.marginLeft='.35rem'; menuBtn.title='Options'; menuBtn.innerHTML='<i class="fas fa-ellipsis-h"></i>'; menuBtn.addEventListener('click',()=>{
            const nn=prompt('Renommer (laisser vide pour supprimer):', node.name);
            if(nn===null) return; if(nn===''){ removeByPath(pathTo(node)); } else { node.name=nn; } save(); render();
          }); li.appendChild(menuBtn);
      }); }
      function pathTo(target){ const path=[]; function walk(arr, p){ for(let i=0;i<arr.length;i++){ const n=arr[i]; const np=p.concat(i); if(n===target) return np; if(n.children){ const r=walk(n.children, np.concat('children')); if(r) return r; } } return null; } return walk(data.children, []); }
      function getByPath(p){ let arr=data.children; for(let i=0;i<p.length;i++){ if(p[i]==='children'){ arr=arr[p[++i]]?.children; } } return null; }
      function moveByPath(src, dest){ const node = spliceOut(src); if(!node) return; const destNode = getNodeByPath(dest); if(destNode && destNode.type==='folder'){ destNode.children=destNode.children||[]; destNode.children.push(node); } else { // insert next to dest
          const {parentArr, index} = parentOf(dest); parentArr.splice(index+1,0,node); }
      }
      function spliceOut(p){ const {parentArr, index} = parentOf(p); if(!parentArr) return null; return parentArr.splice(index,1)[0]; }
      function parentOf(p){ let arr=data.children, parentArr=null, index=-1; for(let i=0;i<p.length;i++){ if(p[i]==='children'){ parentArr=arr; index=p[i-1]; arr=arr[index].children; } else { index=p[i]; } } return {parentArr,index}; }
      function getNodeByPath(p){ let arr=data.children, node=null; for(let i=0;i<p.length;i++){ if(p[i]==='children'){ node=arr[p[i-1]]; arr=node.children; } else { node=arr[p[i]]; } } return node; }
      function save(){ localStorage.setItem(KEY, JSON.stringify(data)); }
      function load(){ try { return JSON.parse(localStorage.getItem(KEY)||''); } catch { return null; } }
      function qsAll(s,r=document){ return Array.from(r.querySelectorAll(s)); }
      function escapeHtml(t){ const d=document.createElement('div'); d.textContent=t||''; return d.innerHTML; }
    }

    // ========== Extend Command Palette with content search ==========
    function extendCommandPalette(ps){
      // Add prompts and sections/components into command list
      const extra=[];
      // Library prompts
      (['marketing','python_review','social_posts','translator','sql_gen']).forEach(k=>{ const item=ps.libraryData[k]; if(!item) return; extra.push({id:'load_'+k, label:`Charger: ${item.title}`, icon:'fa-file-import', section:'Biblioth√®que', action:()=>{ const li = document.querySelector(`.prompt-item[data-key="${k}"]`); li && li.click(); }}); });
      // Sections
      (ps.state.sections||[]).forEach(s=> extra.push({ id:'focus_'+s.id, label:`Aller √† la section <${s.name}>`, icon:'fa-arrow-turn-down', section:'Sections', action:()=>{ ps.setActiveSection(s.id); document.getElementById('section-textarea').focus(); }}));
      // Components
      Object.keys(ps.templates.components||{}).forEach(c=> extra.push({ id:'ins_'+c, label:`Ins√©rer composant: ${c}`, icon:'fa-puzzle-piece', section:'Composants', action:()=> ps.insertAtCursor(ps.templates.components[c]) }));
      ps.commands = (ps.commands||[]).concat(extra);
    }

    // ========== Persist Sidebar Sizes ==========
    function persistSidebarSizes(){
      const L=qs('aside.sidebar-left'), R=qs('aside.sidebar-right'); const KEY='ps_sidebar_sizes_v1';
      try{ const s=JSON.parse(localStorage.getItem(KEY)||'{}'); if(s.lw) L.style.width=s.lw; if(s.rw) R.style.width=s.rw; }catch{}
      let down=false; document.addEventListener('mouseup', ()=>{ if(down){ save(); down=false; } }); document.addEventListener('mousedown', ()=>{ down=true; });
      function save(){ const s={ lw: getComputedStyle(L).width, rw: getComputedStyle(R).width }; localStorage.setItem(KEY, JSON.stringify(s)); }
    }

    // ========== Test Manager ==========
    function setupTestManager(ps){
      // Add button in Quick Actions
      const qa = qsa('.settings-group').find(g=>/Actions rapides/i.test(g.textContent||''));
      if (qa){ const btn=document.createElement('button'); btn.className='btn btn-secondary'; btn.style.width='100%'; btn.id='openTestsBtn'; btn.innerHTML='<i class="fas fa-vial"></i> Gestionnaire de cas de test'; qa.querySelector('div[style*="flex"]').appendChild(btn); on(btn,'click',()=>qs('#testsModal').classList.add('active')); }
      const stateKey = 'ps_test_suites_v1';
      const state = load(); state.active = state.active||null; save();
      function load(){ try { return JSON.parse(localStorage.getItem(stateKey)||'{}'); } catch { return {}; } }
      function save(){ localStorage.setItem(stateKey, JSON.stringify(state)); }
      function refreshSelect(){ const sel=qs('#tsSelect'); const names=Object.keys(state.suites||{}); sel.innerHTML = names.map(n=>`<option ${state.active===n?'selected':''}>${n}</option>`).join(''); }
      state.suites = state.suites||{}; refreshSelect();
      on(qs('#tsCreate'),'click',()=>{ const n=qs('#tsName').value.trim(); if(!n) return; if(state.suites[n]) return alert('Existe d√©j√†'); state.suites[n]=[]; state.active=n; save(); refreshSelect(); renderRows(); });
      on(qs('#tsSelect'),'change',(e)=>{ state.active=e.target.value; save(); renderRows(); });
      on(qs('#tsAddRow'),'click',()=>{ const row = {}; // create empty row with known vars
        qsa('#variable-inputs-container input').forEach(i=> row[i.dataset.variableName]=i.value||''); addRow(row); });
      on(qs('#tsImportCSV'),'click',()=>{ const input=document.createElement('input'); input.type='file'; input.accept='.csv'; input.onchange = async (e)=>{ const f=e.target.files?.[0]; if(!f) return; const text = await f.text(); const { headers, rows } = ps.parseCSV(text); rows.forEach(r=>addRow(r)); }; input.click(); });
      let rule='none', kw=''; on(qs('#tsRuleBtn'),'click', (e)=> e.currentTarget.parentElement.classList.toggle('active'));
      on(qs('#tsRuleMenu'),'click', (e)=>{ const it=e.target.closest('.dropdown-item'); if(!it) return; rule=it.dataset.rule; if(rule==='keyword'){ kw=prompt('Mot-cl√© √† v√©rifier:',''); } e.currentTarget.parentElement.classList.remove('active'); });
      on(qs('#tsRun'),'click',()=>{ runSuite(); });

      function addRow(obj){ if(!state.active){ alert('Cr√©ez une suite d\'abord'); return; } state.suites[state.active].push(obj); save(); renderRows(); }
      function renderRows(){ const rows=state.suites[state.active]||[]; const cont=qs('#tsRows'); cont.innerHTML=''; rows.forEach((r,idx)=>{ const div=document.createElement('div'); div.className='panel'; div.style.padding='.5rem'; div.style.margin='.35rem 0';
          const keys = Object.keys(r);
          div.innerHTML = `<div style="display:flex; gap:.5rem; flex-wrap:wrap; align-items:center;">
              ${keys.map(k=>`<div style='min-width:180px;'><div class='form-label'>${escape(k)}</div><input class='form-input' data-k='${escape(k)}' value='${escape(r[k])}'/></div>`).join('')}
              <button class='btn btn-danger btn-icon' data-del='${idx}' title='Supprimer'><i class='fas fa-trash'></i></button>
            </div>`;
          cont.appendChild(div);
          qsa('input[data-k]',div).forEach(inp=> on(inp,'input',()=>{ r[inp.dataset.k]=inp.value; save(); }));
          on(div.querySelector('[data-del]'),'click',()=>{ rows.splice(idx,1); save(); renderRows(); });
      }); refreshSelect(); }
      function runSuite(){ const rows=state.suites[state.active]||[]; if(!rows.length) return;
        const cacheKey = 'ps_tests_cache_v1'; let cache=loadCache(); let ok=0; const lines=[]; const models = ['GPT-4','Claude 3.5','Gemini 1.5'].filter((m,i)=> true);
        rows.forEach((row,i)=>{ const snap={...ps.state.variableValues}; Object.keys(row).forEach(k=> ps.state.variableValues[k]=row[k]); const prompt=ps.buildFullPrompt();
          models.forEach(model=>{ const key = model+'|'+prompt+'|'+JSON.stringify(row); let out = cache[key]; if(!out){ out = ps.simulateLLMResponse(prompt)+`\n\n(Model=${model})`; cache[key]=out; } let pass=true; if (rule==='json') { try { JSON.parse((out.match(/{[\s\S]*}/)||['{}'])[0]); pass=true; } catch{ pass=false; } } if (rule==='keyword') pass = kw? out.toLowerCase().includes(kw.toLowerCase()):true; if (pass) ok++; lines.push(`[${i+1}] ${pass?'OK':'KO'} | ${model} | len=${out.length}`); });
          ps.state.variableValues=snap; });
        saveCache(cache); updateCacheCount();
        const pct = rows.length? Math.round(ok/(rows.length*models.length)*100):0;
        qs('#tsReport').innerHTML = `<div class='panel' style='padding:.6rem;'><strong>${ok}/${rows.length*models.length}</strong> r√©ussites (${pct}%)<pre class='result-box' style='margin-top:.4rem;'>${escape(lines.join('\n'))}</pre></div>`;
      }
      function loadCache(){ try{ return JSON.parse(localStorage.getItem('ps_tests_cache_v1')||'{}'); }catch{return{}} }
      function saveCache(c){ localStorage.setItem('ps_tests_cache_v1', JSON.stringify(c)); }
      function updateCacheCount(){ const c = Object.keys(loadCache()).length; const el = document.getElementById('cacheCount'); if (el) el.textContent = c; }
      updateCacheCount();
      const btnClear = document.getElementById('clearCacheBtn'); btnClear && btnClear.addEventListener('click',()=>{ localStorage.removeItem('ps_tests_cache_v1'); updateCacheCount(); ps.showToast('Cache vid√©','success'); });
      function escape(t){ const d=document.createElement('div'); d.textContent=t||''; return d.innerHTML; }
    }

    function addQuickActionButtons(ps){
      // Nothing else for now; tests button is added in setupTestManager
    }
  })();
  </script>
</body>
</html>
